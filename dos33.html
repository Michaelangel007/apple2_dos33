<!DOCTYPE html>
<!--
                        25          37              53                              85
####:## ## ##       ### LABEL       NMEMONIC        COMMENT                         ; Annotation
                    001 
                    002 
                    003 
                    004 
                    005 
                    006 
                    007 
                    008 
                    009 
                    010 
                    011 
                    012 
                    013 
                    014 
                    015 
                    016 
                    017 
                    018 
                    019 
                    020 
                    021 
                    022 
                    023 
                    024 
                    025 
                    026 
                    027 
                    028 
                    029 
                    030 
                    031 
                    032 
                    033 
                    034 
                    035 
                    036 
                    037 
                    038 
                    039 
                    040 
                    041 
                    042 
                    043 
                    044 
                    045 
                    046 
                    047 
                    048 
                    049 
                    050 
                    051 
                    052 
                    053 
                    054 
                    055 
                    056 
                    057 
                    058 
                    059 
                    060 
                    061 
                    062 
                    063 
                    064 
                    065 
                    066 
                    067 
                    068 
                    069 
                    070 
                    071 
                    072 
                    073 
                    074 
                    075 
                    076 
                    077 
                    078 
                    079 

                    080 
                    081 
                    082 
                    083 
                    084 
                    085 
                    086 
                    087 
                    088 
                    089 

                    090 
                    091 
                    092 
                    093 
                    094 
                    095 
                    096 
                    097 
                    098 
                    099 

                    100 
                    101 
                    102 
                    103 
                    104 
                    105 
                    106 
                    107 
                    108 
                    109 

                    100 
                    101 
                    102 
                    103 
                    104 
                    105 
                    106 
                    107 
                    108 
                    109 

                    110 
                    111 
                    112 
                    113 
                    114 
                    115 
                    116 
                    117 
                    118 
                    119 
-->
<html>
<title>Apple DOS 3.3C Source Code (HTML Version)</title>
<head>
    <style>

span.b { color: #080; font-weight: bold;  } /* Original bold   green */
span.i { color: #00F; font-style: italic; } /* Original italic blue  */

/* Bold = Func (Blue) */
b {
    color: #00F; /* old: 080 */
}
/* Italic = Data (Green) */
i {
    color: #080; /* 00F */
}

h1 {
    font-size: 200%;
}
/* Memory Address */
b.adr {
    color: #F80;
}
b.file {
    color: #F00;
}
/* Track/Sector */
b.ts {
    color: #F00;
}


/*
# after an hr there is a line of whitespace
    <div class="hr"><hr></div>
Solution: place <hr> on same line
*/
hr {
/*
#    padding: 0px;
#    margin:  0px;
#    margin-top:-1em
*/
}
#page {
    color: #080;
}
span.macro {
    background-color:#EEE;
}
span.patch {
    background-color:#EEC;
}
span.todo {
    background-color:#FF0;
}
    </style>
</head>
<body>

<h1>Apple DOS 3.3C Source Code (HTML Version)</h1>
<br>Transcribed by Michael Pohoreski.
<br>Latest version on my GitHub: <a href="http://htmlpreview.github.com/?https://github.com/Michaelangel007/apple2_dos33/blob/master/dos33.html">dos33.html</a>
<p>
The <span class="i">intent</span> of providing this copyrighted source code is
 as a convenience for the curious as a <span class="b">means to learn</span> --
 such as, how <span class="b">not to design a Operating / Disk / File System</span>
 (look for all my <span class="b">*sigh*</span> comments), but as they say,
 <span class="i">"Hindsight is 20/20."</span>
<p>
<span class="b">DISCLAIMER:</span> <span class="i">YOU MAY NOT USE THIS FOR
 COMMERCIAL GAIN else you face risking the wrath of Apple's lawyers.</span>
 Since Apple <span class="i">has already previously released this source code</span>
 I'm assuming it is OK since I'm not presenting anything new
 (well, OK, my commentary, but you get the point.)
<p>
Numerous improvements have been made over the original source code listings:
<p>
<ul>
  <li>Hyperlinks to all labels,                                       </li>
  <li>Load address and opcodes,                                       </li>
  <li>Added line numbers,                                             </li>
  <li>Cleaned up sloppy vertical alignment (such as (#) clock cycles),</li>
  <li>Added annotation column,                                        </li>
  <li>Unindented and color-coded macro sections so they stand out, and</li>
  <li>Single page                                                     </li>
</ul>
<p>

Header Format is:

<pre>
; === <b class="file">FILENAME</b> - Description, Page <span id="page">#</span>, <b class="ts">Track/Sector</b> @ $offset, $<b class="adr">####</b> (Relocated Address in high memory) ===
</pre>

Line format is:

<pre>
Addr:## ## ##       L## LABEL       MNEMONIC        COMMENT                         Annotation
</pre>

<b>Legend:</b>
<p>
<div style="padding-left:5%">
<table border="1" style="border-width: 1px; border-collapse: collapse" >
    <tr>
        <td>Addr</td>
        <td>Address at assemble time</td>
    </tr>
    <tr>
        <td>## ## ##</td>
        <td>Opcode(s)</td>
    </tr>
    <tr>
        <td>L##</td>
        <td>Line number of source file</td>
    </tr>
    <tr>
        <td>LABEL</td>
        <td>Function name, or branch target name<br><b>Function</b><br><i>Data</i></td>
    </tr>
    <tr>
        <td>MNEMONIC</td>
        <td>Assembly language instruction</td>
    </tr>
    <tr>
        <td>COMMENT</td>
        <td>Official comment</td>
    </tr>
    <tr>
        <td>Annotation</td>
        <td>Modern commentary by me</td>
    </tr>
</table>
</div>


<pre>

; === <b class="file">DOS33C</b> - Master Source File, Page <span id="page">39</span> ===

                    001             SBTL "DOS3.3C w/APPEND fix, U/L case"
                    002             LST  ON,VSYM
                    003             MSB  OFF
                    004 ORIGIN      EQU  $1B00
                    005 DIAGMOD     EQU  0
                    006 DOS33B      EQU  1
                    007 ULC         EQU  0
                    008             INCLUDE <a href="#RELOCTR">RELOCTR</a>,,2                              ; $1B00 .. $####
                    009             INCLUDE <a href="#DOSINIT">DOSINIT</a>,,2                              ; $#### .. $####
                    010             INCLUDE <a href="#DOSHOOK">DOSHOOK</a>,,2                              ; $#### .. $####
                    011             INCLUDE <a href="#CMDSCAN">CMDSCAN</a>,,2                              ; $#### .. $####
                    012             INCLUDE <a href="#XOPNCLS">XOPNCLS</a>,,2                              ; $#### .. $####
                    013             INCLUDE <a href="#XLODSAV">XLODSAV</a>,,2                              ; $#### .. $####
                    014             INCLUDE <a href="#XMISCMD">XMISCMD</a>,,2
                    015             INCLUDE <a href="#DOSGOER">DOSGOER</a>,,2
                    016             INCLUDE <a href="#BLDFTAB">BLDFTAB</a>,,2                              ; Page   4, Lines 144, $#### .. $####
                    017             INCLUDE <a href="#CMDTBLS">CMDTBLS</a>,,2
                    018             INCLUDE <a href="#FDOSENT">FDOSENT</a>,,2
                    019             INCLUDE <a href="#FOPCLRW">FOPCLRW</a>,,2
                    020             INCLUDE <a href="#FDELCAT">FDELCAT</a>,,2
                    021             INCLUDE <a href="#FMTRWIO">FMTRWIO</a>,,2
                    022             INCLUDE <a href="#FLOCNXB">FLOCNXB</a>,,2
                    023             INCLUDE <a href="#FLOCSEC">FLOCSEC</a>,,2
                    024             INCLUDE FVCBUFS,,2
                    025             INLUCDE BOOTLDR,,2                              ; $3600 .. $36FF
                    026             INCLUDE COREQUS,,1
                    027             INCLUDE PRENIBL,,1
                    028             INCLUDE <a href="#WRITRTN">WRITRTN</a>,,1
                    029             INCLUDE <a href="#POSTNRD">POSTNRD</a>,,1
                    030             INCLDUE RDADSEK,,1
                    031             INCLUDE <a href="#MSWAITR">MSWAITR</a>,,1                              ; $3A00 .. $3Cxx, T0$4 - T0$6
                    032             INCLUDE WRITADR,,1
                    033             INCLUDE RWTSONE,,1
                    034             INCLUDE <a href="#RWTSTWO">RWTSTWO</a>,,1
                    035             INCLUDE <a href="#FORMATR">FORMATR</a>,,1
                    036             INCLUDE DOSPTCH,,1

<hr>; === <b class="file"><a name="RELOCTR">RELOCTR</a></b> - Relocate DOS to high (48K) memory, Page <span id="page">110</span>, <b class="ts">T0$A</b>, $<b>1B00</b> ===<hr>
                    001             PAGE
                    002 *****************************************************
                    003 *                                                   *
                    004 * (C) COPYRIGHT 1978,1980,1982 APPLE COMPUTER, INC. *
                    005 *                                                   *
                    006 *****************************************************
                    007             SKP 2
                    008 *********************************
                    009 *                               *
                    010 *  ADAPTED FOR MACRO EDASM BY   *
                    011 *        JOHN ARKLEY            *
                    012 *         DEC 1980              *
                    013 *                               *
                    014 *********************************
                    015             SKP 2
                    016 *********************************
                    017 *                               *
                    018 *  DOS 3.3 REVISION B PATCHES   *
                    019 *   INSTALLED BY MARK HOUDE     *
                    020 *          JUL 1982             *
                    021 *                               *
                    022 *********************************
                    023             SKP 2
                    024 *********************************
                    025 *                               *
                    026 *  DOS 3.3 REV B PATCHES VER 2  *
                    027 *   INSTALLED BY FERN BACHMAN   *
                    028 *          SEP 1982             *
                    029 *                               *
                    030 *********************************
                    031             SKP 2
                    032 *********************************
                    033 *                               *
                    034 *    DOS33C PATCHES (APPEND &amp;   *
                    035 *     UPPER/LOWER CASE CHECK)   *
                    036 *                               *
                    037 *            BY                 *
                    038 *        GUIL  BANKS            *
                    039 *         1983                  *
                    040 *                               *
                    041 *********************************
                    042 ;
                    043 ;EQUATES REQD TO FIND THINGS IN APPLE II
                    044 ;
                    045 SETVID      EQU $FE93
                    046 SETKBD      EQU $FE89
                    047 PROMPT      EQU $33         ; PROMPT CHAR
                    048 OUTSW       EQU $36         ; OUTPUT VECTOR SWITCH
                    049 INSW        EQU $38         ; INPUT VECTOR SWITCH
                    050 ZPGWRK      EQU $40         ; ZERO PAGE WORK CELL
                    051 CNUM        EQU $44         ; CONVERTED NUMERIC
                    052 LBUFF       EQU $200        ; LINE BUFFER                   ; Keyboard buffer of 255 chars
                    053 MULT        EQU $FB63       ; MULT ROUTINE
<hr>                    054 INPRT       EQU $FE8B       ; SET IN PORT                   ; === Page <span id="page">111</span> ===
                    055 OUTPRT      EQU $FE95       ; SET OUT PORT
                    056 IBCHN       EQU $E836       ; BASIC RUN                     ; Integer Basic
                    057 IBLMEM      EQU $4A         ; BASIC LOW MEM                 ; Integer Basic
                    058 IBHMEM      EQU $4C         ; INTEGER BASIC HIMEM           ; Integer Basic
                    059 IBSOP       EQU $CA         ; INTEGER BASIC START OF CGM    ; Integer Basic CGM ???
                    060 IBBRK       EQU $E3E3       ; BASIC BREAK                   ; Integer Basic
                    061 IBGO        EQU $E000       ; BASIC ENTRY POINT             ; Integer Basic
                    062 IBCONT      EQU $E003       ; BASIC CONTINUE ENTRY POINT    ; Integer Basic
                    063 IBSOV       EQU $CC         ; BASIC START OF VARIABLES      ; Integer Basic
                    064 ASSOP       EQU $67         ; AS START OF PROGRAM           ; Applesoft Basic
                    065 ASEOP       EQU $AF         ; AS END OF PROGRAM             ; Applesoft Basic
                    066 ASEOP2      EQU $69         ; AS END-OF PGM 2               ; Applesoft Basic
                    067 ASHM1       EQU $73         ; AS HIGH MEM 1                 ; Applesoft Basic
                    068 ASHM2       EQU $6F         ; AS HIGH MEM 2                 ; Applesoft Basic
                    069 ASRNX       EQU $D6         ; AS RUN-ONLY FLAG              ; Applesoft Basic
                    070 ASONERR     EQU $D8         ; AS ON-ERR GOTO FLAG           ; Applesoft Basic
                    071 ASLMEM      EQU ASSOP       ; AS LOW MEM                    ; Applesoft Basic
                    072 ASBRK1      EQU $D865       ; AS ROM BREAK                  ; Applesoft Basic
                    073 ASBRK2      EQU $1067       ; AS RAM BREAK                  ; Applesoft Basic
                    074 ASCNTU1     EQU $D43C
                    075 ASCNTU2     EQU $C3C
                    076 ASRSEQ1     EQU $D4F2
                    077 ASRSEQ2     EQU $CF2
                    078 AITSTL      EQU $E000       ; AS 1 IB TEST LOC              ; Applesoft Basic
                    079 ATSTV       EQU $4C         ; AS TEST VALUE                 ; Applesoft Basic
                    080 ITSTV       EQU $20         ; IB TEST VALUE                 ; Integer Basic
                    081 BOOTSL      EQU $2E         ; BOOT FROM SLOT                ; Slot from Boot
                    082 ZPGFCB      EQU $42         ; ZERO PAGE WORK CELL           ; File Control Block
                    083 MONRST      EQU $FF65       ; MONITOR RESET ENTRY
                    084 MONBRK      EQU $FA59       ; MONITOR BREAK ENTRY
                    085 IORTS       EQU $FF58       ; KNOWN RTS IN MONITOR ROM
                    086 HOME        EQU $FC58                                       ; Clear the text screen
                    087 PRINT       EQU $FDED                                       ; putchar()
                    088 GETKEY      EQU $FD0C
                    089 INSDS2      EQU $F88E
                    090 LENGTH      EQU $2F
                    091 ZRSET       EQU $3F2        ; NEW MONITOR ROM RESET VECTOR
                    092 PWCNST      EQU $3F4        ; NEW MONITOR ROM POWER UP CONSTANT
                    093                 REP 40
                    094 *
                    095 *
                    096             ORG ORIGIN
                    097 *
                    098 *
                    099             REP 40
                    100             PAGE
1B00:4C 84 1D       101 <b><a name="BEGIN"      id="BEGIN"      >BEGIN       </a></b>JMP <a href="#DBINIT">DBINIT</a>                                      ; === Run-Time Mem = $1B00 ===
                    102 ;                                                           ; Loaded in at $38D4
                    103 <b><a name="DOSREL"     id="DOSREL"     >DOSREL      </a></b>EQU *                                           ; Called from BOOTLDR, page 12, line # TODO:
                    104 ;
                    105 ; GET RELOCATION PARMS
                    106 ;
                    107 DR0         EQU *
                    108 LOC1        EQU $26
1B03:A9 BF          109             LDA #$BF        ; START AT BF00                 ; Top of 48K
1B05:85 41          110             STA ZPGWRK+1    ; TO LOOK FOR                   ; ZPGWRK = MemTestAdr
1B07:A2 00          111             LDX #0          ; HIGH RAM
1B09:86 40          112             STX ZPGWRK
1B0B:A0 00          113 <b><a name="DR0A"       id="DR0A"       >DR0A        </a></b>LDY #0          ; APPLE TEST
                    114 DR1B        EQU *                                           ; unused label
1B0D:A1 40          115             LDA (ZPGWRK,X)
1B0F:85 26          116             STA LOC1                                        ; LOC1 = MemTestVal
<hr>1B11:98             117 <b><a name="DR1"        id="DR1"        >DR1         </a></b>TYA                                             ; === Page <span id="page">112</span> ===
1B12:45 26          118             EOR LOC1
1B14:85 26          119             STA LOC1
1B16:98             120             TYA
1B17:41 40          121             EOR (ZPGWRK,X)
1B19:81 40          122             STA (ZPGWRK,X)
1B1B:C5 26          123             CMP LOC1
1B1D:D0 05          124             BNE <a href="#DR1A" >DR1A</a>                                        ; v
1B1F:C8             125             INY
1B20:D0 EF          126             BNE <a href="#DR1"  >DR1</a>                                         ; ^
1B22:F0 04          127             BEQ <a href="#DR2"  >DR2</a>         ; BR IF TOOK                    ; v
                    128 <b><a name="DR1A"       id="DR1A"       >DR1A        </a></b>EQU *
1B24:C6 41          129             DEC ZPGWRK+1    ; NOT RAM
1B26:D0 E3          130             BNE <a href="#DR0A" >DR0A</a>        ; TRY NEXT PAGE                 ; ^
                    131 ;
                    132 <b><a name="DR2"        id="DR2"        >DR2         </a></b>EQU *
                    133 ;
1B28:A5 41          134             LDA ZPGWRK+1    ;BEGIN PATCH TO INSURE   *****  ; note: '*****' is BEGIN_PATCH
1B2A:29 DF          135             AND #$DF        ; PROPER HIGH MEMORY CHECK.
1B2C:85 43          136             STA ZPGFCB+1    ;(DOS MASTER 3.1 CONTAINS
1B2E:86 42          137             STX ZPGFCB      ; THIS ROUTINE STARTING AT LOCATION
1B30:A1 42          138             LDA (ZPGFCB,X)  ; $3540)
1B32:48             139             PHA
1B33:85 26          140             STA LOC1        ;SAVE TEST VALUE
1B35:98             141 <b><a name="DR2A"       id="DR2A"       >DR2A        </a></b>TYA             ;(FIRST TIME Y=0)
1B36:45 26          142             EOR LOC1        ;TEST EACH (ALLEDGED) MEMORY BYTE
1B38:85 26          143             STA LOC1        ; 256 TIMES TO DETERMINE IF
1B3A:98             144             TYA             ; IT IS REALLY GOOD MEMORY AND
1B3B:41 40          145             EOR (ZPGWRK,X)  ; MIRRORED 8K LOWER IN RAM.
1B3D:81 42          146             STA (ZPGFCB,X)
1B3F:C5 26          147             CMP LOC1        ;DID IT PASS THIS TIME?
1B41:D0 09          148             BNE <a href="#DR2B">DR2B</a>        ; BYTE NOT MIRRORED, THEN GOOD MEMORY   ; *sigh* more crap code: S-L-O-W
1B43:C8             149             INY             ;MAYBE IT WAS COINCIDENCE               ; Instead of testing *every* byte (256 times WTF!)
1B44:D0 EF          150             BNE <a href="#DR2A">DR2A</a>        ; BRANCH UNLESS IT'S MATCHED 256 TIMES  ; just test the last byte of every page
1B46:A4 43          151             LDY ZPGFCB+1    ;HIMEM IS 8K LOWER THEN WAS
1B48:68             152             PLA             ;ORIGINALLY THOUGHT!            ; Another wasted byte with JMP
1B49:4C 51 1B       153             JMP <a href="#DR2C">DR2C</a>                                        ; Switch LDY PLA around and BNE instead
1B4C:68             154 <b><a name="DR2B"       id="DR2B"       >DR2B        </a></b>PLA        ; ORIGINAL HIMEM PROVED GOOD
1B4D:81 42          155             STA (ZPGFCB,X)  ;RESTORE BYTE ORIGINALLY MESSED WITH.
1B4F:A4 41          156             LDY ZPGWRK+1    ;END OF PATCH   *****           ; ***** = END_PATCH
1B51:C8             157 <b><a name="DR2C"       id="DR2C"       >DR2C        </a></b>INY             ; NEW END OF DOS
1B52:8C 7D 1C       158             STY NEPAGE
1B55:38             159             SEC
1B56:98             160             TYA
1B57:ED 7E 1C       161             SBC DOSLNG      ; MINUS DOS LENGTH
1B5A:8D 7C 1C       162             STA NSPAGE      ; IS NEW START OF DOS
1B5D:38             163             SEC
1B5E:ED 7A 1C       164             SBC <a href="#RSPAGE">RSPAGE</a>      ; MINUS OLD DOS START
1B61:F0 9D          165             BEQ <a href="#BEGIN">BEGIN</a>       ; (BREIF NO DELTA)              ; ^ NOT mis-spelling: Branch If
1B63:8D 7F 1C       166             STA DELTA       ; IS DELTA
1B66:AD 7A 1C       167             LDA <a href="#RSPAGE">RSPAGE</a>      ; RESET START PAGE TO NORMAL
1B69:8D 0D 1D       168             STA ASTART+1
                    169 ;
1B6C:A9 1D          170             LDA #&lt;DBINIT    ; RESET PI RTN TO NORMAL        ; PI = ??? TODO:
1B6E:8D 49 37       171             STA DI3+2
1B71:A9 84          172             LDA #&gt;DBINIT
1B73:8D 48 37       173             STA DI3+1
                    174 ;
                    175 ;RELOCATE ADR TABLES
                    176 ;
<hr>1B76:A2 00          177             LDX #0                                          ; === Page <span id="page">113</span> ===
1B78:86 40          178             STX ZPGWRK
                179 <b><a name="DR3"        id="DR3"        >DR3         </a></b>EQU *

                186 <b><a name="DR4"        id="DR4"        >DR4         </a></b>EQU *

                194 <b><a name="DR5"        id="DR5"        >DR5         </a></b>INY

                198 <b><a name="DR6"        id="DR6"        >DR6         </a></b>EQU *

                213 ;
                214 ;RELOCATE CODE
                215 ;
1BAF:A2 00          216             LDX #0
1BB1:8E 9C 33       217 <b><a name="DR7"        id="DR7"        >DR7         </a></b>STX TEMP1
                218 ;
1BB4:BD 5A 1C       219             LDA CDETAB+1,X  ; GET A START OF CODE ADR
1BB7:85 40          220             STA ZPGWRK      ; PUT IN ZPG
1BB9:BD 5B 1C       221             LDA CDETAB+2,X
1BBC:85 41          222             STA ZPGWRK+1
                223 ;
1BBE:A2 00          224 <b><a name="DR8"        id="DR8"        >DR8         </a></b>LDX #0         ; GET OP CODE
1BC0:A1 40          225             LDA (ZPGWRK,X)  ; GO FIND OUT HOW LONG          ; Interesting hack of using
1BC2:20 8E F8       226             JSR INSDS2                                      ; monitor ROW to get instruction opcode length
                227 ;
1BC5:A4 2F          228             LDY LENGTH      ; GET HOW LONG
1BC7:C0 02          229             CPY #2          ; IF IT AIN'T                   ; *sigh* 3-1 since zero based
1BC9:D0 11          230             BNE <a href="#DR9">DR9</a>         ; 3 THEN DON'T RELOC            ; 300:A9 20 20 8E F8 A5 2F 09 30 4C ED FD
1BCB:B1 40          231             LDA (ZPGWRK),Y  ; GET PAGE FROM INST
1BCD:CD 7A 1C       232             CMP RSPAGE      ; IF PAGE &lt; REL START
1BD0:90 0A          233             BCC <a href="#DR9">DR9</a>         ; THEN  IGNOR
1BD2:CD 7B 1C       234             CMP REPAGE      ; IF PAGE &gt;= REL END
1BD5:B0 05          235             BCS <a href="#DR9">DR9</a>         ; THEN IGNORE
1BD7:6D 7F 1C       236             ADC DELTA       ; ELSE ADD DELTA
1BDA:91 40          237             STA (ZPGWRK),Y  ; TO RELOCATE
                238 ;
1BDC:38             239 <b><a name="DR9"        id="DR9"        >DR9         </a></b>SEC
<hr>1BDD:A5 2F          240             LDA <a href="#LENGTH">LENGTH</a>      ; ADD LENGTH
1BDF:65 40          241             ADC ZPGWRK      ; TO PC
1BE1:95 40          242             STA ZPGWRK
1BE3:A9 00          243             LDA #0
1BE5:65 41          244             ADC ZPGWRK+1
1BE7:85 41          245             STA ZPGWRK+1
                    246 ;
1BE9:AE 9C 33       247             LDX TEMP1       ; CHECK FOR END
1BEC:DD 5D 1C       248             CMP CDETAB+4,X  ; OF CODE SEGMENT
1BEF:90 CD          249             BCC <a href="#DR8">DR8</a>         ; BR NOT END
1BF1:A5 40          250             LDA ZPGWRK
1BF3:DD 5C 1C       251             CMP CDETAB+3,X
1BF6:90 C6          252             BCC <a href="#DR8">DR8</a>         ; BR NOT END
                    253 ;
1BF8:8A             254             TXA
1BF9:18             255             CLC
1BFA:69 04          256             ADC #04         ; INCREMENT TABLE INDEX
1BFC:AA             257             TAX
1BFD:EC 59 1C       258             CPX CDETAB      ; DONE
1C00:90 AF          259             BCC <a href="#DR7">DR7</a>         ; BR IF NOT                     ; === <b class="ts">T0$B</b> ===
                    260 ;
                    261             PAGE
                    262 ;
                    263 ;MOVE TO RELOCATED CODE
                    264 ;
1C02:A9 3F          265             LDA #&lt;<a href="#ENDOFDOS">ENDOFDOS</a>-$80
1C04:85 41          266             STA ZPGWRK+1    ; ZPGWRK=FROM
1C06:AC 7D 1C       267             LDY <a href="#NEPAGE">NEPAGE</a>
1C09:88             268             DEY
1C0A:84 43          269             STY ZPGFCB+1    ; ZPGFCB = TOO
1C0C:A9 00          270             LDA #0
1C0E:85 40          271             STA ZPGWRK
1C10:85 42          272             STA ZPGFCB
1C12:A8             273             TAY
                    274 ;
1C13:B1 40          275 <b><a name="DR10"       id="DR10"       >DR10        </a></b>LDA (ZPGWRK),Y  ; BYTE FROM
1C15:91 42          276             STA (ZPGFCB),Y  ; BYTE  TO
1C17:C8             277             INY             ; INCREMENT                     ; /sarcasm No shit, Sherlock
1C18:D0 F9          278             BNE <a href="#DR10">DR10</a>        ; BR NOT FULL PAGE
1C1A:CE 80 1C       279             DEC DPGCNT      ; DECREMENT PAGE CNT
1C1D:F0 06          280             BEQ <a href="#DR11">DR11</a>        ; BR IF DONE
1C1F:C6 41          281             DEC ZPGWRK+1    ; INC FROM PAGE
1C21:C6 43          282             DEC ZPGFCB+1    ; INC TOO PAGE
1C23:D0 EE          283             BNE <a href="#DR10">DR10</a>        ; MOVE PAGE
                    284 ;
1C25:4C 54 1E       285 <b><a name="DR11"       id="DR11"       >DR11        </a></b>JMP <a href="#DBVECT">DBVECT+3</a>    ; DONE                          ; DOSINIT, Page 51 -&gt; JMP DBINIT
                    286             PAGE
1C28:24             287 <b><a name="ADRTAB"     id="ADRTAB"     >ADRTAB      </a></b>DFB 9*4
1C29:00 1D          288             DW  SAT1
1C2B:56 1D          289             DW  EAT1
1C2D:58 1D          290             DW  RUN
1C2F:5A 1D          291             DW  RUN+2
1C31:64 1D          292             DW  IBVT+2
1C33:66 1D          293             DW  IBVT+4
1C35:6C 1D          294             DW  AS1VT
1C37:70 1D          295             DW  AS1VT+4
1C39:78 1D          296             DW  AS2VT
1C3B:7C 1D          297             DW  AS2VT+4
1C3D:7E 1D          298             DW  AS2VT+6
1C3F:80 1D          299             DW  AS2VT+8
1C41:C1 2A          300             DW  SAT2
1C43:FD 2A          301             DW  EAT2
1C45:E4 37          302             DW  BAIOB
<hr>1C47:E8 37          303             DW  ADOSLD+2                                    ; === Page <span id="page">115</span> ===
1C49:EE 37          304             DW  IBDCTP
1C4B:F0 37          305             DW  IBDCTP+2                                    ; File, Page TODO
1C4D:00 00 00 00    306             DFB 0,0,0,0
1C51:00 00 00 00    307             DFB 0,0,0,0
1C55:00 00 00 00    308             DFB 0,0,0,0
                    309 <b><a name="CDETAB"     id="CDETAB"     >CDETAB      </a></b>EQU *
1C59:20             310             DFB 8*4
1C5A:84 1D          311             DW  SC1
1C5C:84 28          312             DW  EC1
1C5E:FD 2A          313             DW  SC2
1C60:97 33          314             DW  EC2
1C62:5D 36          315             DW  SC3
1C64:E0 37          316             DW  EC3
1C66:56 3C          317             DW  SWADR1
1C68:DF 3C          318             DW  EWADR1
1C6A:00 38          319             DW  ASC1
1C6C:11 3A          320             DW  AEC1
1C6E:69 3A          321             DW  PSC1
1C70:94 3A          322             DW  <a href="#PEC1">PEC1</a>
1C72:00 3D          323             DW  ASC2
1C74:A8 3F          324             DW  AEC2
1C76:C8 3F          325             DW  SDP1
1C78:FF 3F          326             DW  EDP1                                        ; End Program
1C7A:1D             327 <i><a name="RSPAGE"     id="RSPAGE"     >RSPAGE      </a></i>DFB &lt;START                                      ; (Source) Relocation Start Page $1D00
1C7B:40             328 <i><a name="REPAGE"     id="REPAGE"     >REPAGE      </a></i>DFB &lt;ENDOFDOS                                   ; (Source) Relocation End+1 Page $4000
                    329 ;
1C7C:00             330 <i><a name="NSPAGE"     id="NSPAGE"     >NSPAGE      </a></i>DFB 0
1C7D:00             331 <i><a name="NEPAGE"     id="NEPAGE"     >NEPAGE      </a></i>DFB 0
                    332 ;
1C7E:23             333 DOSLNG      DFB &lt;ENDOFDOS-START
                    334 ;
1C7F:00             335 DELTA       DFB 0
1C80:23             336 DPGCNT      DFB &lt;ENDOFDOS-START
                    337             PAGE

<hr>; === <b class="file"><a name="DOSINIT">DOSINIT</a></b> - Command Tables and Interpreter, Page <span id="page">48</span>, <b class="ts">T0$C</b>, $<b>9D00</b> ===<hr>

1D84:AD E9 37       096             LDA IBSLOT      ; GET BOOT SLOT
1D87:4A             097             LSR A
1D88:4A             098             LSR A
1D89:4A             099             LSR A
1D8A:4A             100             LSR A
1D8B:8D 6A 2A       101             STA CS          ; SET AS CUURENT SLOT           ; *spelling*

<hr>; === <b class="file"><a name="DOSHOOK">DOSHOOK</a></b> - Input / Output Vector, Page <span id="page">44</span>,  <b class="ts">T?S?</b>, $<b>????</b> ===<hr>

<hr>; === <b class="file"><a name="CMDSCAN">CMDSCAN</a></b> - Scan for commands, Page <span id="page">16</span>,  <b class="ts">T?S?</b>, $<b>????</b> ===<hr>
                    001             PAGE
                    002 ;
                    003 ; SCNCMD - SCAN A COMMAND
                    004 ;
                    005 <span class="todo">SCNCMD</span>EQU * <span class="todo">TODO</span>

<hr>; === <b class="file"><a name="XOPNCLS">XOPNCLS</a></b> - Execute Open / Close, Page <span id="page">150</span>, <b class="ts">T?S?</b>, $<b>????</b> ===<hr>
                    001             PAGE

<hr>; === <b class="file"><a name="XLODSAV">XLODSAV</a></b> - Execute Load / Save , Page <span id="page">140</span>,  <b class="ts">T?S?</b>, $<b>????</b> ===<hr>

<hr>; === <b class="file"><a name="DOSGOER">DOSGOER</a></b> - Print Error message, Page <i>40</i>, T?S?, $<b>????</b> ===<hr>
                    001             PAGE
                    002 ;
                    003 ; DOSGO - GOTO DOS
                    004 ;
                    005 <span class="todo">DOSGO</span>EQU * <span class="todo">TODO</span>

<hr>; === <b class="file"><a name="BLDFTAB">BLDFTAB</a></b> - Build File Tables, Page <i>4</i>, <b class="ts">T1$6</b> @ $D4, $<b>####</b> ===<hr>
                    001             PAGE
                    002 ;
                    003 ; BLDFTB - BUILD FILE TABLES
                    004 ; TABLE MAP:                                        ; $9600 = Array of File Tables
                    005 ;   HIMEM,SOP                                       ; $9D00 = SOP = Start of Program
                    006 ;   SBUFF  N (256)
                    007 ;   DBUFF  N (256)
                    008 ;   FTB    N (FCBLEN)
                    009 ;   HEADER N (38)                                   ; See Header Map below
                    010 ;   .
                    011 ;   .
                    012 ;   SBUFF  1
                    013 ;   DBUFF  1
                    014 ;   FTB    1
                    015 ;   HEADER 1
                    016 ;   THIS PROGRAM
                    017 ;
                    018 ; HEADER MAP:
                    019 ;   FILENAME (30)
                    020 ;   FTB  PTR (2)
                    021 ;   DBUF PTR (2)
                    022 ;   SBUF PTR (2)
                    023 ;   LINK     (2)
                    024 ;
27D4:               025 <b><a name="BLDFTB" id="BLDFTB">BLDFTB</a></b>      EQU *
27D4:38             026             SEC
27D5:AD 00 1D       027             LDA FTAB        ; START OF FTAB AREA    ; dosinit, 48
27D8:85 40          028             STA ZPGWRK      ; IS 1ST FTB PTR        ; reloctr, 110
27DA:AD 01 1D       029             LDA FTAB+1      ; HEADER
27DD:85 41          030             STA ZPGWRK+1
27DF:AD 57 2A       031             LDA CNFTBS      ; MOVE NO FTABS         ; fdosent, 60
27E2:8D 63 2A       032             STA TEMP1A      ; TO TEMP               ; fdosent, 60
                    033 ;
27E5:A0 00          034 <b><a name="BFT1" id="BFT1"    >BFT1</a></b>        LDY #0
27E7:98             035             TYA
27E8:91 40          036             STA (ZPGWRK),Y  ; 1ST CHAR FN=0
27EA:A0 1E          037             LDY #30         ; INC Y TO FCB PTR
27EC:38             038             SEC
27ED:A5 40          039             LDA ZPGWRK      ; END OF PTR HEADER
27EF:E9 2D          040             SBC #FCBLEN     ; MINUS FTAB LENGTH
27F1:91 40          041             STA (ZPGWRK),Y  ; IS START OF FTB
27F3:48             042             PHA             ; SAVE LOW ADR BYTE
27F4:A5 41          043             LDA ZPGWKR+1
27F6:48             044             SBC #0
27F8:C8             045             INY
27F9:91 40          046             STA (ZPGWKR),Y
27FB:AA             047             TAX
27FC:CA             048             DEX             ; FTB ADR - 256
27FD:68             049             PLA             ; IS ADR DIR BUFF
27FE:48             050             PHA
27FF:C8             051             INY
2800:91 40          052             STA (ZPGWRK),Y  ; SET DIR BUF PTR               ; === <b class="ts">T1$7</b> ===
2802:8A             053             TXA
<hr>2803:C8             054             INY                                             ; === Page <span id="page">5</span> ===
2804:91 40          055             STA (ZPGWRK),Y
2806:AA             056             TAX
2807:CA             057             DEX             ; DIR BUFF - 256
2808:68             058             PLA             ; IS SBUFF ADR
2809:48             059             PHA
280A:C8             060             INY
280B:91 40          061             STA (ZPGWRK),Y
280D:C8             062             INY
280E:8A             063             TXA
280F:91 40          064             STA (ZPGWRK),Y
                    065 ;
2811:CE 63 2A       066             DEC TEMP1A      ; DECREMENT TABLE INDEX
2814:F0 17          067             BEQ <a href="#BFT2">BFT2</a>        ; COUNT AND BR IF DONE  ; v
2816:AA             068             TAX
2817:68             069             PLA
2818:38             070             SEC
2819:E9 26          071             SBC #38         ; SBUFF ADR - 38
281B:C8             072             INY
281C:91 40          073             STA (ZPGWRK),Y  ; IF ADR OF NEXT TAB
281E:48             074             PHA             ; WHICH GOES INTO
281F:8A             075             TXA             ; LINK
2820:E9 00          076             SBC #0
2822:C8             077             INY
2823:91 40          078             STA (ZPGWRK),Y
2825:85 41          079             STA ZPGWRK+1    ; AND INTO ZPGWRK
2827:68             080             PLA             ; FOR NEXT ENTRY
2828:85 40          081             STA ZPGWRK      ; BUILD
282A:4C E5 27       082             JMP <a href="#BFT1">BFT1</a>                                ; ^
282D:48             083 <b><a name="BFT2" id="BFT2"    >BFT2</a></b>        EQU *

                    ;
                    ; MVISW - MOVE INPUT SWITCH
                    ;
2900:00             <b><a name="MVCSW" id="MVCSW"  >MVCSW</a></b>       EQU *
                                LDA INSW+1

<hr>; === <b class="file"><a name="CMDTBLS">CMDTBLS</a></b> - Commands, Page <span id="page">21</span>, <b class="ts">T?$?</b>, $<b>####</b> ===<hr>
                    001                 PAGE
                    002 ;
                    003 ; COMMAND NAME TABLE
                    004 ;
                    005 EC1 EQU *
                    006 CMDNTB EQU *
                    007             DCI "INIT"

<hr>; === <b class="file"><a name="FDOSENT">FDOSENT</a></b> - External Entry Point, Page <span id="page">60</span>, <b class="ts">T?$?</b>, $<b>####</b> ===<hr>
                    001                 PAGE
                    002 ;
                    003 ; MISC BUT REQD CELLS
                    004 ;
                    005 CFTABA DDB 0 ; CURRENT FILE TABLE POINTER

<hr>; === <b class="file"><a name="FOPCLRW">FOPCLRW</a></b> - Open; Close; Rename; Read, Page <span id="page">77</span>, <b class="ts">T?$?</b>, $<b>####</b> ===<hr>
                    001             PAGE
                    002 ;
                    003 ; FOPEN - OPEN A FILE
                    004 ;
                    005 FOPEN EQU *

<hr>; === <b class="file"><a name="FDELCAT">FDELCAT</a></b> - Delete, Catalog, Page <span id="page">55</span>, <b class="ts">T?$?</b>, $<b>####</b> ===<hr>
                    001             PAGE
                    002 ;
                    003 * FLOCK - LOCK A FILE
                    004 ;
                    005 FLOCK LDA #$80

<hr>; === <b class="file"><a name="FMTRWIO">FMTRWIO</a></b> - Execute Format Request, Page <span id="page">73</span>, <b class="ts">T?$?</b>, $<b>####</b> ===<hr>
                    001             PAGE
                    002 ;
                    003 * FFMT - Execute Format Request
                    004 ;
                    005 FFMT EQU *

<hr>; === <b class="file"><a name="FLOCNXB">FLOCNXB</a></b> - Locate Next Byte, Page <span id="page">68</span>, <b class="ts">T?$?</b>, $<b>####</b> ===<hr>
                    001             PAGE
                    002 ;

<hr>; === <b class="file"><a name="FLOCSEC">FLOCSEC</a></b> - Locate Sector, Page <span id="page">68</span>, <b class="ts">T?$?</b>, $<b>####</b> ===<hr>
                    001             PAGE
                    002 ;

<hr>; === <b class="file"><a name="FVCBUFS">FVCBUFS</a></b> - File Volume Catalog Buffers, Page <span id="page">?</span>, <b class="ts">T?$?</b>, $<b>????</b> ===<hr>

<hr>; === <b class="file"><a name="BOOTLDR">BOOTLDR</a></b> - Boot loader, Page <span id="page">8</span>, <b class="ts">T0$0</b>, $<b>B600</b> ===<hr>

<hr>; === <b class="file"><a name="COREQUS">COREQUS</a></b> - Core Equates, Page <span id="page">24</span>, <b class="ts">n/a</b>, $<b>n/a</b> ===<hr>

<hr>; === <b class="file"><a name="PRENIBL">PRENIBL</a></b> - Pre nibblize sector data for writing, Page <span id="page">104</span>, <b class="ts">T?$?</b>, $<b>????</b> ===<hr>

<hr>; === <b class="file"><a name="WRITRTN">WRITRTN</a></b> - Write Routine, Page <span id="page">137</span>, <b class="ts">T0$2</b>, $<b>B82A</b> ===<hr>
                    001                 SBTL '16-SECTOR WRITE'
                    002 ************************
                    003 *                      *
                    004 *      WRITE SUBR      *
                    005 *  (16-SECTOR FORMAT)  *
                    006 *                      *
                    007 ************************
                    008 *                      *
                    009 *   WRITES DATA FROM   *
                    010 *    NBUF1 AND NBUF2   *
                    011 *   CONVERTING 6-BIT   *
                    012 *    TO 7-BIT NIBLS    *
                    013 *   VIA 'NIBL' TABLE.  *
                    014 *                      *
                    015 *  FIRST NBUF2,        *
                    016 *      HIGH TO LOW.    *
                    017 *  THEN NBUF1,         *
                    018 *      LOW TO HIGH.    *
                    019 *                      *
                    020 *  ---- ON ENTRY ----  *
                    021 *                      *
                    022 *   X-REG: SLOTNUM     *
                    023 *        TIMES $10.    *
                    024 *                      *
                    025 *   NBUF1 AND NBUF2    *
                    026 *    HOLD NIBLS FROM   *
                    027 *    PRENIBL SUBR.     *
                    028 *    (00ABCDEF)        *
                    029 *                      *
                    030 *  ---- ON EXIT -----  *
                    031 *                      *
                    032 *  CARRY SET IF ERROR. *
                    033 *   (W PROT VIOLATION) *
                    034 *                      *
                    035 *  IF NO ERROR:        *
                    036 *                      *
                    037 *    A-REG UNCERTAIN.  *
                    038 *    X-REG UNCHANGED.  *
                    039 *    Y-REG HOLDS $00.  *
                    040 *    CARRY CLEAR.      *
                    041 *                      *
                    042 *    SLOTABS, SLOTZ,   *
                    043 *     AND WTEMP USED.  *
                    044 *                      *
                    045 *  ---- ASSUMES ----   *
                    046 *                      *
                    047 *  1 USEC CYCLE TIME   *
                    048 *                      *
                    049 ************************
382A:38             050 <b><a name="WRITE16"    id="WRITE16"    >WRITE16</a></b>     SEC             ;ANTICIPATE WPROT ERR.          ; === Reloc @ $B82A ===
382B:86 27          051             STX SLOTZ       ;FOR ZERO PAGE ACCESS.
382D:8E 78 06       052             STX SLOTABS     ;FOR NON-ZERO PAGE.
3830:BD 8D C0       053             LDA Q6H,X
3833:BD 8E C0       054             LDA Q7L,X       ;SENSE WPROT FLAG.
3836:30 7C          055             BMI <a href="#WEXIT">WEXIT</a>       ;IF HIGH, THEN ERR.             ; v
3838:AD 00 3C       056             LDA NBUF2
383B:85 26          057             STA WTEMP       ;FOR ZERO-PAGE ACCESS.
383D:A9 FF          058             LDA #$FF        ;SYNC DATA
383F:9D 8F C0       059             STA Q7H,X       ;(5) WRITE 1ST NIBL.
3842:1D 8C C0       060             ORA Q6L,X       ;(4)
3845:48             061             PHA             ;(3)
3846:68             062             PLA             ;(4) CRITICAL TIMING!
3847:EA             063             NOP             ;(2)
3848:A0 04          064             LDY #4          ;(2)  FOR 5 NIBLS.
384A:48             065 <b><a name="WSYNC"      id="WSYNC"      >WSYNC</a></b>       PHA             ;(3) EXACT TIMING               ; --- Sync FF ---
384B:68             066             PLA             ;(4) EXACT TIMING
384C:20 B9 38       067             JSR <a href="#WNIBL7">WNIBL7</a>      ;(13,9,6)  WRITE SYNC
384F:88             068             DEY             ;(2)
3850:D0 F8          069             BNE <a href="#WSYNC" >WSYNC</a>       ;(2*)  MUST NOT  CROSS PAGE!    ; ^
3852:A9 D5          070             LDA #$D5        ;(2)  1ST DATA MARK.            ; --- Data Header D5 AA AD ---
3854:20 B8 38       071             JSR <a href="#WNIBL9">WNIBL9</a>      ;(15,9,6)
3857:A9 AA          072             LDA #$AA        ;(2)  2ND DATA MARK.
3859:20 B8 38       073             JSR <a href="#WNIBL9">WNIBL9</a>      ;(15,9,6)
385C:A9 AD          074             LDA #$AD        ;(2)  3RD DATA MARK.
385E:20 B8 38       075             JSR <a href="#WNIBL9">WNIBL9</a>      ;(15,9,6)
3861:98             076             TYA             ;(2) CLEAR CHECKSUM
3862:A0 56          077             LDY #$56        ;(2) NBUF2 INDEX.
3864:D0 03          078             BNE <a href="#WDATA1">WDATA1</a>      ;(3)  ALWAYS.  NO PAGE CROSS!!  ; v
3866:B9 00 3C       079 <b><a name="WDATA0"     id="WDATA0"     >WDATA0</a></b>      LDA NBUF2,Y     ;(4)  PRIOR 6-BIT NIBL.
3869:58 FF 3B       080 <b><a name="WDATA1"     id="WDATA1"     >WDATA1</a></b>      EOR NBUF2-1,Y   ;(5)  XOR WITH CURRENT.
                    081 *   (NBUF2 MUST BE ON PAGE BOUNDARY FOR TIMING!!)
386C:AA             082             TAX             ;(2)  INDEX To 7-BIT NIBL
386D:BD 29 3A       083             LDA NIBL,X      ;(4)  MUST NOT CROSS PAGE!
3870:A6 27          084             LDX SLOTZ       ;(3)  CRITICAL TIMING!
3872:9D 8D C0       085             STA Q6H,X       ;(5)  WRITE NIBL.
3875:BD 8C C0       086             LDA Q6L,X       ;(4)
3878:88             087             DEY             ;(2)  NEXT NIBL.
3879:D0 EB          088             BNE <a href="#WDATA0">WDATA0</a>      ;(2*) MUST NOT CROSS PAGE!      ; ^
387B:A5 26          089             LDA WTEMP       ;(3) PRIOR NIBL FROM BUF6.
387D:EA             090             NOP             ;(2)  CRITICAL TIMING.
387E:59 00 3B       091 <b><a name="WDATA2"     id="WDATA2"     >WDATA2</a></b>      EOR NBUF1,Y     ;(5)  XOR WITH CURRENT.
3881:AA             092             TAX             ;(2)
3882:BD 29 3A       093             LDA NIBL,X      ;(4)
3885:AE 78 06       094             LDX SLOTABS     ;(4) TIMING CRITICAL
3888:9D 8D C0       095             STA Q6H,X       ;(5) WRITE NIBL.
388B:BD 8C C0       096             LDA Q6L,X       ;(4)
388E:B9 00 3B       097             LDA NBUF1,Y     ;(4)  PRIOR 6-BIT NIBL.
3891:C8             098             INY             ;(2)NEXT NBUF1 NIBL.
3892:D0 EA          099             BNE <a href="#WDATA2">WDATA2</a>      ;(2*) MUST NOT CROSS PAGE!      ; ^
3894:AA             100             TAX             ;(2)
3895:BD 29 3A       101             LDA NIBL,X      ;(4)  INDEX TO 7-BIT NIBL
3898:A6 27          102             LDX SLOTZ       ;(3)
389A:20 BB 38       103             JSR <a href="#WNIBL">WNIBL</a>       ;(6,9,6)  WRITE CHKSUM
389D:A9 DE          104             LDA #$DE        ;(2)  DM4, BIT SLIP MARK.
389F:20 B8 38       105             JSR <a href="#WNIBL9">WNIBL9</a>      ;(15,9,6)    WRITE IT.
38A2:A9 AA          106             LDA #$AA        ;(2)  DM5, BIT SLIP MARK.
38A4:20 B8 38       107             JSR <a href="#WNIBL9">WNIBL9</a>      ;(15,9,6)    WRITE IT.
38A7:A9 EB          108             LDA #$EB        ;(2)  DM6, BIT SLIP MARK.
38A9:20 B8 38       109             JSR <a href="#WNIBL9">WNIBL9</a>      ;(15,9,6)    WRITE IT.
38AC:A9 FF          110             LDA #$FF        ;(2) TURN-OFF BYTE.
38AE:20 B8 38       111             JSR <a href="#WNIBL9">WNIBL9</a>      ;(15,9,9) WRITE IT.             ; TODO: 15,9,6??
38B1:BD 8E C0       112             LDA Q7L,X       ;OUT OF WRITE MODE.
38B4:BD 8C C0       113 <b><a name="WEXIT"      id="WEXIT"      >WEXIT</a></b>       LDA Q6L,X       ;TO READ MODE.
38B7:60             114             RTS             ;RETURN FROM WRITE.
                    115 *****************************
                    116 *                           *
<hr>                    117 *   7-BIT NIBL WRITE SUBRS  *                               ; === WRITRTN, Page <span id="page">139</span> ===
                    118 *                           *
                    119 *   A-REG OR'D PRIOR EXIT   *
                    120 *       CARRY CLEARED       *
                    121 *                           *
                    122 *****************************
38B8:18             123 <b><a name="WNIBL9"     id="WNIBL9"     >WNIBL9</a></b>      CLC             ; (2) 9 CYCLES, THEN WRITE.
38B9:48             124 <b><a name="WNIBL7"     id="WNIBL7"     >WNIBL7</a></b>      PHA             ; (3) 7 CYCLES, THEN WRITE.
38BA:68             125             PLA             ; (4)
38BB:9D 8D C0       126 <b><a name="WNIBL"      id="WNIBL"      >WNIBL</a></b>       STA Q6H,X       ; (5) NIBL WRITE SUB.
38BE:1D 8C C0       127             ORA Q6L,X       ; (4) CLOBBERS ACC, NOT CARRY
38C1:60             128             RTS

<hr>; === <b class="file"><a name="POSTNRD">POSTNRD</a></b> - Post Nibbilize Read, Page <span id="page">101</span>, <b class="ts">T0$2</b> @ $C2, $<b>B8C2</b> .. $<b>B???</b> <span class="todo">TODO</span> ===<hr>
                    001         SBTL '16-SECTOR POSTNIBLIZE'
                    002 ***************************
                    003 *                         *
                    004 *    POSTNIBLIZE SUBR     *
                    005 *    16-SECTOR FORMAT     *
                    006 *                         *
                    007 ***************************
                    008 *                         *
                    009 *  CONVERTS 6-BIT NIBLS   *
                    010 *  OF FORM 00ABCDEF IN    *
                    011 *  NBUF1 AND NBUF2 INTO   *
                    012 *  256 BYTES OF USER      *
                    013 *  DATA IN BUF.           *
                    014 *                         *
                    015 *   ---- ON ENTRY ----    *
                    016 *                         *
                    017 *  X-REG: HOLDS SLOTNUM   *
                    018 *            TIMES $10.   *
                    019 *                         *
                    020 *  BUF IS 2-BYTE POINTER  *
                    021 *    TO 256 BYTES OF USER *
                    022 *    DATA TO BE CONVERTED *
                    023 *    TO 6-BIT NIBLS IN    *
                    024 *    NBUF1 AND NBUF2      *
                    025 *    PRIOR TO WRITE.      *
                    026 *                         *
                    027 *  T0 CONTAINS BYTE COUNT *
                    028 *    CODE0 = 256 BYTES    *
                    029 *    CODE1 =   1 BYTE     *
                    030 *    CODE2 =   2 BYTER    *
                    031 *                         *
                    032 *    CODE 255=255 BYTES   *
                    033 *                         *
                    034 *   ---- ON EXIT -----    *
                    035 *                         *
                    036 *  A-REG UNCERTAIN.       *
                    037 *  Y-REG SAME AS T0.      *
                    038 *  X-REG UNCERTAIN.       *
                    039 *  CARRY SET.             *
                    040 *                         *
                    041 *  6-BIT NIBLS OF FORM    *
                    042 *    00ABCDEF IN NBUF1    *
                    043 *    AND NBUF2.           *
                    044 *      (242 NIBLS)        *
                    045 ***************************
38C2:A0 00          046 <b><a name="POSTNB16"   id="POSTNB16"   >POSTNB16    </a></b>LDA #$0         USER DATA BUF IDX.              ; <b class="ts">T0$2</b> <span class="todo">TODO</span>
38C4:A2 56          047 <b><a name="POST1"      id="POST1"      >POST1       </a></b>LDX #$56        INIT NBUF2 INDEX.
38C6:CA             048 <b><a name="POST2"      id="POST1"      >POST2       </a></b>DEX             IDX $55 TO $0
38C7:30 FB          049             BMI <a href="#POST1">POST1</a>       WRAPAROUND IF NEG.              ; ^
38C9:B9 00 3B       050             LDA NBUF1,Y
38CC:5E 00 3C       051             LSR NBUF2,X     SHIFT 2 BITS FROM
38CF:2A             052             ROL             A CURRENT NBUF2 NIBL
38D0:5E 00 3C       053             LSR             INTO CURRENT NBUF1
<hr>38D3:2A             054             ROL             A NIBL.                         ; === Page <span id="page">102</span> ===
38D4:91 3E          055             STA (BUF),Y     BYTE OF USER DATA.
38D6:C8             056             INY             NEXT USER BYTE.
38D7:C4 26          057             CPY T0          DONE IF EQUAL T0.
38D9:D0 EB          058             BNE <a href="#POST2">POST2</a>                                       ; ^
38DB:60             059             RTS             RETURN.
                    060                 SBTL '16-SECTOR READ'

; === ===

39FC:60             ???             RTS

RDADSEK

<hr>; === <b class="file"><a name="MSWAITR">MSWAITR</a></b> - Microsecond wait routine, Page <span id="page">97</span>, <b class="ts">T0$4</b>-<b class="ts">T0$6</b> @ $55, $<b>BA00</b> - $<b>BC55</b> ===<hr>
                    001                 SBTL '16-SECTOR MSWAIT'
                    002 **************************
                    003 *   MSWAIT SUBROUTINE    *
                    004 **************************
                    005 *                        *
                    006 *  DELAYS A SPECIFIED    *
                    007 *   NUMBER OF 100 USEC   *
                    008 *   INTERVALS FOR MOTOR  *
                    009 *   ON TIMING.           *
                    010 *                        *
                    011 *   ---- ON ENTRY ----   *
                    012 *  A-REG: HOLDS NUMBER   *
                    013 *        OF 100 USEC     *
                    014 *        INTERVALS TO    *
                    015 *        DELAY.          *
                    016 *                        *
                    017 *   ---- ON EXIT -----   *
                    018 *  A-REG: HOLDS $00.     *
                    019 *  X-REG: HOLDS $00.     *
                    020 *  Y-REG: UNCHANGED.     *
                    021 *  CARRY: SET.           *
                    022 *                        *
                    023 *  MONTIMEL, MONTIMEH    *
                    024 *   ARE INCREMENTED ONCE *
                    025 *   PER 100 USEC INTERVAL*
                    026 *   FOR MOTON ON TIMING. *
                    027 *    ---- ASSUMES ----   *
                    028 * 1 USEC CYCLE TIME      *
                    029 **************************
39FD:00 00 00       030         DS 3,0              ;AVOID PAGE BOUNDARY CROSSING...; T0$3 @ $FC = 3 unused bytes
3A00:A2 11          031 <b><a name="MSWAIT"     id="MSWAIT"     >MSWAIT      </a></b>LDX #$11                                        ; === <b class="ts">T0$4</b> === *sigh* Typical bloated code ...
3A02:CA             032 <b><a name="MSW1"       id="MSW1"       >MSW1        </a></b>DEX             DELAY 86 USEC.                  ; ... should just adjust algorithm timing instead!
3A03:D0 FD          033             BNE <a href="#MSW1">MSW1</a>
3A05:E6 46          034             INC MONTIMEL
3A07:D0 02          035             BNE <a href="#MSW2">MSW2</a>        ; DOUBLE-BYTE
3A09:E6 47          036             INC MONTIMEH    INCREMENT.
3A0B:38             037 <b><a name="MSW2"       id="MSW2"       >MSW2        </a></b>SEC
3A0C:E9 01          038             SBC #$1         DONE 'N' INTERVALS?
3A0E:D0 F0          039             BNE <a href="#MSWAIT">MSWAIT</a></b>            (A-REG COUNTS)
3A10:60             040             RTS
                    041 AEC1        EQU *           ;TELL RELOCATOR WHERE CORE ENDS
                    042 **************************
                    043 *  PHASE ON-, OFF-TIME   *
                    044 *   TABLES IN 100-USEC   *
                    045 *   INTERVALS. (SEEK)    *
                    046 **************************
3A11:01 30 28       047 ONTABLE     DFB 1,$30,$28
3A14:24 20 1E       048             DFB $24,$20,$1E
3A17:1D 1C 1C       049             DFB $1D,$1C,$1C
3A1A:1C 1C 1C       050             DFB $1C,$1C,$1C
3A1D:70 2C 26       051 OFFTABLE    DFB $70,$2C,$26
3A20:22 1F 1E       052             DFB $22,$1F,$1E
3A23:1D 1C 1C       053             DFB $1D,$1C,$1C
<hr>3A26:1C 1C 1C       054             DFB $1C,$1C,$1C                                 ; === Page <span id="page">98</span> ===
                    055             SBTL '16-SECTOR NYBBLE TABLES'
                    056 ***************************
                    057 *                         *
                    058 *     6-BIT TO 7-BIT      *
                    059 *  NIBL CONVERSION TABLE  *
                    060 *                         *
                    061 ***************************
                    062 *                         *
                    063 *   CODES WITH MORE THAN  *
                    064 *   ONE PAIR OF ADJACENT  *
                    065 *    ZEROES OR WITH NO    *
                    066 *   ADJACENT ONES (EXCEPT *
                    067 *     B7) ARE EXCLUDED.   *
                    068 *                         *
                    069 * THIS TABLE MAY *NOT*    *
                    070 * CROSS A PAGE BOUNDARY!  *
                    071 *                         *
                    072 ***************************
3A29:96 97 9A       073 <i><a name="NIBL"       id="NIBL"       >NIBL        </a></i>DFB $96,$97,$9A                                 ; /sarcasm, Gee if only
3A2C:9B 9D 9E       074             DFB $9B,$9D,$9E                                 ; there was a HEX pseudo-mnemonic
3A2F:9F A6 A7       075             DFB $9F,$A6,$A7                                 ; so we could group these in 4 bytes ...
3A32:AB AC AD       076             DFB $AB,$AC,$AD                                 ; ... maybe one day. :)
3A35:AE AF B2       077             DFB $AE,$AF,$B2                                 ; NOTE: Also see <a href="#NIBL">NIBL</a> and <a href="#PD2">PD2</a>
3A38:B3 B4 B5       078             DFB $B3,$B4,$B5
3A3B:B6 B7 B9       079             DFB $B6,$B7,$B9
3A3E:BA BB BC       080             DFB $BA,$BB,$BC
3A41:BD BE BF       081             DFB $BD,$BE,$BF
3A44:CB CD CE       082             DFB $CB,$CD,$CE

TODO:
                    137
                    139 <b><a name="OFF80"      id="OFF80"      >OFF80       </a></b>EQU *
3A76:A9 FF          140             LDA #$FF
3A78:8D FB 04       141             STA $4FB        ; CLEARS FUNNY 80 COL STUFF
3A7B:8D 0C C0       142             STA $C00C       ; TURNS 80 COL OFF
3A7E:8D 0E C0       143             STA $C00E       ; TURN OFF  ALT CHAR SET
3A81:4C 2F FB       144             JMP $FB2F       ; MONITOR INIT ROUTINE          ; If only we could define symbols ...
                    145             PAGE
                    146 <i><a name="PEC1"       id="PEC1"       >PEC1        </a></i>EQU *           ;Tell relocater where to stop   ; See <a href="#CDETAB">CDETAB</a>, RELOCTR, Page <span id="page">115</span>
                    147 PD1         EQU &gt;*
                    148 <i><a name="PD2"        id="PD2"        >PD2         </a></i>EQU $96-PD1<span class="patch">
                    === DOS 3.3 D? PATCH ===        
                    3A84:AD BD 35   LDA $35BD ; <span class="todo">TODO</span>
                    3A87:8D E6 35   STA $35E6 ; <span class="todo">TODO</span>
                    3A8A:8D EA 35   STA $35EA ; <span class="todo">TODO</span>
                    3A8D:BA         TSX             
                    3A8E:8E 9B 33   STX $339B ; <span class="todo">TODO</span>
                    3A91:4C 7F 33   JMP $337F ; <span class="todo">TODO</span>
                    === DOS 3.3 ? PATCH ===         </span>
3A84:00 00 00 00    149             DS  PD2,0       ;Must pad to $XX96              ; *sigh* 18 wasted bytes
3A88:00 00 00 00                                                                    ; No, no, no!
3A8C:00 00 00 00                                                                    ; Negative array index OFFSETS like the P6 PROM uses
3A90:00 00 00 00                                                                    ;
3A94:00 00
3A96:00 01 98       150             DFB $00,$01,$98                                 ; 96 97 --   *sigh* And the comment that this is the
3A99:99 02 03       151             DFB $99,$02,$03                                 ; -- 9A 9B   64 disk nibbles of 6&amp;2 Read Table
3A9C:9C 04 05       152             DFB $9C,$04,$05                                 ; -- 9D 9E   is where again? Comments people, comments!
3A9F:06 A0 A1       153             DFB $06,$A0,$A1                                 ; 9F -- --   Hey, after annotating 154 pages
3AA2:A2 A3 A4       154             DFB $A2,$A3,$A4                                 ; -- -- --   you would be grumpy too. :-)
3AA5:A5 07 08       155             DFB $A5,$07,$08                                 ; -- A6 A7
3AA8:A8 A9 AA       156             DFB $A8,$A9,$AA                                 ; -- -- !!   (!! Technically AA is a valid disk nibble)
3AAB:09 0A 0B       157             DFB $09,$0A,$0B                                 ; AB AC AD   but it reserved for a 3 byte header id
3AAE:0C 0D B0       158             DFB $0C,$0D,$B0                                 ; AE AF --   Typical DOS 3.3 B-L-O-A-T
3AB1:B1 0E 0F       159             DFB $B1,$0E,$0F                                 ; -- B2 B3   One reserved byte D5 could be used for T/S  header
3AB4:10 11 12       160             DFB $10,$11,$12                                 ; B4 B5 B6   One reserved byte AA could be used for Data header
3AB7:13 B8 14       161             DFB $13,$B8,$14                                 ; B7 -- B9
3ABA:15 16 17       162             DFB $15,$16,$17                                 ; BA BB BC
3ABD:18 19 1A       163             DFB $18,$19,$1A                                 ; BD BE BF
3AC0:C0 C1 C2       164             DFB $C0,$C1,$C2                                 ; -- -- --   *sigh* 11 unused bytes
3AC3:C3 C4 C5       165             DFB $C3,$C4,$C5                                 ; -- -- --   /sarcasm But who cares, we have 48K right!?
3AC6:C6 C7 C8       166             DFB $C6,$C7,$C8                                 ; -- -- --   This is why DOS takes seconds longer to boot.
3AC9:C9 CA 1B       167             DFB $C9,$CA,$1B                                 ; -- -- CB
3ACC:CC 1C 1D       168             DFB $CC,$1C,$1D                                 ; -- CD CE   *sigh* This entire table can be compactly
3ACF:1E D0 D1       169             DFB $1E,$D0,$D1                                 ; CF -- --   represented with 8 lines instead of 36 lines
3AD2:D2 20 21       170             DFB $D2,$1F,$D4                                 ; -- D3 --   If only we had a HEX pseudo-mnemonic ...
3AD5:D5 20 21       171             DFB $D5,$20,$21                                 ; @@ D6 D7   (@@ Technically D5 is valid but is reserved too)
3AD8:D8 22 23       172             DFB $D8,$22,$23                                 ; -- D9 DA      x0 x1 x2 x3 x4 x5 x6 x7 x8 x9 xA xB xC xD xE xF
3ADB:24 25 26       173             DFB $24,$25,$26                                 ; DB DC DD   9x:-- -- -- -- -- -- 00 01 -- -- 02 03 -- 04 05 06
3ADE:27 28 E0       174             DFB $27,$28,$E0                                 ; DE DF --   Ax:-- -- -- -- -- -- 07 08 -- -- !! 09 0A 0B 0C 0D
3AE1:E1 E2 E3       175             DFB $E1,$E2,$E3                                 ; -- -- --   Bx:-- -- 0E 0F 10 11 12 13 -- 14 15 16 17 18 19 1A
3AE4:E4 29 2A       176             DFB $E4,$29,$2A                                 ; -- E5 E6   Cx:-- -- -- -- -- -- -- -- -- -- -- 1B -- 1C 1D 1E
3AE7:2B E8 2C       177             DFB $2B,$E8,$2C                                 ; E7 -- E9   Dx:-- -- -- 1F -- @@ 20 21 -- 22 23 24 25 26 27 28
3AEA:2D 2E 2F       178             DFB $2D,$2E,$2F                                 ; EA EB EC   Ex:-- -- -- -- -- 29 2A 2B -- 2C 2D 2E 2F 30 31 32
3AED:30 31 32       179             DFB $30,$31,$32                                 ; ED EE EF   Fx:-- -- 33 34 35 36 37 38 -- 39 3A 3B 3C 3D 3E 3F
<hr>3AF0:F0 F1 33       180             DFB $F0,$F1,$33                                 ; -- -- F2   === Page <span id="page">100</span> ===
3AF3:34 35 36       181             DFB $34,$35,$36                                 ; F3 F4 F5
3AF6:37 38 F8       182             DFB $37,$38,$F8                                 ; F6 F7 --
3AF9:39 3A 3B       183             DFB $39,$3A,$3B                                 ; F9 FA FB
3AFC:3C 3D 3E       184             DFB $3C,$3D,$3E                                 ; FC FD FE
3AFF:3F             185             DFB $3F                                         ; FF
                    186             PAGE
                    187 ***************************
                    188 *                         *
                    189 *    NYBBLE BUFFERS       *
                    190 *                         *
                    191 * NBUF1 (256 BYTES) MUST  *
                    192 *  BE ALIGNED ON A PAGE   *
                    193 *  BOUNDARY.              *
                    194 *                         *
                    195 * NBUF2 (86 BYTES) MUST   *                                 ; Incorrect: It must _not_ CROSS
                    196 *  BE ALIGNED ON A PAGE   *                                 ; a page boundary. It can be
                    197 *  BOUNDARY.              *                                 ; anywhere *within* the page.
                    198 *                         *                                 ;
                    199 ***************************                                 ; *sigh* Let's waste an *entire* sector with
                    200 *                                                           ; 342 disk nibbles of raw 96 96 96 data,
3B00:00 00 00 00    201 <i><a name="NBUF1"      id="NBUF1"      >NBUF1       </a></i>DS 256,0        ;NBUF1                          ; when _10 bytes_ would do the job IF NUBF1 == $BF00
3B04:00 00 00 00                                                                    ;    LDA #0
3B08:00 00 00 00                                                                    ;    LDY #0
3B0C:00 00 00 00                                                                    ;.1  STA NBUF1,Y
3B10:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                ;    INY
3B20:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                ;    BNE .1
3B30:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3B40:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3B50:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3B60:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3B70:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3B80:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3B90:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3BA0:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3BB0:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3BC0:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3BD0:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3BE0:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3BF0:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00

3C00:00 00 00 00    202 <i><a name="NBUF2"      id="NBUF2"      >NBUF2       </a></i>DS  86,0        ;NBUF2                          ; *sigh* more wasted disk space 
3C04:00 00 00 00
3C08:00 00 00 00
3C0C:00 00 00 00
3C10:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3C20:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3C30:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3C40:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3C50:00 00 00 00 00 00

WRITADR
RWTSONE

<hr>; === <b class="file"><a name="RWTSTWO">RWTSTWO</a></b> - Read Write Track Sector - Part 2, Page <span id="page">124</span>, <b class="ts">T0$8</b>, $<b class="adr">BE47</b> ===<hr>
                    001 *
                    002 * DISK IS NOW UP TO SPEED: READ IT!
                    003 * NOW CHECK: IF IT IS NOT THE FORMAT DISK COMMAND,
                    004 * LOCATE THE CORRECT SECTOR FOR THIS OPERATION.
                    005 *
                    006 <b><a name="TRYTRK"     id="TRYTRK"     >TRYTRK      </a></b>EQU *
3DAB:A0 0C          007             LDY #$0C
3DAD:B1 48          008             LDA (IOBPL),Y   ;GET COMMAND CODE #
3DAF:F0 5A          009             BEQ <a href="#GALLDONE">GALLDONE</a>    ;IF NULL COMMAND, GO HOME TO BED.           ; v
3DB1:C9 04          010             CMP #$04        ;FORMAT THE DISK?               ; *sigh* RWTS_CMD_FORMAT = 4
3DB3:F0 58          011             BEQ <a href="#FORMDSK">FORMDSK</a>     ;ALLRIGHT,ALLRIGHT, I WILL...
3DB5:6A             012             ROR A           ;SET CARRY=1 FOR READ, 0 FOR WRITE
3DB6:08             013             PHP             ;AND SAVE THAT
3DB7:B0 03          014             BCS <a href="#TRYTRK2">TRYTRK2</a>     ;MUST PRENIBBLE FOR WRITE.
                    015     LST OFF
                    016     DO DIAGMOD<span style="background-color:#EEE">
                    017         LDY #TC17           ;SAY 'PRENIBBLIZING'
                    018         STY TL7                                 </span>
                    019     FIN
                    020     LST ON
3DB9:20 00 38       021             JSR <a href="#PRENIB16">PRENIB16</a>
                    022     LST OFF
                    023     DO DIAGMOD<span style="background-color:#EEE">
                    024         LDY #SP             ;PRENIB FINISHED    
                    025         STY TL7                                 </span>
                    026     FIN
                    027     LST ON
3DBC:A0 30          028 <b><a name="TRYTRK2"    id="TRYTRK2"    >TRYTRK2     </a></b>LDY #$30        ;ONLY 48 RETRIES OF ANY KIND.
3DBE:8C 78 05       029             STY RETRYCNT
3DC1:AE F8 05       030 <b><a name="TRYADR"     id="TRYADR"     >TRYADR      </a></b>LDX SLOT        ;GET SLOT NUM INTO X-REG
                    031     LST OFF
                    032     DO DIAGMOD<span style="background-color:#EEE">
                    033         LDA #TC4            ;SAY 'READING ADDRESS'          
                    034         STA TL4                                             
                    035         LDA #SP             ;SAY 'NO ADDRESS ERROR' (YET)   
                    036         STA TL6                                             </span>
                    037     FIN
                    038     LST ON
3DC4:20 44 39       039             JSR <a href="#RDADR16">RDADR16</a>     ;READ NEXT ADDRESS FIELD        ; ^
                    040     LST OFF
                    041     DO DIAGMOD<span class="macro">
                    042         LDA #SP             ;ADDRESS-READ DONE              
                    043         STA TL4                                             </span>
                    044     FIN
                    045     LST ON
3DC7:90 24          046             BCC <a href="#RDRIGHT">RDRIGHT</a>     ;IF READ IT RIGHT, HURRAH!      ; v
                    047     LST OFF
                    048     DO DIAGMOD<span class="macro">
                    049         LDA #TC6            ;ADDRESS-READ DONE              
                    050         STA TL4                                             </span>
                    051     FIN
                    052     LST ON
3DC9:CE 78 05       053 <b><a name="TRYADR2"    id="TRYADR2"    >TRYADR2     </a></b>DEC RETRYCNT    ;ANOTHER MISTAEK!!              ; *spelling* **irony**
<hr>3DCC:10 F3          054             BPL <a href="#TRYADR">TRYADR</a>      ; WELL, LET IT GO THIS TIME..   ; === page <span id="page">123</span> ===
                    055 *
                    056 * RRRRRECALIBRATE !!!!
                    057 *
                    058 RECAL       EQU *
3DCE:AD 78 04       059             LDA CURTRK
3DD1:48             060             PHA             ;SAVE TRACK WE REALLY WANT
3DD2:A9 60          061             LDA #$60        ;RECALIBRATE ALL OVER AGAIN!    ; /sarcasm Yeah ... 
3DD4:20 95 3E       062             JSR <a href="#SETTRKK">SETTRKK</a>     ;PRETEND TO BE ON TRACK 96      ; Let's bang the user's drive head against the case ...
3DD7:CE F8 06       063             DEC RECALCCNT   ;ONCE TOO MANY??                ; ... that will make it work ... NOT!
3DDC:F0 28          064             BEQ <a href="#DRVERR">DRVERR</a>      ;TRIED TO RECALIBRATE TOO MANY TIMES, ERROR! ; v
3DDE:A9 04          065             LDA #MAXSEEKS   ;RESET THE
3DDE:8D F8 04       066             STA SEEKCNT     ; SEEK COUNTER
3DE1:A9 00          067             LDA #$00
3DE3:20 5A 3E       068             JSR <a href="#MYSEEK">MYSEEK</a>      ;MOVE TO TRACK 00               ; v
3DE6:68             069             PLA
3DE7:4C 5A 3E       070 <b><a name="RESEEK"     id="RESEEK"     >RESEEK      </a></b>JSR <a href="#MYSEEK">MYSEEK</a>      ;GO TO CORRECT TRACK THIS TIME!
3DEA:4C BC 3D       071             JMP <a href="#TRYTRK2">TRYTRK2</a>     ;LOOP BACK, TRY AGAIN ON THIS TRACK
                    072 *
                    073 * HAVE NOW READ
                    074 * MAKE SURE THIS IS THE TRACK, SECTOR, AND VOLUME DESIRED.
                    075 *
3DED:A4 2E          076 <b><a name="RDRIGHT"    id="RDRIGHT"    >RDRIGHT     </a></b>LDY TRACK       ;ON THE RIGHT TRACK?
3DEF:CC 78 04       077             CPY CURTRK
3DF2:F0 1C          078             BEQ <a href="#RTTRK">RTTRK</a>       ;IF SO, GOOD                    ; v
                    079 * NO, DRIVE WAS ON A DIFFERENT TRACK. TRY
                    080 * RESEEKING/RECALIBRATING FROM THIS TRACK
3DF4:AD 78 04       081             LDA CURTRK      ;PRESERVE DESTINATION TRACK
3DF7:48             082             PHA
3DF8:98             083             TYA
3DF9:20 95 3E       084             JSR <a href="#SETTRK">SETTRK</a>
3DFC:68             085             PLA
3DFD:CE F8 04       086             DEC SEKCNT      ;SHOULD WE RESEEK?
3E00:D0 E5          087             BNE <a href="#RESEEK">RESEEK</a>      ;=&gt;YES, RESEEK                  ; ^ === <b class="ts">T0$8</b> ===
3E02:F0 CA          088             BEQ <a href="#RECAL" >RECAL</a>       ;=&gt;NO, RECALIBRATE!             ; ^
                    089 ****
3E04:68             090 <b><a name="DRVERR"     id="DRVERR"     >DRVERR      </a></b>PLA             ;REMOVE CURTRK
3E05:A9 40          091             LDA #IBDERR     ;BAD DRIVE ERROR
3E07:28             092 <b><a name="JMPTO1"     id="JMPTO1"     >JMPTO1      </a></b>PLP
3E08:4C 48 3E       093             JMP <a href="#HNDLERR">HNDLERR</a>
3E0B:F0 39          094 <b><a name="GALLDONE"   id="GALLDONE"   >GALLDONE    </a></b>BEQ <a href="#ALLDONE">ALLDONE</a>                                     ; v
3E0D:4C AF 3E       095 <b><a name="FORMDSK"    id="FORMDSK"    >FORMDSK     </a></b>JMP <a href="#DSKFORM">DSKFORM</a>     ;=&gt;GO TO IT!                    ; v
                    096 *
                    097 * DRIVE IS ON RIGHT TRACK, CHECK VOLUME MISMATCH
                    098 *
3E10:A0 03          099 <b><a name="RTTRK"      id="RTTRK"      >RTTRK       </a></b>LDY #3          ;IS THE RIGHT DISK IN?
3E12:B1 48          100             LDA (IOBPL),Y   ;GET DESIRED VOLUM
3E14:48             101             PHA             ;PRESERVE DESIRED VOLUME#
3E15:A5 2F          102             LDA VOLUME      ;GET ACTUAL VOLUME HERE
3E17:A0 0E          103             LDY #$0E        ;TELL OPSYS WHAT VOLUME WAS THERE ; *sigh* IOB_OFFSET_VOL = E
3E19:91 48          104             STA (IOBPL),Y
3E1B:68             105             PLA             ;GET DESIRED VOLUME BACK
3E1C:F0 08          106             BEQ <a href="#CORRECTVOL">CORRECTVOL</a>  ;DESIRED VOLUME 00 MATCHES ALL. ; v
3E1E:C5 2F          107             CMP VOLUME
3E20:F0 04          108             BEQ <a href="#CORRECTVOL">CORRECTVOL</a>  ;YUP, IT WAS RIGHT!             ; v
3E22:A9 20          109             LDA #IBVMME     ;HE SWITCHED DISCS!
3E24:D0 E1          110             BNE <a href="#JMPTO1">JMPTO1</a>      ;ALWAYS TAKEN                   ; ^
                    111 <b><a name="CORRECTVOL" id="CORRECTVOL" >CORRECTVOL  </a></b>EQU *
3E26:A0 05          112             LDY #5                                          ; *sigh* IOB_OFFSET_SECTOR = 5
3E28:B1 48          113             LDA (IOBPL),Y   ; TO ALLOW FOR INTERLEAVE
3E2A:A8             114             TAY
3E2B:B9 B8 3F       115             LDA INTRLEAV,Y  ;COMPUTE PHYSICAL SECTOR        ; DOS Sector Interleave/Skew Mapping
<hr>3E2E:C5 2D          116             CMP SECT        ;DID WE GET THE SECTOR?         ; === Page <span id="page">124</span> ===
                    117     LST OFF
                    118     DO DIAGMOD<span style="background-color:#EEE">
                    119         BEQ GOTSECT         ;=&gt;WE FOUND IT!                         
                    120         LDA #TC5            ;SAY 'LATENCY'                          
                    121         STA TL5                                                     
                    122         LDA SCOUNT          ;ARE WE WAITING FOR FIRST SECTOR?       
                    123         BEQ NOLAT           ;=&gt;YES, LATENCY UNPREDICTABLE ANYWAY    
                    124         INC LCOUNT          ;NO, COUNT SECTORS MISSED               
                    125 <i><a name="NOLAT"      id="NOLAT"      >NOLAT   </i></b>EQU *                                                       
                    126         JMP TRYADR2         ;NOW..GET CORRECT SECTOR..              </span>
                    127     ELSE
                    128     LST ON
3E30:D0 97          129             BNE <a href="#TRYADR2">TRYADR2</a>     ;NO, KEEP TRYING.               ; ^
                    130     FIN
                    131 *
                    132 * HOORAY! WE GOT THE RIGHT SECTOR!
                    133 *
                    134 <b><a name="GOTSECT"    id="GOTSECT"    >GOTSECT     </a></b>EQU *
                    135     LST OFF
                    136     DO DIAGMOD<span style="background-color:#EEE">
                    137         LDA #SP             ;SAY 'NO LATENCY'                   
                    138         STA TL5                                                 
                    139         INC SCOUNT          ;BUMP 'SECTORS-ACCESSED' COUNT      </span>
                    140     FIN
                    141     LST ON
3E32:28             142             PLP
3E33:90 1C          143             BCC <a href="#WRIT">WRIT</a>        ;CARRY WAS SET FOR READ OPERATION. ; v
                    144     LST OFF
                    145     DO DIAGMOD<span style="background-color:#EEE">
                    146         LDA #TC9            ;SAY 'READING'                  
                    147         STA TL9                                             
                    148         LDA #SP                                             
                    149         STA TL10                                            </span>
                    150     FIN
                    151     LST ON
3E35:20 DC 38       152             JSR <a href="#READ16">READ16</a>      ;CLEARED FOR WRITE
                    153     LST OFF
                    154     DO DIAGMOD<span style="background-color:#EEE">
                    155         LDA #SP                                             
                    156         STA TL9                                             </span>
                    157     FIN
                    158     LST ON
3E38:08             159             PHP             ;SAVE STATUS OF READ OPERATION
                    160     LST OFF
                    161     DO DIAGMOD<span style="background-color:#EEE">
                    162         BCC GOODREAD        ;NO ERROR                       
                    163         LDA #TC10           ;SAY 'READ ERROR'               
                    164         STA TL10                                            
                    165         JMP TRYADR2         ;RETRY ON ERROR                 
                    166 *                                                           
                    167 GOODREAD EQU *                                              </span>
                    168     ELSE
                    169     LST ON
3E39:B0 8E          170             BCS <a href="#TRYADR2">TRYADR2</a>     ;CARRY SET UPON RETURN IF BAD READ ;  ^
                    171     FIN
3E3B:28             172             PLP             ;CAREFUL OF STACK
3E3C:A2 00          173             LDX #0          ;SET TO POSTNIBLIZE
3E3E:86 26          174             STX T0          ; All 256 BYTES OF THE SECTOR
                    175     LST OFF
                    176     DO DIAGMOD<span style="background-color:#EEE">
                    177         LDA #TC11           ;SAY 'POSTINIBBLIZING'          </span>;POST_IN_NIBBLIZING<span style="background-color:#EEE">
                    178         STA TL11                                            </span>
<hr>                    179     FIN                                                     ; === Page <span id="page">125</span> ===
                    180     LST ON
3E40:20 C2 38       181             JSR <a href="#POSTNB16">POSTNB16</a>    ;DECODE INTO REAL WORLD DATA
                    182     LST OFF
                    183     DO DIAGMOD<span style="background-color:#EEE">
                    184         LDA #SP             ;POSTNIB COMPLETED              
                    185         STA TL11                                            </span>
                    186     FIN
                    187     LST ON
3E43:AE F8 05       188             LDX SLOT        ;RESTORE SLOTNUM INTO X         ; I never would have guessed ...
3E46:18             189 <b><a name="ALLDONE"    id="ALLDONE"    >ALLDONE     </a></b>CLC
3E47:24             190             DFB $24         ;SKIP OVER NEXT BYTE WITH BIT OPCODE        ; BIT $zp
3E48:38             191 <b><a name="HNDLERR"    id="HNDLERR"    >HNDLERR     </a></b>SEC             ;INDICATE AN ERROR
3E49:A0 0D          192             LDY #$0D        ;GIVE HIM ERROR#                ; IOB_OFFSET_ERROR = $D
3E4B:91 48          193             STA (IOBPL),Y
3E4D:BD 88 C0       194             LDA MOTOROFF,X  ; TURN IT OFF...
                    195     LST OFF
                    196     DO DIAGMOD<span style="background-color:#EEE">
                    197 * AVERAGE LATENCY = LCOUNT/SCOUNT                           
                    198         LDA LCOUNT          ; GET TOTAL LATENCY             
                    199         LDY #0              ; CLEAR QUOTIENT                
                    200 <i><a name="DIVIDE" id="DIVIDE" >DIVIDE  </a></i>EQU *                                               
                    201         CMP SCOUNT          ; DONE?                         
                    202         BCC <a href="#PRTLAT"   >PRTLAT</a>          ; =&gt;YES.PRINT IT                
                    203         SBC SCOUNT          ; REMOVE SCOUNT                 
                    204         INY                 ; INCREMENT QUOTIENT            
                    205         BNE <a href="#DIVIDE">DIVIDE</a>                                          
                    206 *                                                           
                    207 <i><a name="PRTLAT" id="PRTLAD">PRTLAT</a></i>  TYA                                                 </span>; Print Latency<span style="background-color:#EEE">
                    208         AND #$0F            ; MAX LATENCY=15                
                    209         ORA #$B0            ; MAKE ASCII                    </span>; No, this is make Apple Text, as ASCII = $00..$7F<span style="background-color:#EEE">
                    210         CMP #$BA            ; IS IT A-F                     
                    211         BCC <a href="#PRTL2" >PRTL2</a>           ;=&gt;NO                           
                    212         ADC #6              ;ADD 7 (INCLUDES CARRY)         
                    213 <i><a name="PRTL2" id="PRTL2">PRTL2</a></i>   STA TL12            ; STUFF LATENCY COUNT           
                    214         LDA #SP             ; SAY 'RWTS NOT ACTIVE'         
                    215         STA TL1                                             </span>
                    216     FIN
                    217     LST ON
3E50:60             218             RTS
                    219 <b><a name="WRIT"       id="WRIT"       >WRIT        </a></b>EQU *
                    220     LST OFF
                    221     DO DIAGMOD<span style="background-color:#EEE">
                    222        LDA #TC8             ; SAY 'WRITING'                 
                    223        STA TL8                                              </span>
                    224     FIN
                    225     LST ON
3E51:20 2A 38       226             JSR <a href="#WRITE16">WRITE16</a>     ; WRITE NYBBLES NOW             ; ^ WRITRTN, page 137

                    227     LST OFF
                    228     DO DIAGMOD<span style="background-color:#EEE">
                    229        LDA #SP              ; SAY 'WRITING'                 
                    230        STA TL8                                              </span>
                    231     FIN
                    232     LST ON
3E54:90 F0          233             BCC <a href="#ALLDONE">ALLDONE</a>     ;IF NO ERRORS.
3E56:A9 10          234             LDA #IBWPER     ;DISK IS WRITE PROTECTED!!
3E58:B0 EE          235             BCS <a href="#HNDLERR">HNDLERR</a>     ;ALWAYS TAKEN
                    236 *
                    237 * THIS IS THE 'SEEK' ROUTINE
                    238 *  SEEKS TRACK 'N' IN SLOT #X/$10
                    239 * IF DRIVNO IS NEGATIVE, ON DRIVE 1
                    240 * IF DRIVNO IS POSITIVE, ON DRIVE 2
                    241 *
<hr>3E5A:48             242 <b><a name="MYSEEK"     id="MYSEEK"     >MYSEEK      </a></b>PHA             ; AND PRESERVE A-REGISTER       ; === Page <span id="page">126</span> === Uhm, OK, Captain Obvious
                    243     LST OFF

                    2??     LST ON


3E86:10 03          275             BPL <a href="#GOSEEK">GOSEEK</a>      ;ALWAYS TAKEN
3E88:99 78 04       276 <b><a name="ISDRV1"     id="ISDRV1"     >ISDRV1      </a></b>STA DRV1TRK,Y
3E8B:4C A0 B9       277 <b><a name="GOSEEK"     id="GOSEEK"     >GOSEEK      </a></b>JMP <a href="#SEEK">SEEK</a>        ;GO THERE!
3E8E:8A             278 <b><a name="XTOY"       id="XTOY"       >XTOY        </a></b>TXA
3E8F:4A             279             LSR A
3E90:4A             280             LSR A
3E91:4A             281             LSR A
3E92:4A             282             LSR A
3E93:A8             283             TAY
3E94:60             284             RTS
                    285 *
                    286 * THIS SUBROUTINE SETS THE SLOT DEPENDENT TRACK
                    287 * LOCATION.
                    288 *
3E95:48             289 <b><a name="SETTRK"     id="SETTRK"     >SETTRK      </a></b>PHA             ;PRESERVE DESTINATION TRACK
3E96:A0 02          290             LDY #$02                                        ; *sigh* IOB_OFFSET_DRIVE = $2
3E98:B1 48          291             LDA (IOBPL),Y
3E9A:6A             292             ROR A           ;GET DRIVE # INTO CARRY
3E9B:66 35          293             ROR DRIVNO      ;INTO (DRIVNO)
3E9D:20 8E 3E       294             JSR <a href="#XTOY">XTOY</a>        ;SET UP Y-REG
3EA0:68             295             PLA
3EA1:0A             296             ASL A           ;ASSUME TRACK IS HELD*2
3EA2:24 35          297 SETTRK2     BIT DRIVNO                                      ; unused label
3EA4:30 05          298             BMI <a href="#ONDRV1">ONDRV1</a>      ;IF ON DRIVE 1(1), DRIVNO MINUS
3EA6:99 F8 04       299             STA DRV2TRK,Y
3EA9:10 03          300             BPL <a href="#SETRTS">SETRTS</a>
3EAB:99 78 04       301 <b><a name="ONDRV1"     id="ONDRV1"     >ONDRV1      </a></b>STA DRV1TRK,Y
3EAE:60             302 <b><a name="SETRTS"     id="SETRTS"     >SETRTS      </a></b>RTS

<hr>; === <b class="file"><a name="FORMATR">FORMATR</a></b> - Format Disk, Page <span id="page">82</span>, <b class="ts">T?$?</b>, $<b>????</b> ===<hr>
                    001                SBTL '16-SECTOR FORMATTER'
                    002 ****************************
                    003 *                          *
                    004 * FORMAT DISK AND RETURN   *
                    005 *                          *
                    006 ****************************
                    007 *
                    008 * EQUATES FOR FORMATTER
                    009 *
                    010 NSYNC       EQU $45         ;NUM GAP SELF-SYNC NIBLS
                    011 *
                    012             REP 40
                    013 DSKFORM     EQU *
                    014     DO DIAGMOD              ;ELIMINATE FMTR FROM DIAG ASSEMBLY<span class="macro">
                    015         LST OFF                                             </span>
                    016     ELSE
                    017             LDY #3                                          ; IOB_OFFSET_VOL = 3
                    018             STY (IOBPL),Y   VOLUME NUMBER IN IOB.
                    019             STA NVOL        FOR FORMATTER.
                    020             LDA #$AA        SET Z-PAG LOC TO $AA FOR
                    021             STA AA          TIME DEPENDENT REFERENCES.
                    022             LDY #$56
                    023             LDA #0
                    024             STA TRK         TRACK NUMBER, 0 TO 34
                    025             STA NBUF2-1,Y   CLEAR NBUFS TO WRITE

????:
????:AD 88 C0                   LDA MOTOROFF,X  ; TURN MOTOR OFF.
????:60                         RTS             ; AND RETURN.
                                PAGE
                    WTRACK16    LDA #0
******************************
*                            *
*   WRITE TRACK SUBROUTINE   *
*                            *
******************************

*****************************
*                           *
* VERIFY ROUTINE *
*                           *
* VERIFIES THAT THE FIRST *
* SECTOR ENCOUNTERED IS *
* SECTOR 0, AND THAT ALL *
* 16 SECTORS ARE READABLE *
* WITH MINIMAL RETRIES. *
* (2 REVOLUTIONS MAXIMUM) *
*                           *
* IF FIRST SECTOR IS NOT *
* SECTOR 0 THEN THE *
* CURRENT NUMBER OF SELF- *
* SYNC NIBLS IS DECR'D BY *
* 1 (IF ALREADY LESS THAN *
* 16)ORBY2.THENSECTOR*
* 15ISLOCATEDSOASTO *
* POSITION THE NEW TRACK *
* REWRITE. *
*                           *
* IF UNABLE TO READ ANY *
* SECTOR THEN THE ENTIRE *
* TRACK IS REWRITTEN. *
*                           *
* AFTER VERIFYING TRACK 0, *
* THE NUMBER OF SELF-SYNC *
* NIBLS, NSYNC, IS DECR'D *
* BY2(IFSTILL16OR *
* GREATER). *
*                           *
*****************************

<hr>; === <b class="file"><a name="DOSPTCH">DOSPTCH</a></b> - Revision B Patches, Page <span id="page">52</span>, <b class="ts">T?$?</b> @ ?, $<b>####</b> ===<hr>
                    001             SBTL "DOS PATCHES"
                    002 ********************************
                    003 *
                    004 * DOS 3.2 PATCHES BY DICK HUSTON
                    005 * ********************************
                    006 * AFTER THE FACT PATCHES
                    007 * CLRBYTE CALLED FROM DOS2 LABEL SOPTS +7 LINES
                    008 * CLRSTS1 CALLED FROM DOS3 LABEL ERROR +2 LINES
                    009 * ERROR9X CALLED FROM DOS5 LABEL ERROR9*
                    010 *
                    011 *
                    012             REP 40
                    013 *
                    014 * DOS 3.3 REVISION B PATCH
                    015 *
                    016             REP 40
                    017 *****************************
                    018 SDP1 EQU *<span class="todo">TODO</span>

<hr><hr>
</pre>

<h1>Symbols (Alphabetical)</h1>
<pre>
    DBVECT      = $1E51
    DELTA       = $1C7F

    NEPAGE      = $1C7D

    SC1         = $1D84
    EC1         = $2884
    SC2         = $2AFD
    EC2         = $3397
    SC3         = $365D
    EC3         = $37E0
    SWADR1      = $3C56
    EWADR1      = $3CDF

    SAT1        = $1D00
    EAT1        = $1D56
    RUN         = $1D58
    IBVT        = $1D62

    RSPAGE      = $1C7A

    PRENIB16    = $B800
    ZPGFCB      =   $42
    ZPGWRK      =   $40


</pre>

<h1>Symbols (Address)</h1>

<pre>
</pre>

Apple ][ Forever!

</body>
</html>

<!--

Well aren't you a curious hacker!

Here's a trick to boot from Drive 2 :-)
NOTE: You'll need a DOS that isn't brain dead.

; Apple //e
9600<C600.C700M
9636:8B
9600G

; Apple //c
9600<C600.C700M
96xx:
9600G

-->
