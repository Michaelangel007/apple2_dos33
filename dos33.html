<!DOCTYPE html>
<!--
<span class="todo">TODO</span> add fixed header on scroll for filenames
<a name="BEGIN"      id="BEGIN"      >BEGIN       </a>
                        25          37              53                              85  89  93
####:## ## ##       ### LABEL       NMEMONIC        COMMENT                         ; Annotation
Page
     10  20  30  40  50  60  70  80  90 100 110 120 130 140 150
  1  11  21  31  41  51  61  71  81  91 101 111 121 131 141 151
  2  12  22  32  42  52  62  72  82  92 102 112 122 132 142 152
  3  13  23  33  43  53  63  73  83  93 103 113 123 133 143 153
  4  14  24  34  44  54  64  74  84  94 104 114 124 134 144 154
  5  15  25  35  45  55  65  75  85  95 105 115 125 135 145 155
  6  16  26  36  46  56  66  76  86  96 106 116 126 136 146 156
  7  17  27  37  47  57  67  77  87  97 107 117 127 137 147 157
  8  18  28  38  48  58  68  78  88  98 108 118 128 138 148 158
  9  19  29  39  49  59  69  79  89  99 109 119 129 139 149 159

                    001 
                    002 
                    003 
                    004 
                    005 
                    006 
                    007 
                    008 
                    009 
                    010 
                    011 
                    012 
                    013 
                    014 
                    015 
                    016 
                    017 
                    018 
                    019 
                    020 
                    021 
                    022 
                    023 
                    024 
                    025 
                    026 
                    027 
                    028 
                    029 
                    030 
                    031 
                    032 
                    033 
                    034 
                    035 
                    036 
                    037 
                    038 
                    039 
                    040 
                    041 
                    042 
                    043 
                    044 
                    045 
                    046 
                    047 
                    048 
                    049 
                    050 
                    051 
                    052 
                    053 
                    054 
                    055 
                    056 
                    057 
                    058 
                    059 
                    060 
                    061 
                    062 
                    063 
                    064 
                    065 
                    066 
                    067 
                    068 
                    069 
                    070 
                    071 
                    072 
                    073 
                    074 
                    075 
                    076 
                    077 
                    078 
                    079 

                    080 
                    081 
                    082 
                    083 
                    084 
                    085 
                    086 
                    087 
                    088 
                    089 

                    090 
                    091 
                    092 
                    093 
                    094 
                    095 
                    096 
                    097 
                    098 
                    099 

                    100 
                    101 
                    102 
                    103 
                    104 
                    105 
                    106 
                    107 
                    108 
                    109 

                    100 
                    101 
                    102 
                    103 
                    104 
                    105 
                    106 
                    107 
                    108 
                    109 

                    110 
                    111 
                    112 
                    113 
                    114 
                    115 
                    116 
                    117 
                    118 
                    119 

                    120 
                    121 
                    122 
                    123 
                    124 
                    125 
                    126 
                    127 
                    128 
                    129 

                    130 
                    131 
                    132 
                    133 
                    134 
                    135 
                    136 
                    137 
                    138 
                    139 
-->
<html>
<title>Apple DOS 3.3C Source Code (HTML Version)</title>
<head>
    <style>

span.b { color: #080; font-weight: bold;  } /* Original bold   green */
span.i { color: #00F; font-style: italic; } /* Original italic blue  */

/* Bold = Blue */
b {
    color: #00F; /* -- old: 080 */
}

/* Italic = Green */
i {
    color: #080; /* 00F */
}
a {
    color: #F0F; /* Should never see purple -- means link wasn't marked up propery */
    /* background-color:#F0F; */
}
/*
    There are 4 lights, er, links!

    f FUNC definition: Foo EQU *
    x FUNC reference:      JSR Foo
    d VAR  definition: Bar DFB 0
    v VAR  reference       LDA Bar

*/
a.f { /* func name definition LABEL */
    color          : #46F  ; /* blue (baby blue) */
    text-decoration: none  ; /* remove underlink from func link */
    font-weight    : bold  ; /* default to bold for function names */
}
a.x { /* func name reference TARGET /
    color          : #24f  ; /* dark blue */
    text-decoration: none  ; /* remove underlink from data link */
    font-weight    : normal; /* remove bold */
}
a.d { /* var name definition LABEL*/
    color          : #080  ; /* green */
    text-decoration: none  ; /* remove underlink from data link */
    font-weight    : bold  ; /* make bold */
 /* font-style     : italic; /* optional italic for data */
}
a.v { /* var name reference OPERAND */
    color          : #040  ; /* dark green */
    text-decoration: none  ; /* remove underlink from data link */
    font-weight    : normal; /* remove bold */
}
/*
Misc.
 - can't use '$' in css name *
 - http://stackoverflow.com/questions/448981/which-characters-are-valid-in-css-class-names-selectors 
*/
a.dumb { /* How Not To Design a File System */
    color: #808; /* purple */
}
a.file {
    color: #F00;           /* FILE = Red */
    text-decoration: none; /* remove underlink from data link */
    font-weight: normal;   /* remove bold */
}
/* Link to Macro Definition */
a.macro {
    color: #F00;           /* macro link = Red */
    text-decoration: none; /* remove underlink from data link */
    font-weight: normal;   /* remove bold */
}
/* Link to Macro Label */
a.name {
    color: #444;
    font-style: italic;
}
h1 {
    font-size: 200%;
}
h1 {
    font-size: 150%;
}
/* Dec, Hex, Number, Memory Address */
b.adr {
    color: #F80;
}
b.file {
    color: #F00; /* filenames in red */
}
/* Track/Sector */
b.ts {
    color: #F00;
}


/*
# after an hr there is a line of whitespace
    <div class="hr"><hr></div>
Solution: place <hr> on same line
*/
hr {
/*
#    padding: 0px;
#    margin:  0px;
#    margin-top:-1em
*/
}

span.adr {
    color: #F80;
    font-weight: bold;
}
span.line {
    color: #080;
}
span.page {
    color: #080;
}
span.macro {
    background-color:#EEE;
}
span.patch {
    background-color:#EEC;
}
span.todo {
    background-color:#FF0;
}
    </style>
</head>
<body>

<h1>Apple DOS 3.3C Source Code (HTML Version)</h1>
<br>Transcribed by Michael Pohoreski.
<br>Latest version on my GitHub: <a href="http://htmlpreview.github.com/?https://github.com/Michaelangel007/apple2_dos33/blob/master/dos33.html">dos33.html</a>
<p>
The <span class="i">intent</span> of providing this copyrighted source code is
 as a convenience for the curious as a <span class="b">means to learn</span> --
 such as especially how <span class="b">NOT</b> to design a Operating / Disk / File System</span>
 (look for all my <span class="b">*sigh*</span> comments and
 <b><a href="#HNTDAFS1">HNTDAFS</a></b> (How Not to Design a File System), but as they say,
 <span class="i">"Hindsight is 20/20."</span>
<p>
<span class="b">DISCLAIMER:</span> <span class="i">YOU MAY NOT USE THIS FOR
 COMMERCIAL GAIN else you face risking the wrath of Apple's lawyers.</span>
 Since Apple <span class="i">has already previously released this source code</span>
 I'm assuming it is OK since I'm not presenting anything new
 (well, OK, my commentary, but you get the point.)
<p>
Numerous improvements have been made over the original source code listings:
<p>
<ul>
  <li>Hyperlinks to all labels,                                       </li>
  <li>Load address and opcodes,                                       </li>
  <li>Added line numbers,                                             </li>
  <li>Cleaned up sloppy vertical alignment (such as (#) clock cycles),</li>
  <li>Added annotation column,                                        </li>
  <li>Unindented and color-coded macro sections so they stand out, and</li>
  <li>Single page                                                     </li>
</ul>
<p>

Header Format is:

<pre>
; === <b class="file">FILENAME</b> - Description, Page <span class="page">#</span>, <b class="ts">Track/Sector</b> @ $offset, $<b class="adr">####</b> (Relocated Address in high memory) ===
</pre>

Line format is:

<pre>
Addr:## ## ##       L## LABEL       MNEMONIC        COMMENT                         Annotation
</pre>

<b>Legend:</b>
<p>
<div style="padding-left:5%">
<table border="1" style="border-width: 1px; border-collapse: collapse" >
    <tr>
        <td>Addr</td>
        <td>Address at assemble time</td>
    </tr>
    <tr>
        <td>## ## ##</td>
        <td>Opcode(s)</td>
    </tr>
    <tr>
        <td>L##</td>
        <td>Line number of source file</td>
    </tr>
    <tr>
        <td>LABEL</td>
        <td>Function name, or branch target name<br><b>Function</b><br><i>Data</i></td>
    </tr>
    <tr>
        <td>MNEMONIC</td>
        <td>Assembly language instruction</td>
    </tr>
    <tr>
        <td>COMMENT</td>
        <td>Official comment</td>
    </tr>
    <tr>
        <td>Annotation</td>
        <td>Modern commentary by me</td>
    </tr>
</table>
</div>


<pre>

; === <b class="file">DOS33C</b> - Master Source File, Page <span class="page">39</span> ===

                    001             SBTL "DOS3.3C w/APPEND fix, U/L case"
                    002             LST  ON,VSYM
                    003             MSB  OFF
                    004 ORIGIN      EQU  $1B00
                    005 <a class="macro" name="DIAGMOD">DIAGMOD     </a>EQU  0
                    006 <a class="macro" name="DOS33B" >DOS33B      </a>EQU  1
                    007 <a class="macro" name="ULC"    >ULC         </a>EQU  0
                    008             INCLUDE <a href="#RELOCTR">RELOCTR</a>,,2                              ; $1B00 .. $####
                    009             INCLUDE <a href="#DOSINIT">DOSINIT</a>,,2                              ; $#### .. $####
                    010             INCLUDE <a href="#DOSHOOK">DOSHOOK</a>,,2                              ; $#### .. $####
                    011             INCLUDE <a href="#CMDSCAN">CMDSCAN</a>,,2                              ; $#### .. $####
                    012             INCLUDE <a href="#XOPNCLS">XOPNCLS</a>,,2                              ; $#### .. $####
                    013             INCLUDE <a href="#XLODSAV">XLODSAV</a>,,2                              ; $#### .. $####
                    014             INCLUDE <a href="#XMISCMD">XMISCMD</a>,,2
                    015             INCLUDE <a href="#DOSGOER">DOSGOER</a>,,2
                    016             INCLUDE <a href="#BLDFTAB">BLDFTAB</a>,,2                              ; Page   4, Lines 144, $#### .. $####
                    017             INCLUDE <a href="#CMDTBLS">CMDTBLS</a>,,2
                    018             INCLUDE <a href="#FDOSENT">FDOSENT</a>,,2
                    019             INCLUDE <a href="#FOPCLRW">FOPCLRW</a>,,2
                    020             INCLUDE <a href="#FDELCAT">FDELCAT</a>,,2
                    021             INCLUDE <a href="#FMTRWIO">FMTRWIO</a>,,2
                    022             INCLUDE <a href="#FLOCNXB">FLOCNXB</a>,,2
                    023             INCLUDE <a href="#FLOCSEC">FLOCSEC</a>,,2
                    024             INCLUDE <a href="#FVCBUFS">FVCBUFS</a>,,2
                    025             INLUCDE <a href="#BOOTLDR">BOOTLDR</a>,,2                              ; $3600 .. $36FF
                    026             INCLUDE <a href="#COREQUS">COREQUS</a>,,1
                    027             INCLUDE <a href="#PRENIBL">PRENIBL</a>,,1
                    028             INCLUDE <a href="#WRITRTN">WRITRTN</a>,,1
                    029             INCLUDE <a href="#POSTNRD">POSTNRD</a>,,1
                    030             INCLDUE <a href="#RDADSEK">RDADSEK</a>,,1
                    031             INCLUDE <a href="#MSWAITR">MSWAITR</a>,,1                              ; $3A00 .. $3Cxx, T0$4 - T0$6
                    032             INCLUDE <a href="#WRITADR">WRITADR</a>,,1
                    033             INCLUDE <a href="#RWTSONE">RWTSONE</a>,,1
                    034             INCLUDE <a href="#RWTSTWO">RWTSTWO</a>,,1
                    035             INCLUDE <a href="#FORMATR">FORMATR</a>,,1       ; $3EAF .. $3FC7
                    036             INCLUDE <a href="#DOSPTCH">DOSPTCH</a>,,1       ; $3FC8 .. $3FFF


<hr>; === <a class="file" name="RELOCTR">RELOCTR</a> - Relocate DOS to high (48K) memory, Page <span class="page">110</span>, <b class="ts">T0$A</b>, $<span class="adr">1B00</span> ===<hr>
                    001             PAGE
                    002 *****************************************************
                    003 *                                                   *
                    004 * (C) COPYRIGHT 1978,1980,1982 APPLE COMPUTER, INC. *
                    005 *                                                   *
                    006 *****************************************************
                    007             SKP 2
                    008 *********************************
                    009 *                               *
                    010 *  ADAPTED FOR MACRO EDASM BY   *
                    011 *        JOHN ARKLEY            *
                    012 *         DEC 1980              *
                    013 *                               *
                    014 *********************************
                    015             SKP 2
                    016 *********************************
                    017 *                               *
                    018 *  DOS 3.3 REVISION B PATCHES   *
                    019 *   INSTALLED BY MARK HOUDE     *
                    020 *          JUL 1982             *
                    021 *                               *
                    022 *********************************
                    023             SKP 2
                    024 *********************************
                    025 *                               *
                    026 *  DOS 3.3 REV B PATCHES VER 2  *
                    027 *   INSTALLED BY FERN BACHMAN   *
                    028 *          SEP 1982             *
                    029 *                               *
                    030 *********************************
                    031             SKP 2
                    032 *********************************
                    033 *                               *
                    034 *    DOS33C PATCHES (APPEND &amp;   *
                    035 *     UPPER/LOWER CASE CHECK)   *
                    036 *                               *
                    037 *            BY                 *
                    038 *        GUIL  BANKS            *
                    039 *         1983                  *
                    040 *                               *
                    041 *********************************
                    042 ;
                    043 ;EQUATES REQD TO FIND THINGS IN APPLE II
                    044 ;
                    045 <a class="f" name="SETVID" >SETVID      </a>EQU $FE93
                    046 <a class="f" name="SETKBD" >SETKBD      </a>EQU $FE89
                    047 <a class="d" name="PROMPT" >PROMPT      </a>EQU $33         ; PROMPT CHAR
                    048 <a class="d" name="OUTSW"  >OUTSW       </a>EQU $36         ; OUTPUT VECTOR SWITCH
                    049 <a class="d" name="INSW"   >INSW        </a>EQU $38         ; INPUT VECTOR SWITCH
                    050 <a class="d" name="ZPGWRK" >ZPGWRK      </a>EQU $40         ; ZERO PAGE WORK CELL
                    051 <a class="d" name="CNUM"   >CNUM        </a>EQU $44         ; CONVERTED NUMERIC
                    052 <a class="d" name="LBUFF"  >LBUFF       </a>EQU $200        ; LINE BUFFER                   ; Keyboard buffer of 255 chars
                    053 <a class="f" name="MULT"   >MULT        </a>EQU $FB63       ; MULT ROUTINE
<hr>                    054 INPRT       EQU $FE8B       ; SET IN PORT                   ; === Page <span class="page">111</span> ===
                    055 OUTPRT      EQU $FE95       ; SET OUT PORT
                    056 IBCHN       EQU $E836       ; BASIC RUN                     ; Integer Basic
                    057 IBLMEM      EQU $4A         ; BASIC LOW MEM                 ; Integer Basic
                    058 IBHMEM      EQU $4C         ; INTEGER BASIC HIMEM           ; Integer Basic
                    059 IBSOP       EQU $CA         ; INTEGER BASIC START OF CGM    ; Integer Basic CGM ???
                    060 IBBRK       EQU $E3E3       ; BASIC BREAK                   ; Integer Basic
                    061 IBGO        EQU $E000       ; BASIC ENTRY POINT             ; Integer Basic
                    062 IBCONT      EQU $E003       ; BASIC CONTINUE ENTRY POINT    ; Integer Basic
                    063 IBSOV       EQU $CC         ; BASIC START OF VARIABLES      ; Integer Basic
                    064 ASSOP       EQU $67         ; AS START OF PROGRAM           ; Applesoft Basic
                    065 ASEOP       EQU $AF         ; AS END OF PROGRAM             ; Applesoft Basic
                    066 ASEOP2      EQU $69         ; AS END-OF PGM 2               ; Applesoft Basic
                    067 ASHM1       EQU $73         ; AS HIGH MEM 1                 ; Applesoft Basic
                    068 ASHM2       EQU $6F         ; AS HIGH MEM 2                 ; Applesoft Basic
                    069 ASRNX       EQU $D6         ; AS RUN-ONLY FLAG              ; Applesoft Basic
                    070 <a class="d" name="ASONERR">ASONERR</a>     EQU $D8         ; AS ON-ERR GOTO FLAG           ; Applesoft Basic
                    071 ASLMEM      EQU ASSOP       ; AS LOW MEM                    ; Applesoft Basic
                    072 ASBRK1      EQU $D865       ; AS ROM BREAK                  ; Applesoft Basic
                    073 ASBRK2      EQU $1067       ; AS RAM BREAK                  ; Applesoft Basic
                    074 ASCNTU1     EQU $D43C
                    075 ASCNTU2     EQU $C3C
                    076 ASRSEQ1     EQU $D4F2
                    077 ASRSEQ2     EQU $CF2
                    078 <a class="x" name="AITSTL" >AITSTL      </a>EQU $E000       ; AS 1 IB TEST LOC              ; Applesoft Basic E000: JMP $F128
                    079 <a class="d" name="ATSTV"  >ATSTV       </a>EQU $4C         ; AS TEST VALUE                 ; Applesoft Basic
                    080 <a class="d" name="ITSTV"  >ITSTV       </a>EQU $20         ; IB TEST VALUE                 ; Integer Basic
                    081 <a class="d" name="BOOTSL" >BOOTSL      </a>EQU $2E         ; BOOT FROM SLOT                ; Slot from Boot
                    082 <a class="d" name="ZPGFCB" >ZPGFCB      </a>EQU $42         ; ZERO PAGE WORK CELL           ; File Control Block
                    083 <a class="x" name="MONRST" >MONRST      </a>EQU $FF65       ; MONITOR RESET ENTRY
                    084 <a class="x" name="MONBRK" >MONBRK      </a>EQU $FA59       ; MONITOR BREAK ENTRY
                    085 <a class="x" name="IORTS"  >IORTS       </a>EQU $FF58       ; KNOWN RTS IN MONITOR ROM
                    086 <a class="x" name="HOME"   >HOME        </a>EQU $FC58                                       ; Clear the text screen
                    087 <a class="x" name="PRINT"  >PRINT       </a>EQU $FDED                                       ; putchar()
                    088 <a class="x" name="GETKEY" >GETKEY      </a>EQU $FD0C
                    089 <a class="x" name="INSDS2" >INSDS2      </a>EQU $F88E                                       ; Instruction Disassembly Opcode Length
                    090 <a class="d" name="LENGTH" >LENGTH      </a>EQU $2F
                    091 <a class="d" name="ZRSET"  >ZRSET       </a>EQU $3F2        ; NEW MONITOR ROM RESET VECTOR
                    092 <a class="d" name="PWCNST" >PWCNST      </a>EQU $3F4        ; NEW MONITOR ROM POWER UP CONSTANT
                    093                 REP 40
                    094 *
                    095 *
                    096             ORG ORIGIN
                    097 *
                    098 *
                    099             REP 40
                    100             PAGE
1B00:4C 84 1D       101 <a class="f" name="BEGIN"   >BEGIN       </a>JMP <a class="x" href="#DBINIT">DBINIT</a>                                      ; === DOS loads @ $1B00 ===
                    102 ;                                                           ; Loaded in at $38D4
                    103 <a class="f" name="DOSREL"  >DOSREL      </a>EQU *                                           ; Called from BOOTLDR, page 12, line # TODO:
                    104 ;
                    105 ; GET RELOCATION PARMS
                    106 ;
                    107 <a class="f" name="DR0"     >DR0         </a>EQU *
                    108 <a class="d" name="LOC1"    >LOC1        </a>EQU $26
1B03:A9 BF          109             LDA #$BF        ; START AT BF00                 ; Top of 48K
1B05:85 41          110             STA ZPGWRK+1    ; TO LOOK FOR                   ; ZPGWRK = MemTestAdr
1B07:A2 00          111             LDX #<span class="adr">0</span>          ; HIGH RAM
1B09:86 40          112             STX ZPGWRK
1B0B:A0 00          113 <a class="f" name="DR0A"    >DR0A        </a>LDY #<span class="adr">0</span>          ; APPLE TEST
                    114 <a class="f" name="DR1B"    >DR1B        </a>EQU *                                           ; unused label
1B0D:A1 40          115             LDA (ZPGWRK,X)
1B0F:85 26          116             STA LOC1                                        ; LOC1 = MemTestVal
<hr>1B11:98             117 <a class="f" name="DR1"         >DR1         </a>TYA                                             ; === Page <span class="page">112</span> ===
1B12:45 26          118             EOR LOC1
1B14:85 26          119             STA LOC1
1B16:98             120             TYA
1B17:41 40          121             EOR (ZPGWRK,X)
1B19:81 40          122             STA (ZPGWRK,X)
1B1B:C5 26          123             CMP LOC1
1B1D:D0 05          124             BNE <a class="x" href="#DR1A" >DR1A</a>                                        ; v
1B1F:C8             125             INY
1B20:D0 EF          126             BNE <a class="x" href="#DR1"  >DR1</a>                                         ; ^
1B22:F0 04          127             BEQ <a class="x" href="#DR2"  >DR2</a>         ; BR IF TOOK                    ; v
                    128 <a class="f" name="DR1A"        >DR1A        </a>EQU *
1B24:C6 41          129             DEC ZPGWRK+1    ; NOT RAM
1B26:D0 E3          130             BNE <a class="x" href="#DR0A" >DR0A</a>        ; TRY NEXT PAGE                 ; ^
                    131 ;
                    132 <a class="f" name="DR2"         >DR2         </a>EQU *
                    133 ;
1B28:A5 41          134             LDA <a class="d" href="#ZPGWRK" >ZPGWRK</a>+1    ;BEGIN PATCH TO INSURE   *****  ; note: '*****' is BEGIN_PATCH
1B2A:29 DF          135             AND #$<span class="adr">DF</span>        ; PROPER HIGH MEMORY CHECK.
1B2C:85 43          136             STA <a class="d" href="#ZPGFCB" >ZPGFCB</a>+1    ;(DOS MASTER 3.1 CONTAINS
1B2E:86 42          137             STX <a class="d" href="#ZPGFCB" >ZPGFCB</a>      ; THIS ROUTINE STARTING AT LOCATION
1B30:A1 42          138             LDA (<a class="d" href="#ZPGFCB">ZPGFCB</a>,X)  ; $3540)
1B32:48             139             PHA
1B33:85 26          140             STA <a class="d" href=#LOC1">LOC1</a>        ;SAVE TEST VALUE
1B35:98             141 <a class="f" name="DR2A"        >DR2A        </a>TYA             ;(FIRST TIME Y=0)
1B36:45 26          142             EOR <a class="d" href="#LOC1"   >LOC1</a>        ;TEST EACH (ALLEDGED) MEMORY BYTE
1B38:85 26          143             STA <a class="d" href="#LOC1"   >LOC1</a>        ; 256 TIMES TO DETERMINE IF
1B3A:98             144             TYA             ; IT IS REALLY GOOD MEMORY AND
1B3B:41 40          145             EOR (<a class="d" href="#ZPGWRK">ZPGWRK</a>,X)  ; MIRRORED 8K LOWER IN RAM.
1B3D:81 42          146             STA (<a class="d" href="#ZPGFCB">ZPGFCB</a>,X)
1B3F:C5 26          147             CMP <a class="d" href="#LOC1"   >LOC1</a>        ;DID IT PASS THIS TIME?
1B41:D0 09          148             BNE <a class="x" href="#DR2B"   >DR2B</a>        ; BYTE NOT MIRRORED, THEN GOOD MEMORY   ; *sigh* more crap code: S-L-O-W
1B43:C8             149             INY             ;MAYBE IT WAS COINCIDENCE               ; Instead of testing *every* byte (256 times WTF!)
1B44:D0 EF          150             BNE <a class="x" href="#DR2A"   >DR2A</a>        ; BRANCH UNLESS IT'S MATCHED 256 TIMES  ; just test the last byte of every page
1B46:A4 43          151             LDY <a class="d" href="#ZPGFCB" >ZPGFCB</a>+1    ;HIMEM IS 8K LOWER THEN WAS
1B48:68             152             PLA             ;ORIGINALLY THOUGHT!                    ; *sigh* Another wasted byte with JMP
1B49:4C 51 1B       153             JMP <a class="x" href="#DR2C"   >DR2C</a>                                                ; Switch LDY PLA around and BNE instead
1B4C:68             154 <a class="f" name="DR2B"        >DR2B        </a>PLA             ; ORIGINAL HIMEM PROVED GOOD
1B4D:81 42          155             STA (<a class="d" href="#ZPGFCB">ZPGFCB</a>,X)  ;RESTORE BYTE ORIGINALLY MESSED WITH.
1B4F:A4 41          156             LDY <a class="d" href="#ZPGWRK" >ZPGWRK</a>+1    ;END OF PATCH   *****           ; ***** = END_PATCH
1B51:C8             157 <a class="f" name="DR2C"        >DR2C        </a>INY             ; NEW END OF DOS
1B52:8C 7D 1C       158             STY <a class="d" href="#NEPAGE">NEPAGE</a>
1B55:38             159             SEC
1B56:98             160             TYA
1B57:ED 7E 1C       161             SBC <a class="d" href="#DOSLNG">DOSLNG</a>      ; MINUS DOS LENGTH
1B5A:8D 7C 1C       162             STA <a class="d" href="#NSPAGE">NSPAGE</a>      ; IS NEW START OF DOS
1B5D:38             163             SEC
1B5E:ED 7A 1C       164             SBC <a class="d" href="#RSPAGE">RSPAGE</a>      ; MINUS OLD DOS START
1B61:F0 9D          165             BEQ <a class="d" href="#BEGIN" >BEGIN</a>       ; (BREIF NO DELTA)              ; ^ NOT mis-spelling: Branch If
1B63:8D 7F 1C       166             STA <a class="d" href="#DELTA" >DELTA</a>       ; IS DELTA
1B66:AD 7A 1C       167             LDA <a class="d" href="#RSPAGE">RSPAGE</a>      ; RESET START PAGE TO NORMAL
1B69:8D 0D 1D       168             STA <a class="d" href="#ASTART">ASTART</a>+1
                    169 ;
1B6C:A9 1D          170             LDA #&lt;<a class="x" href="#DBINIT">DBINIT</a>    ; RESET PI RTN TO NORMAL        ; PI = ??? <span class="todo">TODO</span>
1B6E:8D 49 37       171             STA <a class="d" href="#DI3">DI3</a>+2
1B71:A9 84          172             LDA #&gt;<a class="x" href="#DBINIT">DBINIT</a>
1B73:8D 48 37       173             STA <a class="d" href="#DI3">DI3</a>+1
                    174 ;
                    175 ;RELOCATE ADR TABLES
                    176 ;
<hr>1B76:A2 00          177             LDX #0                                          ; === Page <span class="page">113</span> ===
1B78:86 40          178             STX ZPGWRK
                    179 <a class="f" name="DR3"         >DR3         </a>EQU *

                    186 <a class="f" name="DR4"         >DR4         </a>EQU *

####:C8             194 <a class="f" name="DR5"         >DR5         </a>INY

                    198 <a class="f" name="DR6"         >DR6         </a>EQU *

                    213 ;
                    214 ;RELOCATE CODE
                    215 ;
1BAF:A2 00          216             LDX #0
1BB1:8E 9C 33       217 <a class="f" name="DR7"         >DR7         </a>STX <a class="d" href="#TEMP1">TEMP1</a>
                    218 ;
1BB4:BD 5A 1C       219             LDA <a class="d" href="#CDETAB">CDETAB</a>+1,X  ; GET A START OF CODE ADR
1BB7:85 40          220             STA <a class="d" href="#ZPGWRK">ZPGWRK</a>      ; PUT IN ZPG
1BB9:BD 5B 1C       221             LDA <a class="d" href="#CDTAB" >CDETAB</a>+2,X
1BBC:85 41          222             STA <a class="d" href="#ZPGWRK">ZPGWRK</a>+1
                    223 ;
1BBE:A2 00          224 <a class="f" name="DR8"         >DR8         </a>LDX #0         ; GET OP CODE
1BC0:A1 40          225             LDA (ZPGWRK,X)  ; GO FIND OUT HOW LONG          ; Interesting hack of using
1BC2:20 8E F8       226             JSR INSDS2                                      ; monitor ROW to get instruction opcode length
                    227 ;
1BC5:A4 2F          228             LDY <a  class="d" href="#LENGTH">LENGTH</a>      ; GET HOW LONG
1BC7:C0 02          229             CPY #<span class="adr">2</span>          ; IF IT AIN'T                   ; *sigh* #3-1 is clearer since zero based
1BC9:D0 11          230             BNE <a  class="x" href="#DR9"   >DR9</a>         ; 3 THEN DON'T RELOC            ; 300:A9 20 20 8E F8 A5 2F 09 30 4C ED FD
1BCB:B1 40          231             LDA (<a class="d" href="#ZPGWRK">ZPGWRK</a>),Y  ; GET PAGE FROM INST
1BCD:CD 7A 1C       232             CMP <a  class="d" href="#RSPAGE">RSPAGE</a>      ; IF PAGE &lt; REL START
1BD0:90 0A          233             BCC <a  class="x" href="#DR9"   >DR9</a>         ; THEN  IGNOR
1BD2:CD 7B 1C       234             CMP <a  class="d" href="#REPAGE">REPAGE</a>      ; IF PAGE &gt;= REL END
1BD5:B0 05          235             BCS <a  class="x" href="#DR9"   >DR9</a>         ; THEN IGNORE
1BD7:6D 7F 1C       236             ADC DELTA       ; ELSE ADD DELTA
1BDA:91 40          237             STA (ZPGWRK),Y  ; TO RELOCATE
                    238 ;
1BDC:38             239 <a class="f" name="DR9"         >DR9         </a>SEC
<hr>1BDD:A5 2F          240             LDA <a class="d" href="#LENGTH">LENGTH</a>      ; ADD LENGTH
1BDF:65 40          241             ADC <a class="d" href="#ZPGWRK">ZPGWRK</a>      ; TO PC
1BE1:95 40          242             STA <a class="d" href="#ZPGWRK">ZPGWRK</a>
1BE3:A9 00          243             LDA #<span class="adr">0</span>
1BE5:65 41          244             ADC <a class="d" href="#ZPGWRK">ZPGWRK</a>+1
1BE7:85 41          245             STA <a class="d" href="#ZPGWRK">ZPGWRK</a>+1
                    246 ;
1BE9:AE 9C 33       247             LDX <a class="d" href="#TEMP1">TEMP1</a>       ; CHECK FOR END
1BEC:DD 5D 1C       248             CMP <a class="d" href="#CDETAB">CDETAB</a>+4,X  ; OF CODE SEGMENT
1BEF:90 CD          249             BCC <a class="x" href="#DR8">DR8</a>         ; BR NOT END
1BF1:A5 40          250             LDA <a class="d" href="#ZPGWRK">ZPGWRK</a>
1BF3:DD 5C 1C       251             CMP <a class="d" href="#CDTAB">CDETAB</a>+3,X
1BF6:90 C6          252             BCC <a class="x" href="#DR8">DR8</a>         ; BR NOT END
                    253 ;
1BF8:8A             254             TXA
1BF9:18             255             CLC
1BFA:69 04          256             ADC #<span class="adr">04</span>         ; INCREMENT TABLE INDEX
1BFC:AA             257             TAX
1BFD:EC 59 1C       258             CPX CDETAB      ; DONE
1C00:90 AF          259             BCC <a class="x" href="#DR7">DR7</a>         ; BR IF NOT                     ; === <b class="ts">T0$B</b> ===
                    260 ;
                    261             PAGE
                    262 ;
                    263 ;MOVE TO RELOCATED CODE
                    264 ;
1C02:A9 3F          265             LDA #&lt;<a href="#ENDOFDOS">ENDOFDOS</a>-$80
1C04:85 41          266             STA ZPGWRK+1    ; ZPGWRK=FROM
1C06:AC 7D 1C       267             LDY <a href="#NEPAGE">NEPAGE</a>
1C09:88             268             DEY
1C0A:84 43          269             STY <a class="d" href="#ZPGFCB">ZPGFCB</a>+1    ; ZPGFCB = TOO
1C0C:A9 00          270             LDA #<span class="adr">0</span>
1C0E:85 40          271             STA <a class="d" href="#ZPGWRK">ZPGWRK</a>
1C10:85 42          272             STA <a class="d" href="#ZPGFCB">ZPGFCB</a>
1C12:A8             273             TAY
                    274 ;
1C13:B1 40          275 <a name="DR10"       id="DR10"       >DR10        </a>LDA (ZPGWRK),Y  ; BYTE FROM
1C15:91 42          276             STA (ZPGFCB),Y  ; BYTE  TO
1C17:C8             277             INY             ; INCREMENT                     ; /sarcasm No shit, Sherlock
1C18:D0 F9          278             BNE <a href="#DR10">DR10</a>        ; BR NOT FULL PAGE
1C1A:CE 80 1C       279             DEC DPGCNT      ; DECREMENT PAGE CNT
1C1D:F0 06          280             BEQ <a href="#DR11">DR11</a>        ; BR IF DONE
1C1F:C6 41          281             DEC ZPGWRK+1    ; INC FROM PAGE
1C21:C6 43          282             DEC ZPGFCB+1    ; INC TOO PAGE
1C23:D0 EE          283             BNE <a href="#DR10">DR10</a>        ; MOVE PAGE
                    284 ;
1C25:4C 54 1E       285 <a name="DR11"       id="DR11"       >DR11        </a>JMP <a href="#DBVECT">DBVECT+3</a>    ; DONE                          ; DOSINIT, Page 51 -&gt; JMP DBINIT
                    286             PAGE
1C28:24             287 <a name="ADRTAB"     id="ADRTAB"     >ADRTAB      </a>DFB 9*4
1C29:00 1D          288             DW  SAT1
1C2B:56 1D          289             DW  EAT1
1C2D:58 1D          290             DW  RUN
1C2F:5A 1D          291             DW  RUN+2
1C31:64 1D          292             DW  IBVT+2
1C33:66 1D          293             DW  IBVT+4
1C35:6C 1D          294             DW  AS1VT
1C37:70 1D          295             DW  AS1VT+4
1C39:78 1D          296             DW  AS2VT
1C3B:7C 1D          297             DW  AS2VT+4
1C3D:7E 1D          298             DW  AS2VT+6
1C3F:80 1D          299             DW  AS2VT+8
1C41:C1 2A          300             DW  SAT2
1C43:FD 2A          301             DW  EAT2
1C45:E4 37          302             DW  BAIOB
<hr>1C47:E8 37          303             DW  ADOSLD+2                                    ; === Page <span class="page">115</span> ===
1C49:EE 37          304             DW  <a class="d" name="IBDCTP">IBDCTP</a>
1C4B:F0 37          305             DW  <a class="d" name="IBDCTP">IBDCTP</a>+2                                    ;
1C4D:00 00 00 00    306             DFB 0,0,0,0
1C51:00 00 00 00    307             DFB 0,0,0,0
1C55:00 00 00 00    308             DFB 0,0,0,0
                    309 <a class="d"    name="CDETAB"     id="CDETAB"     >CDETAB      </a>EQU *
1C59:20             310             DFB 8*4
1C5A:84 1D          311             DW  SC1
1C5C:84 28          312             DW  EC1
1C5E:FD 2A          313             DW  SC2
1C60:97 33          314             DW  EC2
1C62:5D 36          315             DW  SC3
1C64:E0 37          316             DW  EC3
1C66:56 3C          317             DW  SWADR1
1C68:DF 3C          318             DW  EWADR1
1C6A:00 38          319             DW  ASC1
1C6C:11 3A          320             DW  AEC1
1C6E:69 3A          321             DW  PSC1
1C70:94 3A          322             DW  <a href="#PEC1">PEC1</a>
1C72:00 3D          323             DW  ASC2
1C74:A8 3F          324             DW  AEC2
1C76:C8 3F          325             DW  SDP1                                        ; Start Dos Patch
1C78:FF 3F          326             DW  EDP1                                        ; End Dos Patch
1C7A:1D             327 <a class="d" name="RSPAGE"     id="RSPAGE"     >RSPAGE      </a>DFB &lt;START                                      ; (Source) Relocation Start Page $1D00
1C7B:40             328 <a class="d" name="REPAGE"     id="REPAGE"     >REPAGE      </a>DFB &lt;ENDOFDOS                                   ; (Source) Relocation End+1 Page $4000
                    329 ;
1C7C:00             330 <a class="d" name="NSPAGE"     id="NSPAGE"     >NSPAGE      </a>DFB 0
1C7D:00             331 <a class="d" name="NEPAGE"     id="NEPAGE"     >NEPAGE      </a>DFB 0
                    332 ;
1C7E:23             333 <a class="d" name="DOSLNG"     id="DOSLNG"     >DOSLNG      </a>DFB &lt;<a class="d" href="#ENDOFDOS">ENDOFDOS</a>-<a class="d" href="#START">START</a>
                    334 ;
1C7F:00             335 <a class="d" name="DELTA"      id="DELTA"      >DELTA       </a>DFB 0
1C80:23             336 <a class="d" name="DPGCNT"     id="DPGCNT"     >DPGCNT      </a>DFB &lt;<a class="d" href="#ENDOFDOS">ENDOFDOS</a>-<a class="d" href="#START">START</a>
                    337             PAGE


<hr>; === <a class="file" name="DOSINIT">DOSINIT</a> - Command Tables and Interpreter, Page <span class="page">48</span>, <b class="ts">T0$C</b>, $<span class="adr">9D00</span> ===<hr>
                    001 HEREL       EQU &gt;*
                    002 REMDR       EQU 256-HEREL
                    003             ORG *+REMDR
                    004 ;
                    005 ;RELOCATION TABLES
                    006 ;
                    007 <a class="d" name="START"      >START       </a>EQU *
                    008 <a class="d" name="SAT1"       >SAT1        </a>EQU *
1D00:D3 1C          009 <a class="d" name="FTAB"       >FTAB        </a>DW *-45
1D02:81 1E          010 <a class="d" name="CINA"       >CINA        </a>DW CHRIN
1D04:BD 1E          011 <a class="d" name="COUTA"      >COUTA       </a>DW CHROUT
1D06:75 2A          012 <a class="d" name="FN1ADR"     >FN1ADR      </a>DW FNAME1
1D08:93 2A          013 <a class="d" name="FN2ADR"     >FN2ADR      </a>DW FNAME2
1D0A:60 2A          014 <a class="d" name="SVBLA"      >SVBLA       </a>DW SVBL
1D0C:00 1B          015 <a class="d" name="ASTART"     >ASTART      </a>DW <a class="x" href="#BEGIN">BEGIN</a>
1D0E:BB 35          016 <a class="d" name="CCBADR"     >CCBADR      </a>DW CCB
                    017 ;

1D84:AD E9 37       096             LDA IBSLOT      ; GET BOOT SLOT
1D87:4A             097             LSR A
1D88:4A             098             LSR A
1D89:4A             099             LSR A
1D8A:4A             100             LSR A
1D8B:8D 6A 2A       101             STA CS          ; SET AS CUURENT SLOT           ; *spelling* CURRENT


<hr>; === <a class="file" name="DOSHOOK">DOSHOOK</a> - Input / Output Vector, Page <span class="page">44</span>,  <b class="ts">T?S?</b>, $<span class="adr">????</span> ===<hr>


<hr>; === <a class="file" name="CMDSCAN">CMDSCAN</a> - Scan for commands, Page <span class="page">16</span>,  <b class="ts">T?S?</b>, $<span class="adr">????</span> ===<hr>
                    001             PAGE
                    002 ;
                    003 ; SCNCMD - SCAN A COMMAND
                    004 ;
                    005 <a class="f" name="SCNCMD"      >SCNCMD      </a>EQU *


<hr>; === <a class="file" name="XOPNCLS">XOPNCLS</a> - Execute Open / Close, Page <span class="page">150</span>, <b class="ts">T?S?</b>, $<span class="adr">????</span> ===<hr>
                    001             PAGE


<hr>; === <a class="file" name="XLODSAV">XLODSAV</a> - Execute Load / Save , Page <span class="page">140</span>,  <b class="ts">T?S?</b>, $<span class="adr">????</span> ===<hr>


<hr>; === <a class="file" name="DOSGOER">DOSGOER</a> - Print Error message, Page <span class="page">40</span>, T?S?, $<span class="adr">????</span> ===<hr>
                    001             PAGE
                    002 ;
                    003 ; DOSGO - GOTO DOS
                    004 ;
                    005 <a class="f" name="DOSGO"       >DOSGO       </a>EQU *


<hr>; === <a class="file" name="BLDFTAB">BLDFTAB</a> - Build File Tables, Page <span class="page">4</span>, <b class="ts">T1$6</b> @ $D4 - <b class="ts">T1$7</b> @ $83, $<span class="adr">A7D4</span> .. $<span class="adr">A883</span> ===<hr>
                    001             PAGE
                    002 ;
                    003 ; BLDFTB - BUILD FILE TABLES
                    004 ; TABLE MAP:                                        ; $9600 = Array of File Tables
                    005 ;   HIMEM,SOP                                       ; $9D00 = SOP = Start of Program
                    006 ;   SBUFF  N (256)
                    007 ;   DBUFF  N (256)
                    008 ;   FTB    N (FCBLEN)                               ; <a class="file" href="#FVCBUFS">FVCBUFS</a>, Line #<span class="line">187</span>
                    009 ;   HEADER N (38)                                   ; See Header Map below
                    010 ;   .
                    011 ;   .
                    012 ;   SBUFF  1
                    013 ;   DBUFF  1
                    014 ;   FTB    1
                    015 ;   HEADER 1
                    016 ;   THIS PROGRAM
                    017 ;
                    018 ; HEADER MAP:
                    019 ;   FILENAME (30)
                    020 ;   FTB  PTR (2)
                    021 ;   DBUF PTR (2)
                    022 ;   SBUF PTR (2)
                    023 ;   LINK     (2)
                    024 ;
27D4:               025 <a class="f" name="BLDFTB"     >BLDFTB      </a>EQU *
27D4:38             026             SEC
27D5:AD 00 1D       027             LDA <a class="d" href="#FTAB"  >FTAB</a>        ; START OF FTAB AREA            ;
27D8:85 40          028             STA <a class="d" href="#ZPGWRK">ZPGWRK</a>      ; IS 1ST FTB PTR                ;
27DA:AD 01 1D       029             LDA FTAB+1      ; HEADER
27DD:85 41          030             STA ZPGWRK+1
27DF:AD 57 2A       031             LDA CNFTBS      ; MOVE NO FTABS                 ; fdosent, 60
27E2:8D 63 2A       032             STA TEMP1A      ; TO TEMP                       ; fdosent, 60
                    033 ;
27E5:A0 00          034 <a class="f" name="BFT1"       >BFT1        </a>LDY #<span class="adr">0</span>
27E7:98             035             TYA
27E8:91 40          036             STA (ZPGWRK),Y  ; 1ST CHAR FN=0
27EA:A0 1E          037             LDY #<span class="adr">30</span>         ; INC Y TO FCB PTR
27EC:38             038             SEC
27ED:A5 40          039             LDA ZPGWRK      ; END OF PTR HEADER
27EF:E9 2D          040             SBC #FCBLEN     ; MINUS FTAB LENGTH
27F1:91 40          041             STA (ZPGWRK),Y  ; IS START OF FTB
27F3:48             042             PHA             ; SAVE LOW ADR BYTE
27F4:A5 41          043             LDA ZPGWKR+1
27F6:48             044             SBC #<span class="adr">0</span>
27F8:C8             045             INY
27F9:91 40          046             STA (ZPGWKR),Y
27FB:AA             047             TAX
27FC:CA             048             DEX             ; FTB ADR - 256
27FD:68             049             PLA             ; IS ADR DIR BUFF
27FE:48             050             PHA
27FF:C8             051             INY
2800:91 40          052             STA (ZPGWRK),Y  ; SET DIR BUF PTR               ; === <b class="ts">T1$7</b> ===
2802:8A             053             TXA
<hr>2803:C8             054             INY                                             ; === Page <span class="page">5</span> ===
2804:91 40          055             STA (ZPGWRK),Y
2806:AA             056             TAX
2807:CA             057             DEX             ; DIR BUFF - 256
2808:68             058             PLA             ; IS SBUFF ADR
2809:48             059             PHA
280A:C8             060             INY
280B:91 40          061             STA (ZPGWRK),Y
280D:C8             062             INY
280E:8A             063             TXA
280F:91 40          064             STA (ZPGWRK),Y
                    065 ;
2811:CE 63 2A       066             DEC TEMP1A      ; DECREMENT TABLE INDEX         ; TEMP1A @ $<b class="adr">AA63</b>
2814:F0 17          067             BEQ <a class="x" href="#BFT2">BFT2</a>        ; COUNT AND BR IF DONE          ; v
2816:AA             068             TAX
2817:68             069             PLA
2818:38             070             SEC
2819:E9 26          071             SBC #<span class="adr">38</span>         ; SBUFF ADR - 38
281B:C8             072             INY
281C:91 40          073             STA (ZPGWRK),Y  ; IF ADR OF NEXT TAB
281E:48             074             PHA             ; WHICH GOES INTO
281F:8A             075             TXA             ; LINK
2820:E9 00          076             SBC #<span class="adr">0</span>
2822:C8             077             INY
2823:91 40          078             STA (ZPGWRK),Y
2825:85 41          079             STA ZPGWRK+1    ; AND INTO ZPGWRK
2827:68             080             PLA             ; FOR NEXT ENTRY
2828:85 40          081             STA ZPGWRK      ; BUILD
282A:4C E5 27       082             JMP <a class="x" href="#BFT1">BFT1</a>                                        ; ^ BFT1 @ $<b class="adr">A7E4</b>
                    083 ;
                    084 <a name="BFT2"      id="BFT2"       >BFT2        </a>EQU *
282D:48             085             PHA
282E:A9 00          086             LDA #<span class="adr">0</span>          ; SET LAST LINK
2830:C8             087             INY             ; TO ZERO
2831:91 40          088             STA (ZPGWRK),Y
2833:C8             089             INY
2834:91 40          090             STA (ZPGWRK),Y
                    091 ;
2836:AD B6 AA       092             LDA ASIBSW      ; IF IB THEN GO                 ; Integer Basic
2839:F0 0B          093             BEQ <a class="x" href="#BFTIB">BFTIB</a>
                    094 ;
283B:68             095             PLA
283C:85 74          096             STA ASHM1+1
283E:85 70          097             STA ASHM2+1
2840:68             098             PLA
2841:85 73          099             STA ASHM1
2843:85 6F          100             STA ASHM2
2845:60             101             RTS
                    102 ;
                    103 <a class="f" name="BFTIB"   >BFTIB       </a>EQU *
2846:68             104             PLA             ; SET IB
2847:85 4D          105             STA IBHMEM+1    ; UPPER MEM LIMITS
2849:85 CB          106             STA IBSOP+1
284B:68             107             PLA
284C:85 4C          108             STA IBHMEM
284E:85 CA          109             STA IBSOP
2850:60             110             RTS
                    111             PAGE
                    112 ;
                    113 ; MVISW - MOVE INPUT SWITCH
                    114 ;
                    115 <a class="f" name="MVCSW"  >MVCSW       </a>EQU *
2851:A5 39          116             LDA INSW+1
<hr>2853:CD 03 1D       117             CMP CINA+1
2856:F0 12          118             BEQ <a class="x" href="#MVOSW">MVOSW</a>
2858:8D 56 2A       119             STA SVINS+1
285B:A5 38          120             LDA INSW        ; SAVE CHAR IN SWITCH
285D:8D 55 2A       121             STA SVINS
                    122 ;
2860:AD 02 1D       123             LDA CINA        ; SET DFB CHAR IN ADR
2863:85 38          124             STA INSW
2865:AD 03 1D       125             LDA CINA+1
2868:85 39          126             STA INSW+1
                    127 ;
                    128 ;
                    129 ; MVOSW - MOVE OUTPUT SWITCH
                    130 ;
                    131 <a class="f" name="MVOSW"  >MVOSW       </a>EQU *
286A:A5 37          132             LDA OUTSW+1
286C:CD 05 1D       133             CMP COUTA+1
286F:F0 12          134             BEQ <a class="x" href="#MSVRTN">MVSRTN</a>
2871:8D 54 2A       135             STA SVOUTS+1
2874:A5 36          136             LDA OUTSW       ; SAVE CHAR OUT SWITCH
2876:8D 53 2A       137             STA SVOUTS
                    138 ;
2879:AD 04 1D       139             LDA COUTA       ; SET DFB CHAR OUT ADR
287C:85 36          140             STA OUTSW
287E:AD 05 1D       141             LDA COUTA+1
2881:85 37          142             STA OUTSW+1
                    143 <a class="f" name="MVSRTN" >MVSRTN      </a>EQU *
2883:60             144             RTS

<hr>; === <a class="file" name="CMDTBLS">CMDTBLS</a> - Commands, Page <span class="page">21</span>, <b class="ts">T?$?</b>, $<span class="adr">####</span> ===<hr>
                    001                 PAGE
                    002 ;
                    003 ; COMMAND NAME TABLE
                    004 ;
                    005 EC1 EQU *
                    006 CMDNTB EQU *
                    007             DCI "INIT"


<hr>; === <a class="file" name="FDOSENT">FDOSENT</a> - External Entry Point, Page <span class="page">60</span>, <b class="ts">T?$?</b>, $<span class="adr">####</span> ===<hr>
                    001                 PAGE
                    002 ;
                    003 ; MISC BUT REQD CELLS
                    004 ;
                    005 CFTABA DDB 0 ; CURRENT FILE TABLE POINTER


<hr>; === <a class="file" name="FOPCLRW">FOPCLRW</a> - Open; Close; Rename; Read, Page <span class="page">77</span>, <b class="ts">T?$?</b>, $<span class="adr">####</span> ===<hr>
                    001             PAGE
                    002 ;
                    003 ; FOPEN - OPEN A FILE
                    004 ;
                    005 FOPEN EQU *


<hr>; === <a class="file" name="FDELCAT">FDELCAT</a> - Delete, Catalog, Page <span class="page">55</span>, <b class="ts">T?$?</b>, $<span class="adr">####</span> ===<hr>
                    001             PAGE
                    002 ;
                    003 * FLOCK - LOCK A FILE
                    004 ;
                    005 FLOCK LDA #$80


<hr>; === <a class="file" name="FMTRWIO">FMTRWIO</a> - Execute Format Request, Page <span class="page">73</span>, <b class="ts">T?$?</b>, $<span class="adr">####</span> ===<hr>
                    001             PAGE
                    002 ;
                    003 * FFMT - Execute Format Request
                    004 ;
                    005 FFMT EQU *


<hr>; === <a class="file" name="FLOCNXB">FLOCNXB</a> - Locate Next Byte, Page <span class="page">68</span>, <b class="ts">T?$?</b>, $<span class="adr">####</span> ===<hr>
                    001             PAGE
                    002 ;


<hr>; === <a class="file" name="FLOCSEC">FLOCSEC</a> - Locate Sector, Page <span class="page">68</span>, <b class="ts">T?$?</b>, $<span class="adr">####</span> ===<hr>
                    001             PAGE
                    002 ;
                    003 ;FNDFIL - FIND FILE NAME IN VOLUUME DIR                     ; *spelling* VOLUME
                    004 ;
                    005 <a class="f" name="FNDFIL" >FNDFIL      </a>EQU *
                    006             JSR <a class="x" href="#RDVTOC">RDVTOC</a>      ; GO GET VTOC

<hr>; === <a class="file" name="FVCBUFS">FVCBUFS</a> - File Volume Catalog Buffers, Page <span class="page">86</span>, <b class="ts">T2$2</b> @ $A7 - <b class="ts">T2$3</b> @ $BA, $<span class="adr">B397</span> .. $<span class="adr">B4BA</span> ===<hr>
                    001             PAGE                                            ; This is why I partially dislike old source code:
                    002 ;MISC DOS WORK CELLS                                        ;   <i>(almost) Everything has been abbreviated</i>
                    003 ;                                                           ;   <i>(almost) to the point of obfuscation.</i>
3397:00             004 <a class="d" name="CVDTRK">CVDTRK      </a>DFB 0           ; CUR VOL DIR TRK               ; i.e.
3398:00             005 <a class="d" name="CVDSEC">CVDSEC      </a>DFB 0           ; CUR VOL DIR SECTOR            ;    ENT = Entry
3399:00 00          006 <a class="d" name="CURCCB">CURCCB      </a>DFB 0,0         ; CURRENT CCB ADR               ;    ALC = Allocation
339B:00             007 <a class="d" name="ENTSTK">ENTSTK      </a>DFB 0           ; ENTRY STACK POINTER           ; Why are we futzing with the stack pointer???
339C:00             008 <a class="d" name="TEMP1" >TEMP1       </a>DFB 0           ; TEMP BYTE1                    ; /sarcasm o7 Captain Obvious
339D:00             009 <a class="d" name="TEMP2" >TEMP2       </a>DFB 0           ; TEMP BYTE 2                   ; *note* All the cool kids use "o7" for salute these days
339E:00             010 <a class="d" name="TEMP3" >TEMP3       </a>DFB 0           ; TEMP BYTE 3
339F:00             011 <a class="d" name="ENTSLT">ENTSLT      </a>DFB 0           ; BOOT SLOT SAVE
33A0:00 00 FF FF    012 <a class="d" name="ALC10S">ALC10S      </a>DFB 0,0,$FF,$FF ; ALLOCATION TRACK BIT MAP      ; *sigh* wastes 2 bytes/track since 32 sectors/track!
                                                                                    ; The thinking was probably:
                                                                                    ;     DOS 3.2 = 13 sector
                                                                                    ;     DOS 3.3 = 16 sector
                                                                                    ;     DOS 3.4 =&gt;16 sector -- See <a class="d" href="#VNOSEC">VNOSEC</a>
                                                                                    ; <a class="dumb" name="HNTDAFS1">HNTDAFS #1</a>
                                                                                    ; Anytime you see the word <b>reserved</b> in a (file) format
                                                                                    ; your spidey sense should be tingling:
                                                                                    ;   <i>"RESERVED = I pulled this out of my ass -- </i>
                                                                                    ;   <i> because I didn't actually <b>measure</b> what is <b>needed</b>!"</i>
33A4:01 0A 64       013 <a class="d" name="CVTAB" >CVTAB       </a>DFB 1,10,100    ; CONVERSION TABLE              ; Powers of 10, Sadly Applesoft's DECTBL @ $EE6C is useless :-/
                    014             MSC ON                                          ; Switch ASCII to Apple Text (high bit set)
33A7:D4 C9 C1 C2    015 <a class="d" name="FTTAB" >FTTAB       </a>ASC "TIAB"      ; FILE COVERSTION TABLE"        ;
33AB:D3 D2 C1 C2    016             ASC "SRAB"                                      ; *sigh* Really, you just <i>had</i> to re-use AB ??
                                                                                    ; <a class="dumb" name="HNTDAFS2">HNTDAFS #2</a>
                                                                                    ; <i>Gee, how about using, oh I don't know, CD</i>
                                                                                    ; At the very least D = "user Defined" or <i>shock</i> <b>directory</b>:
                                                                                    ;    C = Child Directory; pointer to parent T/S
                                                                                    ;    D = Directory (child)
                                                                                    ; Yeah, yeah 20/20
33AF:A0 C5 CD D5    017 <a class="d" name="VOLMES">VOLMES      </a>ASC " EMULOV DISK" ; "DISK VOLUME " BACWARDS    ; *sigh* Micro-optimization
33B3:CC CF D6 A0                                                                    ; Not that these are bad but /sarcmasm <i>Lets focus on</i>
33B7:CB D3 C9 C4                                                                    ; <i>a <b>single</b> tree, and completely miss the forest!</i>
                    018             MSB OFF                                         ; Switch back to 7-bit ASCII
                    019 <a class="d" name="VML"   >VML         </a>EQU *-<a class="d" href="#VOLMES">VOLMES</a>-1                                  ; File <a class="file" href="#FDELCAT">FDELCAT</a>, Func <a class="x" href="#RDIR">RDIR</a>, Line <span class="todo">TODO</span>
                    020             PAGE
                    021 ;VTOC RECORD AREA                                           ; === VTOC ===
                    022 <a class="d" name="VTOC"  >VTOC        </a>EQU *                                           ; T11S0 === Normal snarky commentary ===
33BB:04             023 <a class="d" name="VDOST" >VDOST       </a>DFB 4           ; DOS TYPE                      ; 00:04 *sarcasm* If only we could do FILESYSTEM_TYPE_VTOC = $4
33BC:11             024 <a class="d" name="VDIRTK">VDIRTK      </a>DFB 17          ; COLUME DIRECTORY SECTOR       ; 01:11 1) *spelling* VOLUME *sigh* 2) TRACK not sector
33BD:0F             025 <a class="d" name="VDIRSC">VDIRSC      </a>DFB 15          ; VOLUME DIRECTORY SECTOR       ; 02:0F 
33BE:04             026 <a class="d" name="VDOSRN">VDOSRN      </a>DFB 4           ; DOS RELEASE NUMBER            ; 03:03 *sarcasm* I guess <b>VERSION</b> made too much sense.
33BF:00             027             DFB 0           ; SPARE                         ; 04:01 *sarcasm* Because <i>someday</i> these <i>might</i> be used ...
33C0:00             028             DFB 0           ; SPARE                         ; 05:00 
33C1:FE             029 <a class="d" name="VVOLNO">VVOLNO      </a>DFB $FE         ; VOLUME NUMBER                 ; 06:FE 
33C2:0 0 0 0 0 0    030             DS 32           ; SPARE                         ; 07:00 Gee, here's an idea, instead of wasting space in the VTOC:
33C8:0 0 0 0 0 0 0 0                                                                ;       1) Pack our data by removing all unused crap,
33D0:0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0                                                ;       2) Put VTOC data as first XX bytes in the CATALOG <b class="ts">T11$F</b>
33E0:00 00                                                                          ;       If we were <i>really</i> smart <b class="ts">T11</b> would reside on <b class="ts">T2$5..F</b>
33E2:7A             031 <a class="d" name="VTDMS" >VTDMS       </a>DFB 122         ; MAX SECTORS IN A FILE DIR     ; 27:7A *sigh* not 128 so we can BMI (Branch on Minus) ???
33E3:00 00 00 00    032 <a class="d" name="VSPARE">VSPARE      </a>DS 8            ; SPARES                        ; 28:00 *sarcasm* Who cares, we have 140KB, right!
33E7:00 00 00 00    033 ;
33EB:11             034 <a class="d" name="VALCA1">VALCA1      </a>DFB 17          ; ALOCATION ALGORITHM BYTE 1    ; 30:0D Last allocated track <span class="todo">TODO</span> Cross-Ref
33EC:01             035 <a class="d" name="VALCA2">VALCA2      </a>DFB 1           ; AA BYTE2                      ; 31:FF Direction of last tack allocation --  <span class="todo">TODO</span> Cross-Ref
                                                                                    ;           +$01 inwards  to <span class="ts">T22</span>,
                                                                                    ;           -$FF outwards to <span class="ts">T00</span>.
33ED:00             036 <a class="d" name="VALCA3">VALCA3      </a>DFB 0           ; AA BYTE3                      ; 32:00 *sigh* wasted byte *sarcasm* <i>I _really_ don't know what we</i>
33EE:00             037 <a class="d" name="VALCA4">VALCA4      </a>DFB 0           ; AA BYTE4                      ; 33:00 *sigh* wasted byte   <i>would do without you Captain Obvious!</i>
33EF:23             038 <a class="d" name="VNOTRK">VNOTRK      </a>DFB 35          ; NO TRACKS ON VOL              ; 34:23 *note* "No" = Number
33F0:10             039 <a class="d" name="VNOSEC">VNOSEC      </a>DFB 16          ; NO SECTORS PER TRACK          ; 35:10          Evidence that one day DOS 3.4+ might support:
33F1:00 01          040 <a class="d" name="VSECLN">VSECLN      </a>DW 256          ; NO. BYTES PER SECTOR          ; 36:00 (Little)     &gt;  16 sectors/track
                    041 ;                                                           ; 37:01 (Endian) and &gt; 256 bytes/sector.
                    042 <a class="d" name="VSECAL">VSECAL      </a>EQU *                                           ;       *note* <b>Actual</b> VTOC header is $F3-$BB = $38 bytes
                    043 ;SECTORS ALLOCATED BY BIT MAP                               ;       [0] Sectors: FEDCBA98    0=Used
                    044 ;4 BYTES OF BITS PER TRACK                                  ;       [1] Sectors: 76543210    1=Free
                    045 ;LEFT MOST BIT REPRESENTS SECTOR N                          ;*sigh* Let us <b>waste</b>     : 35*4 bytes = 140 bytes ($8C)
                    046 ;WHERE N=NO SECTORS PER TRACK                               ;       When we only <b>need</b>: 35*2 bytes =  70 bytes ($46)
                    047 ;                                                           ;       As Mike Acton says:
                    048 ;                                                           ;           "<i>Solve the <b>actual</b> problem,</i>
                    049            PAGE                                             ;           <i>not the one you <b>think</b> is the problem</i>"
33F2:0 0 0 0 0 0    050            ORG VTOC+256                                     ; 38:0F *hack* uninitialized memory is never a good idea
33F8:0 0 0 0 0 0 0 0                                                                ; 39:00 Why not simply <span class="macro">DS 256-&gt;VSECAL,0</span> ???
3400:0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0                                                ; 3A:00 === <b class="ts">T2$3</b> ===
3410:0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0                                                ; 3B:FF *sigh* let's waste $C4 bytes as we span 2 sectors
3420:0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0                                                ; 3C:FF instead of copying the VTOC header ($38 byte)
3430:0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0                                                ;       into a new temporary page on init!
3440:0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
3450:0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0                                                ; <a class="dumb" name="HNTDAFS3">HNTDAFS #3</a>
3460:0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0                                                ; Design fault: DOS is <b>unable</b> to use Track 0 to store user files.
3470:0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0                                                ; This means a non-bootable <i>data disk</i> is robbed of 16 sectors.
3480:0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0                                                ; See File <a class="file" href="#FLOCSEC">FLOCSEC</a>, Func <a class="x" href="#GETSEC">GETSEC</a>, Line <span class="todo">TODO</span>
3490:0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
34A0:0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
34B0:0 0 0 0 0      051 ;
34B4:0 0 0 0 0      052 ;VOLUME DIRECTORY AREA                                      ; === CATALOG ===
34B8:0 0 0          053 ;
<hr>                    054 VOLDIR      EQU *           ;                               ; === Page <span class="page">87</span> ===
34BB:02             055 VDTCDE      DFB 2           ; VOLUME DIRECTORY TYPE CODE    ; *sarcasm* if only we could do FILESYSTEM_TYPE_CATALOG = $2
                    056 
                    057 
                    058 
                    059 
                    060 
                    061 
                    062 
                    063 
                    064 
                    065 
                    066 
                    067 
                    068 
                    069 
                    070 
                    071 
                    072 
                    073 
                    074 
                    075 
                    076 
                    077 
                    078 
                    079 
                    080 
                    081 
                    082 
                    083 
                    084 
                    085 
                    086 
                    087 
                    088 
                    089 
                    090 
                    091 
                    092 
                    093 
                    094 
                    095 
                    096 
                    097 
                    098 
                    099 
                    100 
                    101 
                    102 
                    103 
                    104 
                    105 
                    106 
                    107 
                    108 
                    109 
                    100 
                    101 
                    102 
                    103 
                    104 
                    105 
                    106 
                    107 
                    108 
                    109 
                    110 
                    111 
                    112 
                    113 
                    114 
                    115 
                    116 
                    117 
                    118 
                    119 

    :00             180 DCBDRV DS 1                 ; DRIVE NUMBER
    :00             181 DCBVOL DS 1                 ; VOLUME DRIVER
    :00             182 DCBVTN DS 1                 ; VTOC TRACK NUMBER
                    183 ;
    :00 00 00       184 DCBSPR DS 3                 ; SPARES
                    185 ;
                    186 DCBLEN EQU *-<a class="d" href="#FCBDCB">FCBDCB</a>         ; DCB LENGTH
                    187 <a class="d" name="FCBLEN">FCBLEN</a> EQU *-<a class="d" href="#FCB"   >FCB</a>            ; FCB LENGTH
####:## ## ##       ### LABEL       NMEMONIC        COMMENT                         ; Annotation

<hr>; === <a class="file" name="BOOTLDR">BOOTLDR</a> - Boot loader, Page <span class="page">8</span>, <b class="ts">T0$0</b>, $<span class="adr">B600</span> ===<hr>


<hr>; === <a class="file" name="COREQUS">COREQUS</a> - Core Equates, Page <span class="page">24</span>, <b class="ts">n/a</b>, $<span class="adr">n/a</span> ===<hr>

                    153 ************************
                    154 *                      *
                    155 *   ---- WRADR16 ----  *
                    156 *                      *
                    157 ************************
                    158 <a class="d" name="AA"         >AA          </a>EQU $3E         ;TIMING CONSTANT                ; *sigh* Really people you couldn't pick <i>any other</i> variable name?!
                    159 <a class="d" name="NSECT"      >NSECT       </a>EQU $3F
                    160 <a class="d" name="NVOL"       >NVOL        </a>EQU $41
                    161 <a class="d" name="TRK"        >TRK         </a>EQU $44*
                    162 *
                    163 ************************
                    164 *                      *
                    165 *    DEVICE ADDRESS    *
                    166 *     ASSIGNMENTS      *
                    167 *                      *                                    ; See <a class="d" href="#ONTABLE">ONTABLE</a>, and <a class="d" href="#OFFTABLE">OFFTABLE</a>
                    168 ************************                                    ; Typical B.A.D. (Beneath Apple Dos) shenanigans (Page 6-3):
                    169 <a class="d" name="PHASEOFF"   >PHASEOFF    </a>EQU $C080       STEPPER PHASE OFF.              ; <i>"The timing between accesses to these locations is</i>
                    170 <a class="d" name="PHASEON"    >PHASEON     </a>EQU $C081       STEPPER PHASE ON.               ; <i> critical, making this a non-trivial exercise."</i> <b>WHICH IS???</b>
                    171 <a class="d" name="Q6L"        >Q6L         </a>EQU $C08C       Q7L,Q6L=READ                    ; *sigh* /sarcasm Riiight, because it is _obvious_ what Q7L &amp; Q7H
                    172 <a class="d" name="Q6H"        >Q6H         </a>EQU $C08D       Q7L,Q6H=SENSE WPROT             ; do -- but let's keep copy/paste these shitty non-descript names!
                    173 <a class="d" name="Q7L"        >Q7L         </a>EQU $C08E       Q7H,Q6L=WRITE                   ; DRIVE_MODE_R
                    174 <a class="d" name="Q7H"        >Q7H         </a>EQU $C08F       Q7H,Q6H=WRITE STORE             ; DRIVE_MODE_W


<hr>; === <a class="file" name="PRENIBL">PRENIBL</a> - Pre nibblize sector data for writing, Page <span class="page">104</span>, <b class="ts">T?$?</b>, $<span class="adr">????</span> ===<hr>


<hr>; === <a class="file" name="WRITRTN">WRITRTN</a> - Write Routine, Page <span class="page">137</span>, <b class="ts">T0$2</b>, $<span class="adr">B82A</span> ===<hr>
                    001                 SBTL '16-SECTOR WRITE'
                    002 ************************
                    003 *                      *
                    004 *      WRITE SUBR      *
                    005 *  (16-SECTOR FORMAT)  *
                    006 *                      *
                    007 ************************
                    008 *                      *
                    009 *   WRITES DATA FROM   *
                    010 *    NBUF1 AND NBUF2   *
                    011 *   CONVERTING 6-BIT   *
                    012 *    TO 7-BIT NIBLS    *
                    013 *   VIA 'NIBL' TABLE.  *
                    014 *                      *
                    015 *  FIRST NBUF2,        *
                    016 *      HIGH TO LOW.    *
                    017 *  THEN NBUF1,         *
                    018 *      LOW TO HIGH.    *
                    019 *                      *
                    020 *  ---- ON ENTRY ----  *
                    021 *                      *
                    022 *   X-REG: SLOTNUM     *
                    023 *        TIMES $10.    *
                    024 *                      *
                    025 *   NBUF1 AND NBUF2    *
                    026 *    HOLD NIBLS FROM   *
                    027 *    PRENIBL SUBR.     *
                    028 *    (00ABCDEF)        *
                    029 *                      *
                    030 *  ---- ON EXIT -----  *
                    031 *                      *
                    032 *  CARRY SET IF ERROR. *
                    033 *   (W PROT VIOLATION) *
                    034 *                      *
                    035 *  IF NO ERROR:        *
                    036 *                      *
                    037 *    A-REG UNCERTAIN.  *
                    038 *    X-REG UNCHANGED.  *
                    039 *    Y-REG HOLDS $00.  *
                    040 *    CARRY CLEAR.      *
                    041 *                      *
                    042 *    SLOTABS, SLOTZ,   *
                    043 *     AND WTEMP USED.  *
                    044 *                      *
                    045 *  ---- ASSUMES ----   *
                    046 *                      *
                    047 *  1 USEC CYCLE TIME   *
                    048 *                      *
                    049 ************************
382A:38             050 <a class="f"    name="WRITE16"      >WRITE16     </a>SEC             ;ANTICIPATE WPROT ERR.          ; === Reloc @ $B82A ===
382B:86 27          051             STX SLOTZ       ;FOR ZERO PAGE ACCESS.
382D:8E 78 06       052             STX SLOTABS     ;FOR NON-ZERO PAGE.
3830:BD 8D C0       053             LDA Q6H,X
3833:BD 8E C0       054             LDA Q7L,X       ;SENSE WPROT FLAG.
3836:30 7C          055             BMI <a href="#WEXIT"    >WEXIT</a>       ;IF HIGH, THEN ERR.             ; v
3838:AD 00 3C       056             LDA NBUF2
383B:85 26          057             STA WTEMP       ;FOR ZERO-PAGE ACCESS.
383D:A9 FF          058             LDA #$FF        ;SYNC DATA
383F:9D 8F C0       059             STA Q7H,X       ;(5) WRITE 1ST NIBL.
3842:1D 8C C0       060             ORA Q6L,X       ;(4)
3845:48             061             PHA             ;(3)
3846:68             062             PLA             ;(4) CRITICAL TIMING!
3847:EA             063             NOP             ;(2)
3848:A0 04          064             LDY #4          ;(2)  FOR 5 NIBLS.
384A:48             065 <a class="f"    name="WSYNC"        >WSYNC       </a>PHA             ;(3) EXACT TIMING               ; --- Sync FF ---
384B:68             066             PLA             ;(4) EXACT TIMING
384C:20 B9 38       067             JSR <a href="#WNIBL7"   >WNIBL7</a>      ;(13,9,6)  WRITE SYNC
384F:88             068             DEY             ;(2)
3850:D0 F8          069             BNE <a href="#WSYNC"    >WSYNC</a>       ;(2*)  MUST NOT  CROSS PAGE!    ; ^
3852:A9 D5          070             LDA #$D5        ;(2)  1ST DATA MARK.            ; --- Data Header D5 AA AD ---
3854:20 B8 38       071             JSR <a href="#WNIBL9"   >WNIBL9</a>      ;(15,9,6)
3857:A9 AA          072             LDA #$AA        ;(2)  2ND DATA MARK.
3859:20 B8 38       073             JSR <a href="#WNIBL9"   >WNIBL9</a>      ;(15,9,6)
385C:A9 AD          074             LDA #$AD        ;(2)  3RD DATA MARK.
385E:20 B8 38       075             JSR <a href="#WNIBL9">WNIBL9</a>      ;(15,9,6)
3861:98             076             TYA             ;(2) CLEAR CHECKSUM
3862:A0 56          077             LDY #$56        ;(2) NBUF2 INDEX.
3864:D0 03          078             BNE <a href="#WDATA1">WDATA1</a>      ;(3)  ALWAYS.  NO PAGE CROSS!!  ; v
3866:B9 00 3C       079 <a class="f"    name="WDATA0"       >WDATA0      </a>LDA NBUF2,Y     ;(4)  PRIOR 6-BIT NIBL.
3869:58 FF 3B       080 <a class="f"    name="WDATA1"       >WDATA1      </a>EOR NBUF2-1,Y   ;(5)  XOR WITH CURRENT.
                    081 *   (NBUF2 MUST BE ON PAGE BOUNDARY FOR TIMING!!)
386C:AA             082             TAX             ;(2)  INDEX To 7-BIT NIBL
386D:BD 29 3A       083             LDA NIBL,X      ;(4)  MUST NOT CROSS PAGE!
3870:A6 27          084             LDX SLOTZ       ;(3)  CRITICAL TIMING!
3872:9D 8D C0       085             STA Q6H,X       ;(5)  WRITE NIBL.
3875:BD 8C C0       086             LDA Q6L,X       ;(4)
3878:88             087             DEY             ;(2)  NEXT NIBL.
3879:D0 EB          088             BNE <a href="#WDATA0"   >WDATA0</a>      ;(2*) MUST NOT CROSS PAGE!      ; ^
387B:A5 26          089             LDA WTEMP       ;(3) PRIOR NIBL FROM BUF6.
387D:EA             090             NOP             ;(2)  CRITICAL TIMING.
387E:59 00 3B       091 <a class="f"    name="WDATA2"       >WDATA2      </a>EOR NBUF1,Y     ;(5)  XOR WITH CURRENT.
3881:AA             092             TAX             ;(2)
3882:BD 29 3A       093             LDA <a class="d" href="#NIBL"   >NIBL</a>,X      ;(4)
3885:AE 78 06       094             LDX <a class="d" href="#SLOTABS">SLOTABS</a>     ;(4) TIMING CRITICAL
3888:9D 8D C0       095             STA <a class="d" href="#Q6H"    >Q6H</a>,X       ;(5) WRITE NIBL.
388B:BD 8C C0       096             LDA <a class="d" href="#Q6L"    >Q6L</a>,X       ;(4)
388E:B9 00 3B       097             LDA <a class="d" href="#NBUF1"  >NBUF1</a>,Y     ;(4)  PRIOR 6-BIT NIBL.
3891:C8             098             INY             ;(2)NEXT NBUF1 NIBL.
3892:D0 EA          099             BNE <a class="x" href="#WDATA2" >WDATA2</a>      ;(2*) MUST NOT CROSS PAGE!      ; ^
3894:AA             100             TAX             ;(2)
3895:BD 29 3A       101             LDA <a class="d" href="#NIBL"   >NIBL</a>,X      ;(4)  INDEX TO 7-BIT NIBL
3898:A6 27          102             LDX <a class="d" href="#SLOTZ"  >SLOTZ</a>       ;(3)
389A:20 BB 38       103             JSR <a class="x" href="#WNIBL"  >WNIBL</a>       ;(6,9,6)  WRITE CHKSUM
389D:A9 DE          104             LDA #$<span class="adr">DE</span>        ;(2)  DM4, BIT SLIP MARK.
389F:20 B8 38       105             JSR <a class="x" href="#WNIBL9" >WNIBL9</a>      ;(15,9,6)    WRITE IT.
38A2:A9 AA          106             LDA #$<span class="adr">AA</span>        ;(2)  DM5, BIT SLIP MARK.
38A4:20 B8 38       107             JSR <a class="x" href="#WNIBL9" >WNIBL9</a>      ;(15,9,6)    WRITE IT.
38A7:A9 EB          108             LDA #$<span class="adr">EB</span>        ;(2)  DM6, BIT SLIP MARK.
38A9:20 B8 38       109             JSR <a class="x" href="#WNIBL9" >WNIBL9</a>      ;(15,9,6)    WRITE IT.
38AC:A9 FF          110             LDA #$<span class="adr">FF</span>        ;(2) TURN-OFF BYTE.
38AE:20 B8 38       111             JSR <a class="x" href="#WNIBL9" >WNIBL9</a>      ;(15,9,9) WRITE IT.             ; TODO: 15,9,6??
38B1:BD 8E C0       112             LDA <a class="d" href="#Q7L"    >Q7L,X</a>       ;OUT OF WRITE MODE.
38B4:BD 8C C0       113 <a class="f"    name="WEXIT"        >WEXIT       </a>LDA <a class="d" href="#Q6L"    >Q6L</a>,X       ;TO READ MODE.
38B7:60             114             RTS             ;RETURN FROM WRITE.
                    115 *****************************
                    116 *                           *
<hr>                    117 *   7-BIT NIBL WRITE SUBRS  *                               ; === WRITRTN, Page <span class="page">139</span> ===
                    118 *                           *
                    119 *   A-REG OR'D PRIOR EXIT   *
                    120 *       CARRY CLEARED       *
                    121 *                           *
                    122 *****************************
38B8:18             123 <a class="f"    name="WNIBL9"     >WNIBL9      </a>CLC             ; (2) 9 CYCLES, THEN WRITE.
38B9:48             124 <a class="f"    name="WNIBL7"     >WNIBL7      </a>PHA             ; (3) 7 CYCLES, THEN WRITE.
38BA:68             125             PLA             ; (4)
38BB:9D 8D C0       126 <a class="f"    name="WNIBL"      >WNIBL       </a>STA <a class="d" href="#Q6H">Q6H</a>,X       ; (5) NIBL WRITE SUB.
38BE:1D 8C C0       127             ORA <a class="d" href="#Q6L">Q6L</a>,X       ; (4) CLOBBERS ACC, NOT CARRY
38C1:60             128             RTS


<hr>; === <a class="file" name="POSTNRD">POSTNRD</a> - Post Nibbilize Read, Page <span class="page">101</span>, <b class="ts">T0$2</b> @ $C2, $<span class="adr">B8C2</span> .. $<span class="adr">B943</span> ===<hr>
                    001             SBTL '16-SECTOR POSTNIBLIZE'
                    002 ***************************
                    003 *                         *
                    004 *    POSTNIBLIZE SUBR     *
                    005 *    16-SECTOR FORMAT     *
                    006 *                         *
                    007 ***************************
                    008 *                         *
                    009 *  CONVERTS 6-BIT NIBLS   *
                    010 *  OF FORM 00ABCDEF IN    *
                    011 *  NBUF1 AND NBUF2 INTO   *
                    012 *  256 BYTES OF USER      *
                    013 *  DATA IN BUF.           *
                    014 *                         *
                    015 *   ---- ON ENTRY ----    *
                    016 *                         *
                    017 *  X-REG: HOLDS SLOTNUM   *
                    018 *            TIMES $10.   *
                    019 *                         *
                    020 *  BUF IS 2-BYTE POINTER  *
                    021 *    TO 256 BYTES OF USER *
                    022 *    DATA TO BE CONVERTED *
                    023 *    TO 6-BIT NIBLS IN    *
                    024 *    NBUF1 AND NBUF2      *
                    025 *    PRIOR TO WRITE.      *
                    026 *                         *
                    027 *  T0 CONTAINS BYTE COUNT *
                    028 *    CODE0 = 256 BYTES    *
                    029 *    CODE1 =   1 BYTE     *
                    030 *    CODE2 =   2 BYTER    *
                    031 *                         *
                    032 *    CODE 255=255 BYTES   *
                    033 *                         *
                    034 *   ---- ON EXIT -----    *
                    035 *                         *
                    036 *  A-REG UNCERTAIN.       *
                    037 *  Y-REG SAME AS T0.      *
                    038 *  X-REG UNCERTAIN.       *
                    039 *  CARRY SET.             *
                    040 *                         *
                    041 *  6-BIT NIBLS OF FORM    *
                    042 *    00ABCDEF IN NBUF1    *
                    043 *    AND NBUF2.           *
                    044 *      (242 NIBLS)        *
                    045 ***************************
38C2:A0 00          046 <a class="f"    name="POSTNB16"   >POSTNB16    </a>LDA #$0         USER DATA BUF IDX.              ; <b class="ts">T0$2</b> <span class="todo">TODO</span>
38C4:A2 56          047 <a class="f"    name="POST1"      >POST1       </a>LDX #$56        INIT NBUF2 INDEX.
38C6:CA             048 <a class="f"    name="POST2"      >POST2       </a>DEX             IDX $55 TO $0
38C7:30 FB          049             BMI <a href="#POST1">POST1</a>       WRAPAROUND IF NEG.              ; ^
38C9:B9 00 3B       050             LDA NBUF1,Y
38CC:5E 00 3C       051             LSR NBUF2,X     SHIFT 2 BITS FROM
38CF:2A             052             ROL A           CURRENT NBUF2 NIBL
38D0:5E 00 3C       053             LSR             INTO CURRENT NBUF1
<hr>38D3:2A             054             ROL A           NIBL.                           ; === Page <span class="page">102</span> ===
38D4:91 3E          055             STA (BUF),Y     BYTE OF USER DATA.
38D6:C8             056             INY             NEXT USER BYTE.
38D7:C4 26          057             CPY T0          DONE IF EQUAL T0.
38D9:D0 EB          058             BNE <a href="#POST2">POST2</a>                                       ; ^
38DB:60             059             RTS             RETURN.
                    060                 SBTL '16-SECTOR READ'


<hr>; === <a class="file" name="RDADSEK">RDADSEK</a> - Read Disk Address; Seek, Page <span class="page">106</span>, <b class="ts">T0$3</b> @ $44, $<span class="adr">B944</span>-<span class="adr">B9FC</span> ===<hr>
                    001             SBTL '16-SECTOR READ ADDRESS'

                    054 * *
                    055 ****************************
3944:A0 FC          056 <a name="RDADR16"    >RDADR16     </a>LDY #$FC
3946:84 26          057 <!--                   -->            STY COUNT       'MUST FIND' COUNT.
3948:C8             058 <a name="RDASYN"     >RDASYN      </a>INY

<hr>39DA:A5 27          180             LDA <a class="d" hred="PRIOR"    >PRIOR</a>
39DC:18             181             CLC             ;CARRY CLEAR=PHASE OFF
39DD:20 F1 39       182             JSR <a class="x" href="#CLRPHASE">CLRPHASE</a>    ;PHASE OFF
39E0:BD 1D 3A       183             LDA <a class="d" href="#OFFTABLE">OFFTABLE</a>,Y  THEN WAIT 'OFFTIME'.
39E3:20 00 3A       184             JSR <a class="x" href="#MSWAIT"  >MSWAIT</a>      (100 USEC INTERVALS)
39E6:E6 26          185             INC <a class="d" href="#TRKCNT"  >TRKCNT</a>      'TRACKS MOVED' COUNT.
39E8:D0 C3          186             BNE <a class="x" href="#SEEK2"   >SEEK2</a>       (ALWAYS TAKEN)
                    187 *
                    188 <a name="SEEKEND"    >SEEKEND     </a>EQU *
39EA:20 00 3A       189             JSR <a class="x" href="#MSWAIT">MSWAIT</a>      ;A=0: WAIT 25 MS SETTLE
39ED:18             190             CLC
                    191 *
                    192 * TURN HEAD STEPPER PHASE ON/OFF
                    193 *
                    194 <a name="SETPHASE"   >SETPHASE    </a>EQU *
39EE:AD 78 04       195             LDA CURTRK      ;GET CURRENT PHASE
                    196 <a name="CLRPHASE"   >CLRPHASE    </a>EQU *
39F1:29 03          197             AND #3          ;MASK FOR 1 OF 4 PHASES
39F3:2A             198             ROL A           ;DOUBLE FOR PHASE INDEX
39F4:05 2B          199             ORA SLOTTEMP
39F6:AA             200             TAX
39F7:BD 80 C0       201             LDA <a class="d" href="#PHASEOFF">PHASEOFF</a>,X  ;FLIP THE PHASE
39FA:A6 2B          202             LDX SLOTTEMP    ;RESTORE X-REG
39FC:60             203 <a name="SEEKRTS"    >SEEKRTS     </a>RTS             ;AND RETURN                     ; /sarcasm I don't know what we would do without you Captain Obvious!

<hr>; === <a class="file" name="MSWAITR">MSWAITR</a> - Microsecond wait routine, Page <span class="page">97</span>, <b class="ts">T0$4</b>-<b class="ts">T0$6</b> @ $55, $<span class="adr">BA00</span> - $<span class="adr">BC55</span> ===<hr>
                    001                 SBTL '16-SECTOR MSWAIT'
                    002 **************************
                    003 *   MSWAIT SUBROUTINE    *
                    004 **************************
                    005 *                        *
                    006 *  DELAYS A SPECIFIED    *
                    007 *   NUMBER OF 100 USEC   *
                    008 *   INTERVALS FOR MOTOR  *
                    009 *   ON TIMING.           *
                    010 *                        *
                    011 *   ---- ON ENTRY ----   *
                    012 *  A-REG: HOLDS NUMBER   *
                    013 *        OF 100 USEC     *
                    014 *        INTERVALS TO    *
                    015 *        DELAY.          *
                    016 *                        *
                    017 *   ---- ON EXIT -----   *
                    018 *  A-REG: HOLDS $00.     *
                    019 *  X-REG: HOLDS $00.     *
                    020 *  Y-REG: UNCHANGED.     *
                    021 *  CARRY: SET.           *
                    022 *                        *
                    023 *  MONTIMEL, MONTIMEH    *
                    024 *   ARE INCREMENTED ONCE *
                    025 *   PER 100 USEC INTERVAL*
                    026 *   FOR MOTON ON TIMING. *
                    027 *    ---- ASSUMES ----   *
                    028 * 1 USEC CYCLE TIME      *
                    029 **************************
39FD:00 00 00       030         DS 3,0              ;AVOID PAGE BOUNDARY CROSSING...; T0$3 @ $FC *sigh* 3 unused bytes
3A00:A2 11          031 <a class="f"    name="MSWAIT"     >MSWAIT      </a>LDX #$11                                        ; === <b class="ts">T0$4</b> === *sigh* Typical bloated code ...
3A02:CA             032 <a class="f"    name="MSW1"       >MSW1        </a>DEX             DELAY 86 USEC.                  ; ... should just adjust algorithm timing instead!
3A03:D0 FD          033             BNE <a class="x" href="#MSW1">MSW1</a>
3A05:E6 46          034             INC MONTIMEL
3A07:D0 02          035             BNE <a class="x" href="#MSW2">MSW2</a>        ; DOUBLE-BYTE
3A09:E6 47          036             INC MONTIMEH    INCREMENT.
3A0B:38             037 <a class="f"    name="MSW2"       >MSW2        </a>SEC
3A0C:E9 01          038             SBC #$1         DONE 'N' INTERVALS?
3A0E:D0 F0          039             BNE <a href="#MSWAIT">MSWAIT</a></b>            (A-REG COUNTS)
3A10:60             040             RTS
                    041 AEC1        EQU *           ;TELL RELOCATOR WHERE CORE ENDS
                    042 **************************
                    043 *  PHASE ON-, OFF-TIME   *
                    044 *   TABLES IN 100-USEC   *
                    045 *   INTERVALS. (SEEK)    *
                    046 **************************
3A11:01 30 28       047 <a class="d" name="ONTABLE"    >ONTABLE     </a>DFB 1,$30,$28                                   ; See <a class="file" href="#RDADSEK">RDADSEK</a>, Page <span class="page">108</span>, Line # <span class="todo">TODO</span>
3A14:24 20 1E       048             DFB $24,$20,$1E
3A17:1D 1C 1C       049             DFB $1D,$1C,$1C
3A1A:1C 1C 1C       050             DFB $1C,$1C,$1C
3A1D:70 2C 26       051 <a class="d" name="OFFTABLE"   >OFFTABLE    </a>DFB $70,$2C,$26                                 ; See <a class="file" href="#RDADSEK">RDADSEK</a> Page <span class="page">109</span>, Line #<span class="line">183</span>
3A20:22 1F 1E       052             DFB $22,$1F,$1E
3A23:1D 1C 1C       053             DFB $1D,$1C,$1C
<hr>3A26:1C 1C 1C       054             DFB $1C,$1C,$1C                                 ; === Page <span class="page">98</span> ===
                    055             SBTL '16-SECTOR NYBBLE TABLES'
                    056 ***************************
                    057 *                         *
                    058 *     6-BIT TO 7-BIT      *
                    059 *  NIBL CONVERSION TABLE  *
                    060 *                         *
                    061 ***************************
                    062 *                         *
                    063 *   CODES WITH MORE THAN  *
                    064 *   ONE PAIR OF ADJACENT  *
                    065 *    ZEROES OR WITH NO    *
                    066 *   ADJACENT ONES (EXCEPT *
                    067 *     B7) ARE EXCLUDED.   *
                    068 *                         *
                    069 * THIS TABLE MAY *NOT*    *
                    070 * CROSS A PAGE BOUNDARY!  *
                    071 *                         *
                    072 ***************************
3A29:96 97 9A       073 <a class="d"    name="NIBL"       >NIBL        </a>DFB $96,$97,$9A                                 ; /sarcasm, Gee if only
3A2C:9B 9D 9E       074             DFB $9B,$9D,$9E                                 ; there was a HEX pseudo-mnemonic
3A2F:9F A6 A7       075             DFB $9F,$A6,$A7                                 ; so we could group these in 4 bytes ...
3A32:AB AC AD       076             DFB $AB,$AC,$AD                                 ; ... maybe one day. :)
3A35:AE AF B2       077             DFB $AE,$AF,$B2                                 ; NOTE: Also see <a href="#NIBL">NIBL</a> and <a href="#PD2">PD2</a>
3A38:B3 B4 B5       078             DFB $B3,$B4,$B5
3A3B:B6 B7 B9       079             DFB $B6,$B7,$B9
3A3E:BA BB BC       080             DFB $BA,$BB,$BC
3A41:BD BE BF       081             DFB $BD,$BE,$BF
3A44:CB CD CE       082             DFB $CB,$CD,$CE

TODO:
                    137
                    139 <a class="f"    name="OFF80"      >OFF80       </a>EQU *
3A76:A9 FF          140             LDA #$FF
3A78:8D FB 04       141             STA $4FB        ; CLEARS FUNNY 80 COL STUFF
3A7B:8D 0C C0       142             STA $C00C       ; TURNS 80 COL OFF
3A7E:8D 0E C0       143             STA $C00E       ; TURN OFF  ALT CHAR SET
3A81:4C 2F FB       144             JMP $FB2F       ; MONITOR INIT ROUTINE          ; If only we could define symbols ...
                    145             PAGE
                    146 <a class="f" name="PEC1"        >PEC1        </a>EQU *           ;Tell relocater where to stop   ; See <a href="#CDETAB">CDETAB</a>, RELOCTR, Page <span class="page">115</span>
                    147 PD1         EQU &gt;*
                    148 <a class="f" name="PD2"         >PD2         </a>EQU $96-PD1<span class="patch">
                    === DOS 3.3 D? PATCH ===        
                    3A84:AD BD 35   LDA $35BD ; <span class="todo">TODO</span>
                    3A87:8D E6 35   STA $35E6 ; <span class="todo">TODO</span>
                    3A8A:8D EA 35   STA $35EA ; <span class="todo">TODO</span>
                    3A8D:BA         TSX             
                    3A8E:8E 9B 33   STX $339B ; <span class="todo">TODO</span>
                    3A91:4C 7F 33   JMP $337F ; <span class="todo">TODO</span>
                    === DOS 3.3 ? PATCH ===         </span>
3A84:00 00 00 00    149             DS  PD2,0       ;Must pad to $XX96              ; *sigh* 18 wasted bytes
3A88:00 00 00 00                                                                    ; No, no, no!
3A8C:00 00 00 00                                                                    ; Negative array index OFFSETS like the P6 PROM uses
3A90:00 00 00 00                                                                    ;
3A94:00 00
3A96:00 01 98       150             DFB $00,$01,$98                                 ; 96 97 --   *sigh* And the comment that this is the
3A99:99 02 03       151             DFB $99,$02,$03                                 ; -- 9A 9B   64 disk nibbles of 6&amp;2 Read Table
3A9C:9C 04 05       152             DFB $9C,$04,$05                                 ; -- 9D 9E   is where again? Comments people, comments!
3A9F:06 A0 A1       153             DFB $06,$A0,$A1                                 ; 9F -- --   Hey, after annotating 154 pages
3AA2:A2 A3 A4       154             DFB $A2,$A3,$A4                                 ; -- -- --   you would be grumpy too. :-)
3AA5:A5 07 08       155             DFB $A5,$07,$08                                 ; -- A6 A7
3AA8:A8 A9 AA       156             DFB $A8,$A9,$AA                                 ; -- -- !!   (!! Technically AA is a valid disk nibble)
3AAB:09 0A 0B       157             DFB $09,$0A,$0B                                 ; AB AC AD   but it reserved for a 3 byte header id
3AAE:0C 0D B0       158             DFB $0C,$0D,$B0                                 ; AE AF --   Typical DOS 3.3 B-L-O-A-T
3AB1:B1 0E 0F       159             DFB $B1,$0E,$0F                                 ; -- B2 B3   One reserved byte D5 could be used for T/S  header
3AB4:10 11 12       160             DFB $10,$11,$12                                 ; B4 B5 B6   One reserved byte AA could be used for Data header
3AB7:13 B8 14       161             DFB $13,$B8,$14                                 ; B7 -- B9
3ABA:15 16 17       162             DFB $15,$16,$17                                 ; BA BB BC
3ABD:18 19 1A       163             DFB $18,$19,$1A                                 ; BD BE BF
3AC0:C0 C1 C2       164             DFB $C0,$C1,$C2                                 ; -- -- --   *sigh* 11 unused bytes
3AC3:C3 C4 C5       165             DFB $C3,$C4,$C5                                 ; -- -- --   /sarcasm But who cares, we have 48K right!?
3AC6:C6 C7 C8       166             DFB $C6,$C7,$C8                                 ; -- -- --   This is why DOS takes seconds longer to boot.
3AC9:C9 CA 1B       167             DFB $C9,$CA,$1B                                 ; -- -- CB
3ACC:CC 1C 1D       168             DFB $CC,$1C,$1D                                 ; -- CD CE   *sigh* This entire table can be compactly
3ACF:1E D0 D1       169             DFB $1E,$D0,$D1                                 ; CF -- --   represented with 8 lines instead of 36 lines
3AD2:D2 20 21       170             DFB $D2,$1F,$D4                                 ; -- D3 --   If only we had a HEX pseudo-mnemonic ...
3AD5:D5 20 21       171             DFB $D5,$20,$21                                 ; @@ D6 D7   (@@ Technically D5 is valid but is reserved too)
3AD8:D8 22 23       172             DFB $D8,$22,$23                                 ; -- D9 DA      x0 x1 x2 x3 x4 x5 x6 x7 x8 x9 xA xB xC xD xE xF
3ADB:24 25 26       173             DFB $24,$25,$26                                 ; DB DC DD   9x:-- -- -- -- -- -- 00 01 -- -- 02 03 -- 04 05 06
3ADE:27 28 E0       174             DFB $27,$28,$E0                                 ; DE DF --   Ax:-- -- -- -- -- -- 07 08 -- -- !! 09 0A 0B 0C 0D
3AE1:E1 E2 E3       175             DFB $E1,$E2,$E3                                 ; -- -- --   Bx:-- -- 0E 0F 10 11 12 13 -- 14 15 16 17 18 19 1A
3AE4:E4 29 2A       176             DFB $E4,$29,$2A                                 ; -- E5 E6   Cx:-- -- -- -- -- -- -- -- -- -- -- 1B -- 1C 1D 1E
3AE7:2B E8 2C       177             DFB $2B,$E8,$2C                                 ; E7 -- E9   Dx:-- -- -- 1F -- @@ 20 21 -- 22 23 24 25 26 27 28
3AEA:2D 2E 2F       178             DFB $2D,$2E,$2F                                 ; EA EB EC   Ex:-- -- -- -- -- 29 2A 2B -- 2C 2D 2E 2F 30 31 32
3AED:30 31 32       179             DFB $30,$31,$32                                 ; ED EE EF   Fx:-- -- 33 34 35 36 37 38 -- 39 3A 3B 3C 3D 3E 3F
<hr>3AF0:F0 F1 33       180             DFB $F0,$F1,$33                                 ; -- -- F2   === Page <span class="page">100</span> ===
3AF3:34 35 36       181             DFB $34,$35,$36                                 ; F3 F4 F5
3AF6:37 38 F8       182             DFB $37,$38,$F8                                 ; F6 F7 --
3AF9:39 3A 3B       183             DFB $39,$3A,$3B                                 ; F9 FA FB
3AFC:3C 3D 3E       184             DFB $3C,$3D,$3E                                 ; FC FD FE
3AFF:3F             185             DFB $3F                                         ; FF
                    186             PAGE
                    187 ***************************
                    188 *                         *
                    189 *    NYBBLE BUFFERS       *
                    190 *                         *
                    191 * NBUF1 (256 BYTES) MUST  *
                    192 *  BE ALIGNED ON A PAGE   *
                    193 *  BOUNDARY.              *
                    194 *                         *
                    195 * NBUF2 (86 BYTES) MUST   *                                 ; Incorrect: It must _not_ CROSS
                    196 *  BE ALIGNED ON A PAGE   *                                 ; a page boundary. Technically, It can be
                    197 *  BOUNDARY.              *                                 ; anywhere *within* the page. But then the
                    198 *                         *                                 ; code at <a class="file" href="#WRITRTN">WRITRTN</a>, Line #<span class="line">80</span> needs fixing up.
                    199 ***************************                                 ;
                    200 *                                                           ;
3B00:00 00 00 00    201 <a class="d" name="NBUF1"       >NBUF1       </a>DS 256,0        ;NBUF1                          ; === <b class="ts">T0$5</b> ===
3B04:00 00 00 00                                                                    ; *sigh* Let's waste an *entire* sector
3B08:00 00 00 00                                                                    ; with 342 disk nibbles of raw 96 nibbles
3B0C:00 00 00 00                                                                    ; PLUS the time decoding it
3B10:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                ; when _9 bytes_ would do
3B20:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                ; the job IF NUBF1 == $BF00
3B30:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                ;
3B40:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                ;    LDA #0
3B50:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                ;    TAY
3B60:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                ;.1  STA NBUF1,Y
3B70:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                ;    INY
3B80:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                ;    BNE .1
3B90:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3BA0:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3BB0:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3BC0:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3BD0:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3BE0:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3BF0:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
;     0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F

3C00:00 00 00 00    202 <a class="d" name="NBUF2"       >NBUF2       </a>DS  86,0        ;NBUF2                          ;  === <b class="ts">T0$5</b> ===
3C04:00 00 00 00                                                                    ; *sigh* more wasted disk space
3C08:00 00 00 00                                                                    ; pack code THEN data
3C0C:00 00 00 00                                                                    ; as interleaving it just
3C10:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00                                ; wastes memory
3C20:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3C30:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3C40:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
3C50:00 00 00 00 00 00

<hr>; === <a class="file" name="WRITADR">WRITADR</a> - Write Address, Page <span class="page">134</span>, <b class="ts">T0$6</b> @ $56, $<b class="adr">BC56</b>-<b class="adr">B???</b> ===<hr>
                    001             SBTL '16-SECTOR WRITE ADDRESS'

3C56:38             053 WADR16      SEC             ANTICIPATE WR PROT ERR.
3C57:BD 8D C0       054             LDA <a class="d" href="#Q6H"   >Q6H</a>,X       INTO 'WR PROT SENSE' MODE.
3C5A:BD 8E C0       055             LDA <a class="d" href="#Q7L"   >Q7L</a>,X       SENSE IT (NEG=PROTECTED)
3C5D:30 5E          056             BMI <a class="x" href="#WADRTS">WADRTS</a>      ERR EXIT IF PROTECTED.

3C5F:A9 FF          057             LDA #$<span class="adr">FF</span>        SELF-SYNC NIBL.
3C61:9D 8F C0       058             STA <a class="d" href="#Q7H"   >Q7H</a>,X       WRITE FRIST NIBL.
3C64:DD 8C C0       059             CMP <a class="d" href="#Q6L"   >Q6L</a>,X       (4) BACK TO WRITE MODE.
3C67:48             060             PHA             (3) FOR DELAY
3C68:68             061             PLA             (4)



<hr>; === <a class="file" name="RWTSONE">RWTSONE</a> - Read Write Track Sector - Part 1, Page <span class="page">124</span>, <b class="ts">T0$8</b>, $<b class="adr">B???</b>-<b class="adr">BE46</b> ===<hr>
                    001             STBL '16-SECTOR RWTS'

<hr>; === <a class="file" name="RWTSTWO">RWTSTWO</a> - Read Write Track Sector - Part 2, Page <span class="page">124</span>, <b class="ts">T0$8</b>, $<b class="adr">BE47</b> ===<hr>
                    001 *
                    002 * DISK IS NOW UP TO SPEED: READ IT!
                    003 * NOW CHECK: IF IT IS NOT THE FORMAT DISK COMMAND,
                    004 * LOCATE THE CORRECT SECTOR FOR THIS OPERATION.
                    005 *
                    006 <a class="f"    name="TRYTRK"     >TRYTRK      </a>EQU *
3DAB:A0 0C          007             LDY #$0C
3DAD:B1 48          008             LDA (IOBPL),Y   ;GET COMMAND CODE #
3DAF:F0 5A          009             BEQ <a href="#GALLDONE">GALLDONE</a>    ;IF NULL COMMAND, GO HOME TO BED.           ; v
3DB1:C9 04          010             CMP #$04        ;FORMAT THE DISK?               ; *sigh* RWTS_CMD_FORMAT = 4
3DB3:F0 58          011             BEQ <a href="#FORMDSK">FORMDSK</a>     ;ALLRIGHT,ALLRIGHT, I WILL...
3DB5:6A             012             ROR A           ;SET CARRY=1 FOR READ, 0 FOR WRITE
3DB6:08             013             PHP             ;AND SAVE THAT
3DB7:B0 03          014             BCS <a href="#TRYTRK2">TRYTRK2</a>     ;MUST PRENIBBLE FOR WRITE.
                    015     LST OFF
                    016     DO <a class="macro" href="#DIAGMOD">DIAGMOD</a><span class="macro">
                    017         LDY #TC17           ;SAY 'PRENIBBLIZING'
                    018         STY TL7                                 </span>
                    019     FIN
                    020     LST ON
3DB9:20 00 38       021             JSR <a href="#PRENIB16">PRENIB16</a>
                    022     LST OFF
                    023     DO <a class="macro" href="#DIAGMOD">DIAGMOD</a><span class="macro">
                    024         LDY #SP             ;PRENIB FINISHED    
                    025         STY TL7                                 </span>
                    026     FIN
                    027     LST ON
3DBC:A0 30          028 <a class="f" name="TRYTRK2"     >TRYTRK2     </a>LDY #$30        ;ONLY 48 RETRIES OF ANY KIND.
3DBE:8C 78 05       029             STY RETRYCNT
3DC1:AE F8 05       030 <a class="f" name="TRYADR"      >TRYADR      </a>LDX SLOT        ;GET SLOT NUM INTO X-REG
                    031     LST OFF
                    032     DO <a class="macro" href="#DIAGMOD">DIAGMOD</a><span class="macro">
                    033         LDA #TC4            ;SAY 'READING ADDRESS'          
                    034         STA TL4                                             
                    035         LDA #SP             ;SAY 'NO ADDRESS ERROR' (YET)   
                    036         STA TL6                                             </span>
                    037     FIN
                    038     LST ON
3DC4:20 44 39       039             JSR <a href="#RDADR16">RDADR16</a>     ;READ NEXT ADDRESS FIELD        ; ^
                    040     LST OFF
                    041     DO <a class="macro" href="#DIAGMOD">DIAGMOD</a><span class="macro">
                    042         LDA #SP             ;ADDRESS-READ DONE              
                    043         STA TL4                                             </span>
                    044     FIN
                    045     LST ON
3DC7:90 24          046             BCC <a href="#RDRIGHT">RDRIGHT</a>     ;IF READ IT RIGHT, HURRAH!      ; v
                    047     LST OFF
                    048     DO <a class="macro" href="#DIAGMOD">DIAGMOD</a><span class="macro">
                    049         LDA #TC6            ;ADDRESS-READ DONE              
                    050         STA TL4                                             </span>
                    051     FIN
                    052     LST ON
3DC9:CE 78 05       053 <a class="f" name="TRYADR2"     >TRYADR2     </a>DEC RETRYCNT    ;ANOTHER MISTAEK!!              ; *spelling* **irony**
<hr>3DCC:10 F3          054             BPL <a class="x" href="#TRYADR">TRYADR</a>      ; WELL, LET IT GO THIS TIME..   ; === page <span class="page">123</span> ===
                    055 *
                    056 * RRRRRECALIBRATE !!!!
                    057 *
                    058 RECAL       EQU *
3DCE:AD 78 04       059             LDA CURTRK
3DD1:48             060             PHA             ;SAVE TRACK WE REALLY WANT
3DD2:A9 60          061             LDA #$60        ;RECALIBRATE ALL OVER AGAIN!    ; /sarcasm Yeah ... let's bang the user's drive head against
3DD4:20 95 3E       062             JSR <a class="x" href="#SETTRKK">SETTRKK</a>     ;PRETEND TO BE ON TRACK 96      ; the case -- that will make it work and won't
3DD7:CE F8 06       063             DEC RECALCCNT   ;ONCE TOO MANY??                ; cause any head alignment prolems over time ... NOT!
3DDC:F0 28          064             BEQ <a class="x" href="#DRVERR">DRVERR</a>      ;TRIED TO RECALIBRATE TOO MANY TIMES, ERROR! ; v
3DDE:A9 04          065             LDA #MAXSEEKS   ;RESET THE
3DDE:8D F8 04       066             STA SEEKCNT     ; SEEK COUNTER
3DE1:A9 00          067             LDA #$00
3DE3:20 5A 3E       068             JSR <a class="x" href="#MYSEEK">MYSEEK</a>      ;MOVE TO TRACK 00               ; v
3DE6:68             069             PLA
3DE7:4C 5A 3E       070 <a class="f" name="RESEEK"      >RESEEK      </a>JSR <a href="#MYSEEK">MYSEEK</a>      ;GO TO CORRECT TRACK THIS TIME!
3DEA:4C BC 3D       071             JMP <a class="x" href="#TRYTRK2">TRYTRK2</a>     ;LOOP BACK, TRY AGAIN ON THIS TRACK
                    072 *
                    073 * HAVE NOW READ
                    074 * MAKE SURE THIS IS THE TRACK, SECTOR, AND VOLUME DESIRED.
                    075 *
3DED:A4 2E          076 <a class="f" name="RDRIGHT"     >RDRIGHT     </a>LDY TRACK       ;ON THE RIGHT TRACK?
3DEF:CC 78 04       077             CPY CURTRK
3DF2:F0 1C          078             BEQ <a class="x" href="#RTTRK">RTTRK</a>       ;IF SO, GOOD                    ; v
                    079 * NO, DRIVE WAS ON A DIFFERENT TRACK. TRY
                    080 * RESEEKING/RECALIBRATING FROM THIS TRACK
3DF4:AD 78 04       081             LDA CURTRK      ;PRESERVE DESTINATION TRACK
3DF7:48             082             PHA
3DF8:98             083             TYA
3DF9:20 95 3E       084             JSR <a class="x" href="#SETTRK">SETTRK</a>
3DFC:68             085             PLA
3DFD:CE F8 04       086             DEC <a class="d" href="#SEKCNT">SEKCNT</a>      ;SHOULD WE RESEEK?
3E00:D0 E5          087             BNE <a class="x" href="#RESEEK">RESEEK</a>      ;=&gt;YES, RESEEK                  ; ^ === <b class="ts">T0$8</b> ===
3E02:F0 CA          088             BEQ <a class="x" href="#RECAL" >RECAL</a>       ;=&gt;NO, RECALIBRATE!             ; ^
                    089 ****
3E04:68             090 <a class="f" name="DRVERR"      >DRVERR      </a>PLA             ;REMOVE CURTRK
3E05:A9 40          091             LDA #IBDERR     ;BAD DRIVE ERROR
3E07:28             092 <a class="f" name="JMPTO1"      >JMPTO1      </a>PLP
3E08:4C 48 3E       093             JMP <a href="#HNDLERR">HNDLERR</a>
3E0B:F0 39          094 <a class="f" name="GALLDONE"    >GALLDONE    </a>BEQ <a class="x" href="#ALLDONE">ALLDONE</a>                                     ; v
3E0D:4C AF 3E       095 <a class="f" name="FORMDSK"     >FORMDSK     </a>JMP <a class="x" href="#DSKFORM">DSKFORM</a>     ;=&gt;GO TO IT!                    ; v
                    096 *
                    097 * DRIVE IS ON RIGHT TRACK, CHECK VOLUME MISMATCH
                    098 *
3E10:A0 03          099 <a class="f" name="RTTRK"       >RTTRK       </a>LDY #3          ;IS THE RIGHT DISK IN?
3E12:B1 48          100             LDA (IOBPL),Y   ;GET DESIRED VOLUM
3E14:48             101             PHA             ;PRESERVE DESIRED VOLUME#
3E15:A5 2F          102             LDA VOLUME      ;GET ACTUAL VOLUME HERE
3E17:A0 0E          103             LDY #$0E        ;TELL OPSYS WHAT VOLUME WAS THERE ; *sigh* magic number: IOB_OFFSET_VOL = $E
3E19:91 48          104             STA (IOBPL),Y
3E1B:68             105             PLA             ;GET DESIRED VOLUME BACK
3E1C:F0 08          106             BEQ <a class="x" href="#CORRECTVOL">CORRECTVOL</a>  ;DESIRED VOLUME 00 MATCHES ALL. ; v
3E1E:C5 2F          107             CMP VOLUME
3E20:F0 04          108             BEQ <a class="x" href="#CORRECTVOL">CORRECTVOL</a>  ;YUP, IT WAS RIGHT!             ; v
3E22:A9 20          109             LDA #IBVMME     ;HE SWITCHED DISCS!
3E24:D0 E1          110             BNE <a class="x" href="#JMPTO1">JMPTO1</a>      ;ALWAYS TAKEN                   ; ^
                    111 <a class=="f" name="CORRECTVOL" >CORRECTVOL  </a>EQU *
3E26:A0 05          112             LDY #<span class="adr">5</span>                                          ; *sigh* magic number: IOB_OFFSET_SECTOR = $5
3E28:B1 48          113             LDA (<a class="d" href="#IOBPL">IOBPL</a>),Y   ; TO ALLOW FOR INTERLEAVE
3E2A:A8             114             TAY
3E2B:B9 B8 3F       115             LDA <a class="d" href="#INTRLEAV">INTRLEAV</a>,Y  ;COMPUTE PHYSICAL SECTOR        ; DOS Sector Interleave/Skew Mapping
<hr>3E2E:C5 2D          116             CMP <a class="d" href="#SECT">SECT</a>        ;DID WE GET THE SECTOR?         ; === Page <span class="page">124</span> ===
                    117     LST OFF
                    118     DO <a class="macro" href="#DIAGMOD">DIAGMOD</a><span class="macro">
                    119         BEQ GOTSECT         ;=&gt;WE FOUND IT!                         
                    120         LDA #TC5            ;SAY 'LATENCY'                          
                    121         STA TL5                                                     
                    122         LDA SCOUNT          ;ARE WE WAITING FOR FIRST SECTOR?       
                    123         BEQ NOLAT           ;=&gt;YES, LATENCY UNPREDICTABLE ANYWAY    
                    124         INC LCOUNT          ;NO, COUNT SECTORS MISSED               
                    125 <a class="f" name="NOLAT"       >NOLAT   </a>EQU *                                                       
                    126         JMP TRYADR2         ;NOW..GET CORRECT SECTOR..              </span>
                    127     ELSE
                    128     LST ON
3E30:D0 97          129             BNE <a class="x" href="#TRYADR2">TRYADR2</a>     ;NO, KEEP TRYING.               ; ^
                    130     FIN
                    131 *
                    132 * HOORAY! WE GOT THE RIGHT SECTOR!
                    133 *
                    134 <a class="f" name="GOTSECT"     >GOTSECT     </a>EQU *
                    135     LST OFF
                    136     DO <a class="macro" href="#DIAGMOD">DIAGMOD</a><span class="macro">
                    137         LDA #SP             ;SAY 'NO LATENCY'                   
                    138         STA TL5                                                 
                    139         INC SCOUNT          ;BUMP 'SECTORS-ACCESSED' COUNT      </span>
                    140     FIN
                    141     LST ON
3E32:28             142             PLP
3E33:90 1C          143             BCC <a href="#WRIT">WRIT</a>        ;CARRY WAS SET FOR READ OPERATION. ; v
                    144     LST OFF
                    145     DO <a class="macro" href="#DIAGMOD">DIAGMOD</a><span class="macro">
                    146         LDA #TC9            ;SAY 'READING'                  
                    147         STA TL9                                             
                    148         LDA #SP                                             
                    149         STA TL10                                            </span>
                    150     FIN
                    151     LST ON
3E35:20 DC 38       152             JSR <a href="#READ16">READ16</a>      ;CLEARED FOR WRITE
                    153     LST OFF
                    154     DO <a class="macro" href="#DIAGMOD">DIAGMOD</a><span class="macro">
                    155         LDA #SP                                             
                    156         STA TL9                                             </span>
                    157     FIN
                    158     LST ON
3E38:08             159             PHP             ;SAVE STATUS OF READ OPERATION
                    160     LST OFF
                    161     DO <a class="macro" href="#DIAGMOD">DIAGMOD</a><span class="macro">
                    162         BCC <a class="x" href="#GOODREAD">GOODREAD</a>        ;NO ERROR                       
                    163         LDA #TC10           ;SAY 'READ ERROR'               
                    164         STA TL10                                            
                    165         JMP <a class="x" href="#TRYADR2">TRYADR2</a>         ;RETRY ON ERROR                 
                    166 *                                                           
                    167 <a class="name" name="GOODREAD">GOODREAD </a>EQU *                                              </span>
                    168     ELSE
                    169     LST ON
3E39:B0 8E          170             BCS <a class="x" href="#TRYADR2">TRYADR2</a>     ;CARRY SET UPON RETURN IF BAD READ ;  ^
                    171     FIN
3E3B:28             172             PLP             ;CAREFUL OF STACK
3E3C:A2 00          173             LDX #0          ;SET TO POSTNIBLIZE
3E3E:86 26          174             STX T0          ; All 256 BYTES OF THE SECTOR
                    175     LST OFF
                    176     DO <a class="macro" href="#DIAGMOD">DIAGMOD</a><span class="macro">
                    177         LDA #TC11           ;SAY 'POSTINIBBLIZING'          </span>;POST_IN_NIBBLIZING<span class="macro">
                    178         STA TL11                                            </span>
<hr>                    179     FIN                                                     ; === Page <span class="page">125</span> ===
                    180     LST ON
3E40:20 C2 38       181             JSR <a href="#POSTNB16">POSTNB16</a>    ;DECODE INTO REAL WORLD DATA
                    182     LST OFF
                    183     DO <a class="macro" href="#DIAGMOD">DIAGMOD</a><span class="macro">
                    184         LDA #SP             ;POSTNIB COMPLETED              
                    185         STA TL11                                            </span>
                    186     FIN
                    187     LST ON
3E43:AE F8 05       188             LDX SLOT        ;RESTORE SLOTNUM INTO X         ; I never would have guessed ...
3E46:18             189 <a class="x" name="ALLDONE"     >ALLDONE     </a>CLC
3E47:24             190             DFB $24         ;SKIP OVER NEXT BYTE WITH BIT OPCODE        ; BIT $zp
3E48:38             191 <a class="x" name="HNDLERR"     >HNDLERR     </a>SEC             ;INDICATE AN ERROR
3E49:A0 0D          192             LDY #$<span class="adr">0D</span>        ;GIVE HIM ERROR#                ; *sigh magic number IOB_OFFSET_ERROR = $D
3E4B:91 48          193             STA (<a class="d" href="#IOBPL">IOBPL</a>),Y
3E4D:BD 88 C0       194             LDA <a class="d" href="#MOTOROFF">MOTOROFF</a>,X  ; TURN IT OFF...
                    195     LST OFF
                    196     DO <a class="macro" href="#DIAGMOD">DIAGMOD</a><span class="macro">
                    197 * AVERAGE LATENCY = LCOUNT/SCOUNT                           
                    198         LDA LCOUNT          ; GET TOTAL LATENCY             
                    199         LDY #0              ; CLEAR QUOTIENT                
                    200 <a class="name" name="DIVIDE" id="DIVIDE" >DIVIDE  </a>EQU *                                               
                    201         CMP SCOUNT          ; DONE?                         
                    202         BCC <a class="x" href="#PRTLAT"   >PRTLAT</a>          ; =&gt;YES.PRINT IT                
                    203         SBC SCOUNT          ; REMOVE SCOUNT                 
                    204         INY                 ; INCREMENT QUOTIENT            
                    205         BNE <a class="x" href="#DIVIDE">DIVIDE</a>                                          
                    206 *                                                           
                    207 <a class="name" name="PRTLAT" id="PRTLAD">PRTLAT  </a>TYA                                                 </span>; Print Latency<span style="background-color:#EEE">
                    208         AND #$0F            ; MAX LATENCY=15                
                    209         ORA #$B0            ; MAKE ASCII                    </span>; No, this is make Apple Text, as ASCII = $00..$7F<span style="background-color:#EEE">
                    210         CMP #$BA            ; IS IT A-F                     
                    211         BCC <a class="x" href="#PRTL2" >PRTL2</a>           ;=&gt;NO                           
                    212         ADC #6              ;ADD 7 (INCLUDES CARRY)         
                    213 <a class="name" name="PRTL2" id="PRTL2">PRTL2   </a>STA TL12            ; STUFF LATENCY COUNT           
                    214         LDA #SP             ; SAY 'RWTS NOT ACTIVE'         
                    215         STA TL1                                             </span>
                    216     FIN
                    217     LST ON
3E50:60             218             RTS
                    219 <a class="f" name="WRIT"        >WRIT        </a>EQU *
                    220     LST OFF
                    221     DO <a class="macro" href="#DIAGMOD">DIAGMOD</a><span style="macro">
                    222        LDA #TC8             ; SAY 'WRITING'                 
                    223        STA TL8                                              </span>
                    224     FIN
                    225     LST ON
3E51:20 2A 38       226             JSR <a class="x" href="#WRITE16">WRITE16</a>     ; WRITE NYBBLES NOW             ; ^ WRITRTN, page 137

                    227     LST OFF
                    228     DO <a class="macro" href="#DIAGMOD">DIAGMOD</a><span class="macro">
                    229        LDA #SP              ; SAY 'WRITING'                 
                    230        STA TL8                                              </span>
                    231     FIN
                    232     LST ON
3E54:90 F0          233             BCC <a class="x" href="#ALLDONE">ALLDONE</a>     ;IF NO ERRORS.
3E56:A9 10          234             LDA #IBWPER     ;DISK IS WRITE PROTECTED!!
3E58:B0 EE          235             BCS <a class="x" href="#HNDLERR">HNDLERR</a>     ;ALWAYS TAKEN
                    236 *
                    237 * THIS IS THE 'SEEK' ROUTINE
                    238 *  SEEKS TRACK 'N' IN SLOT #X/$10
                    239 * IF DRIVNO IS NEGATIVE, ON DRIVE 1
                    240 * IF DRIVNO IS POSITIVE, ON DRIVE 2
                    241 *
<hr>3E5A:48             242 <a class="x" name="MYSEEK"      >MYSEEK      </a>PHA             ; AND PRESERVE A-REGISTER       ; === Page <span class="page">126</span> === Uhm, OK, Captain Obvious
                    243     LST OFF

                    2??     LST ON


3E86:10 03          275             BPL <a class="x" href="#GOSEEK">GOSEEK</a>      ;ALWAYS TAKEN
3E88:99 78 04       276 <a class="f" name="ISDRV1"      >ISDRV1      </a>STA DRV1TRK,Y
3E8B:4C A0 B9       277 <a class="f" name="GOSEEK"      >GOSEEK      </a>JMP <a class="x" href="#SEEK">SEEK</a>        ;GO THERE!
3E8E:8A             278 <a class="g" name="XTOY"        >XTOY        </a>TXA
3E8F:4A             279             LSR A
3E90:4A             280             LSR A
3E91:4A             281             LSR A
3E92:4A             282             LSR A
3E93:A8             283             TAY
3E94:60             284             RTS
                    285 *
                    286 * THIS SUBROUTINE SETS THE SLOT DEPENDENT TRACK
                    287 * LOCATION.
                    288 *
3E95:48             289 <a class="f" name="SETTRK"     id="SETTRK"     >SETTRK      </a>PHA             ;PRESERVE DESTINATION TRACK
3E96:A0 02          290             LDY #$02                                        ; *sigh* magic number: IOB_OFFSET_DRIVE = $2
3E98:B1 48          291             LDA (IOBPL),Y
3E9A:6A             292             ROR A           ;GET DRIVE # INTO CARRY
3E9B:66 35          293             ROR DRIVNO      ;INTO (DRIVNO)
3E9D:20 8E 3E       294             JSR <a href="#XTOY">XTOY</a>        ;SET UP Y-REG
3EA0:68             295             PLA
3EA1:0A             296             ASL A           ;ASSUME TRACK IS HELD*2
3EA2:24 35          297 SETTRK2     BIT DRIVNO                                      ; unused label
3EA4:30 05          298             BMI <a href="#ONDRV1">ONDRV1</a>      ;IF ON DRIVE 1(1), DRIVNO MINUS
3EA6:99 F8 04       299             STA DRV2TRK,Y
3EA9:10 03          300             BPL <a href="#SETRTS">SETRTS</a>
3EAB:99 78 04       301 <a class="f" name="ONDRV1"     id="ONDRV1"    >ONDRV1      </a>STA DRV1TRK,Y
3EAE:60             302 <a class="f" name="SETRTS"     id="SETRTS"    >SETRTS      </a>RTS


<hr>; === <a class="file" name="FORMATR">FORMATR</a> - Format Disk, Page <span class="page">82</span>, <b class="ts">T0$8</b> @ $AF..  <b class="ts">T0$9</b> @ $C7, $<span class="adr">BEAF</span>-<span class="adr">BFC7</span> ===<hr>
                    001                SBTL '16-SECTOR FORMATTER'
                    002 ****************************
                    003 *                          *
                    004 * FORMAT DISK AND RETURN   *
                    005 *                          *
                    006 ****************************
                    007 *
                    008 * EQUATES FOR FORMATTER
                    009 *
                    010 <a class="d" name="NSYNC"      >NSYNC       </a>EQU $45         ;NUM GAP SELF-SYNC NIBLS        ; No, not the 90's band
                    011 *
                    012             REP 40
                    013 <a name="DSKFORM"    >DSKFORM     </a>EQU *
                    014     DO <a class="macro" href="#DIAGMOD">DIAGMOD</a>              ;ELIMINATE FMTR FROM DIAG ASSEMBLY<span class="macro">
                    015         LST OFF                                             </span>
                    016     ELSE
3EAF:A0 03          017             LDY #3                                          ; *sigh* magic number: IOB_OFFSET_VOL = $3
3EB1:B1 48          018             STY (IOBPL),Y   VOLUME NUMBER IN IOB.
3EB3:85 41          019             STA NVOL        FOR FORMATTER.
3EB5:A9 AA          020             LDA #$AA        SET Z-PAG LOC TO $AA FOR
3EB7:85 3E          021             STA AA          TIME DEPENDENT REFERENCES.
3EB9:A0 56          022             LDY #$56
3EBB:A9 00          023             LDA #0
3EBD:85 44          024             STA TRK         TRACK NUMBER, 0 TO 34
3EBF:99 FF BB       025             STA NBUF2-1,Y   CLEAR NBUFS TO WRITE
3EC2:88             026             

3EFD:C9 23          054             CMP #$23        CONTINUE IF LESS THEN 35        ; *sigh* DISK_MAX_TRACK
3EFF:90 D3          055             BCC <a class="x" href="#FORMTRK">FORMTRK</a>
3F01:18             056             CLC             CLEAR CARRY TO INDICATE 'NO ERR'; === <b class="ts">T0$9</b> ===
3F02:90 05          057             BCC <a class="x" href="#FORMDONE">FORMDONE</a>    ELSE TURN OFF MOTOR AND RETURN
3F04:A0 0D          058 <a name="FORMERR"    >FORMERR     </a>LDY #$0D                                        ; *sigh* magic number: IOB_OFFSET_ERR = $D
3F06:91 48          059             STA (IOBPL),Y   RETURN ERROR CODE.
3F08:38             060             SEC             SET CARRY TO INDICATE ERR.
3F09:AD 88 C0       061 <a name="FORMDONE"   >FORMDONE    </a>LDA <a class="d" href="#MOTOROFF">MOTOROFF</a>,X  ; TURN MOTOR OFF.
3F0C:60             062             RTS             ; AND RETURN.
                    063             PAGE
                    064 ******************************
                    065 *                            *
                    066 *   WRITE TRACK SUBROUTINE   *
                    067 *                            *
                    068 ******************************
3F0D:A9 00          068 <a name="WTRACK16"   >WTRACK16    </a>LDA #0
3F0F:85 3F          069             STA NSECT       SECTOR NUMBER, 0 to 15.
3F11:A0 80          070             LDY #128        ;128 NIBS PRIOR SECTOR 0
3F13:D0 02          071             BNE WSECT0      ; TO INSURE NO BLANK SPOT BETW 15 &amp; 0
3F15:A4 45          072 <a name="WSECT"      >WSECT       </a>LDY NSYNC       CURRENT NUM OF GAP SELF-SYNC NIBLS.

*****************************
*                           *
* VERIFY ROUTINE *
*                           *
* VERIFIES THAT THE FIRST *
* SECTOR ENCOUNTERED IS *
* SECTOR 0, AND THAT ALL *
* 16 SECTORS ARE READABLE *
* WITH MINIMAL RETRIES. *
* (2 REVOLUTIONS MAXIMUM) *
*                           *
* IF FIRST SECTOR IS NOT *
* SECTOR 0 THEN THE *
* CURRENT NUMBER OF SELF- *
* SYNC NIBLS IS DECR'D BY *
* 1 (IF ALREADY LESS THAN *
* 16)ORBY2.THENSECTOR*
* 15ISLOCATEDSOASTO *
* POSITION THE NEW TRACK *
* REWRITE. *
*                           *
* IF UNABLE TO READ ANY *
* SECTOR THEN THE ENTIRE *
* TRACK IS REWRITTEN. *
*                           *
* AFTER VERIFYING TRACK 0, *
* THE NUMBER OF SELF-SYNC *
* NIBLS, NSYNC, IS DECR'D *
* BY2(IFSTILL16OR *
* GREATER). *
*                           *
*****************************

                    181
                    182         DFB 0,0,0,0
                    183         DFB 0,0,0,0
                    184         DFB 0,0,0,0
                    185         DFB 0,0,0,0
                    186     FIN                                                     ; Macro started waaay back on line #<span class="line">14</span>, <a class="x" href="#DSKFORM">DSKFORM</a>
                    187     LST ON
                    188             REP 40
                    189 * THIS TABLE IS USED TO TRANSLATE
                    190 * LOGICAL (REQUESTED) SECTOR NUMBER
                    191 * TO PHYSICAL SECTOR NUMBER. THE
                    192 * DISKETTE IS FORMATTED WITH ALL
                    193 * SECTORS IN MONOTONICALLY INCREASING
                    194 * ORDER. THE TRANSLATION WILL ALLOW
                    195 * TIME BETWEEN SECTORS FOR READS.
                    196 *
                    197             REP 40
                    198 *
                    199 * NOTE: THE CURRENT IMPLEMENTATION OF DOS
                    200 *  USUALLY ACCESSES SECTORS IN DECREASING
                    201 *  ORDER ON A TRACK. THUS WE WILL
                    202 *  TRANSLATE IN REVERSE ORDER...
                    203 *
                    204 * THE INTERLEAVE IS THEN 9:1                                ; <span class="todo">TODO</span>: Verify this is optimal for reading
                    205 *                                                           ; sectors in normal F,E,D,..,2,1,0 access pattern order
                    206 * NOTE: WE MAP LOGICAL SECTOR 0
                    207 *  INTO PHYSICAL SECTOR 0 SO THAT
                    208 *  WRITING OF BOOT DURING 'INIT'
                    209 *  IS CORRECT FOR SECTOR ZERO.
                    210 *
                    211 <a class="d" name="INRLEAV"    >INTRLEAV    </a>EQU *                                           ; *sigh*
3FB8:00 0D 0B 09    212             DFB $00,$0D,$0B,$09                             ; /sarcasm Here's a novel concept ...
3FBC:07 05 03 01    213             DFB $07,$05,$03,$01                             ; How about *formatting* the sectors in the correct
3FC0:0E 0C 0A 08    214             DFB $0E,$0C,$0A,$08                             ; order on the disk in the first place so we don't even
3FC4:06 04 02 0F    215             DFB $06,$04,$02,$0F                             ; need to waste memory with this table at all !


<hr>; === <a class="file" name="DOSPTCH">DOSPTCH</a> - Revision B Patches, Page <span class="page">52</span>, <b class="ts">T0$9</b> @ $C8, $<span class="adr">BFC8</span> .. $<span class="adr">BFFF</span> ===<hr>
                    001             SBTL "DOS PATCHES"
                    002 ********************************
                    003 *
                    004 * DOS 3.2 PATCHES BY DICK HUSTON
                    005 *
                    006 ********************************
                    007 * AFTER THE FACT PATCHES
                    008 * CLRBYTE CALLED FROM DOS2 LABEL SOPTS +7 LINES
                    009 * CLRSTS1 CALLED FROM DOS3 LABEL ERROR +2 LINES
                    010 * ERROR9X CALLED FROM DOS5 LABEL ERROR9*
                    011 *
                    012 *
                    013             REP 40
                    014 *
                    015 * DOS 3.3 REVISION B PATCH
                    016 *
                    017             REP 40
                    018 *****************************
                    019 <a name="SDP1"       >SDP1        </a>EQU *                                           ; Start Dos Patch
                    020 <a name="RCPATCH"    >RCPATCH     </a>EQU *                                           ; <span class="todo">TODO</span> called from?
3FC8:20 93 FE       021             JSR <a class="x" href="#SETVID">SETVID</a>
3FCB:AD 81 C0       022             LDA $<span class="adr">C081</span>                                       ; ROMIN = $C081 for Language Card (LC)
3FCE:AD 81 C0       023             LDA $<span class="adr">C081</span>                                       ; 1st read = read ROM, 2nd read = write enable LC Bank 2
3FD1:A9 00          024             LDA #<span class="adr">0</span>
3FD3:8D 00 E0       025             STA $<span class="adr">E000</span>                                       ; *sigh* Forces Language Card to reload
                    026     DO <a class="macro" href="#DOS33B">DOS33B</a>
3FD6:20 76 3A       027             JSR <a class="x" href="#OFF80" >OFF80</a>                                       
3FD9:4C 44 37       028             JMP <a class="x" href="#RCBACK">RCBACK</a>                                      </span>
                    029     ELSE<span class="macro">
                    030         JMP RCBACK                                          
                    031         DS  3,0                                             </span>
                    032     FIN
                    033 *****************************
3FDC:8D 63 2A       034 <a name="CLRBYTE"    >CLRBYTE     </a>STA <a class="d" href="#TEMP1A">TEMP1A</a>                                      ; <span class="todo">TODO</span> called from <a href="#SOPTS">SOPTS</a>, Page 18, Line <span class="line">?</span>
3FDF:8D 70 2A       035             STA <a class="d" href="#CB">CB</a>          ;SET TYPE PARAM DEFAUTL=0       ; *spelling* DEFAULT
3FE2:8D 71 2A       036             STA <a class="d" href="#CB">CB</a>+1
3FE5:60             037             RTS
                    038             SKP 4
3FE6:20 5B 27       039 <a name="CLRSTS1"    >CLRSTS1     </a>JSR <a class="x" href="#CLRSTS">CLRSTS</a>                                      ; <span class="todo">TODO</span> Clear ???
3FE9:8C B7 2A       040             STY <a class="d" href="#RSTATE">RSTATE</a>      ;PREVENTS FOREVER 'FILE NOT FOUND'
3FEC:60             041             RTS             ; IN APPLESOFT
                    042 *****************************
3FED:20 7E 2E       043 <a name="ERROR9X"    >ERROR9X     </a>JSR <a class="x" href="#RTNFCB">RTNFCB</a>
3FF0:AE 9B 33       044             LDX <a class="d" href="#ENTSTK">ENTSTK</a>      ;GET STACK
3FF3:9A             045             TXS             ;MESSY MESSY MESSY
3FF4:20 16 23       046             JSR <a class="x" href="#CLALL">CLALL</a>       ;GO CLOSE EVERYBODY
3FF7:BA             047             TSX
3FF8:8E 9B 33       048             STX <a class="d" href="#ENTSTK">ENTSTK</a>      ;RESTORE SAVE STK
3FFB:A9 09          049             LDA #9                                          ; magic number: <span class="todo">TODO</span> What error??
3FFD:4C 85 33       050             JMP <a class="x" href="#ERRORA">ERRORA</a>      ;AND BACK
                    051 *****************************
                    052 <a class="d" name="ENDP1"      >ENDP1       </a>EQU *-1         ; END OF DOS PATCHES FOR RELOCTR
                    053 <a class="d" name="ENDOFDOS"   >ENDOFDOS    </a>EQU *
<hr>                    054     DO <a class="d" href="#ENDOFDOS">ENDOFDOS</a>-$4000                                       ; === Page <span class="page">53</span> ===<span class="macro">
                    055         FAIL 2,'DOS LENGTH NOT CORRECT'                     </span>
                    056     FIN
<hr><hr>
</pre>


<h1>Stats.</h1>
<p>
Spelling mistakes: 5
<p>
Total Functions: 67
<p>
Total Variables: ?
<p>

<h1>Symbols (Alphabetical)</h1>
<pre>
<h2>A</h2>
    ASHM1       =   $73
    ASHM2       =   $6F

<h2>B</h2>

<h2>C</h2>
    COUT        =   $26

<h2>D</h2>
    DBVECT      = $1E51
    DELTA       = $1C7F

<h2>E</h2>
    EC1         = $2884
    EC2         = $3397
    EC3         = $37E0
    ERRORA      = $3F85
    EWADR1      = $3CDF
    EAT1        = $1D56

<h2>F</h2>

<h2>G</h2>

<h2>H</h2>

<h2>I</h2>
    IBVT        = $1D62

<h2>J</h2>

<h2>K</h2>

<h2>L</h2>

<h2>M</h2>

<h2>N</h2>
    NEPAGE      = $1C7D

<h2>O</h2>

<h2>P</h2>
    PRENIB16    = $B800

<h2>Q</h2>

<h2>R</h2>
    RUN         = $1D58
    RSPAGE      = $1C7A

<h2>S</h2>
    SAT1        = $1D00
    SC1         = $1D84
    SC2         = $2AFD
    SC3         = $365D
    SWADR1      = $3C56

<h2>T</h2>

<h2>U</h2>

<h2>W</h2>

<h2>X</h2>

<h2>Y</h2>

<h2>Z</h2>
    ZPGFCB      =   $42
    ZPGWRK      =   $40


</pre>

<h1>Symbols (Address)</h1>

<pre>
</pre>

Apple ][ Forever!

</body>
</html>

<!--

Well aren't you a curious hacker!

Here's a trick to boot from Drive 2 :-)
NOTE: You'll need a DOS that isn't brain dead.

; Apple //e
9600<C600.C700M
9636:8B
9600G

; Apple //c
9600<C600.C700M
96xx:
9600G

-->
